{% extends 'base.html' %}
{% block title %}Search Homestays - Horin{% endblock %}

{% block navbar_search %}
<!-- Compact Search Bar -->
<div class="navbar-search-container">
    <!-- Compact Search Display -->
    <div class="navbar-search-compact" id="compact-search" onclick="expandSearch()">
        <div class="search-content">
            <div class="search-tabs-inline">
                <span class="tab-inline {% if search_params.booking_type == 'hourly' or not search_params.booking_type %}active{% endif %}">
                    <i class="fas fa-clock"></i> Theo giờ
                </span>
                <span class="tab-inline {% if search_params.booking_type == 'daily' %}active{% endif %}">
                    <i class="fas fa-calendar-day"></i> Theo ngày
                </span>
            </div>
            
            <div class="search-info">
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ search_params.location or 'Hồ Chí Minh' }}</span>
                </div>
                <div class="info-divider">•</div>
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span>
                        {% if search_params.checkin_date %}
                            {% set date_parts = search_params.checkin_date.split('-') %}
                            {{ date_parts[2] }} tháng {{ date_parts[1] }}, {{ date_parts[0] }}
                        {% else %}
                            16 tháng 7, 2025
                        {% endif %}
                    </span>
                </div>
                <div class="info-divider">•</div>
                {% if search_params.booking_type == 'hourly' or not search_params.booking_type %}
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span>
                        {% set checkin_time = search_params.checkin_time or '14:00' %}
                        {% set duration = search_params.hours_duration or search_params.duration or '3' %}
                        {% set checkin_hour = checkin_time.split(':')[0] | int %}
                        {% set checkout_hour = checkin_hour + (duration | int) %}
                        {% if checkout_hour > 24 %}
                            {% set checkout_hour = checkout_hour - 24 %}
                        {% endif %}
                        {{ checkin_time }} - {{ '%02d:00'|format(checkout_hour) }}
                    </span>
                </div>
                <div class="info-divider">•</div>
                <div class="info-item">
                    <i class="fas fa-hourglass-half"></i>
                    <span>
                        {% if search_params.hours_duration %}
                            {{ search_params.hours_duration }} giờ
                        {% elif search_params.duration %}
                            {{ search_params.duration }} giờ
                        {% else %}
                            3 giờ
                        {% endif %}
                    </span>
                </div>
                {% else %}
                <div class="info-item">
                    <i class="fas fa-calendar-check"></i>
                    <span>
                        {% if search_params.checkout_date %}
                            {% set checkout_parts = search_params.checkout_date.split('-') %}
                            {{ checkout_parts[2] }} tháng {{ checkout_parts[1] }}, {{ checkout_parts[0] }}
                        {% else %}
                            26 tháng 7, 2025
                        {% endif %}
                    </span>
                </div>
                {% endif %}
                <div class="info-divider">•</div>
                <div class="info-item">
                    <i class="fas fa-users"></i>
                    <span>{{ search_params.adults or 1 }} người lớn</span>
                </div>
            </div>
        </div>
        
        <button class="search-btn-compact">
            <i class="fas fa-search"></i>
        </button>
    </div>
    
    <!-- Expanded Search Form -->
    <div class="navbar-search-expanded" id="expanded-search" style="display: none;">
        <div class="search-header">
            <div class="navbar-search-tabs">
                <button type="button" class="search-tab {% if search_params.booking_type == 'hourly' or not search_params.booking_type %}active{% endif %}" onclick="switchSearchTab('hourly')">
                    <i class="fas fa-clock"></i> Theo giờ
                </button>
                <button type="button" class="search-tab {% if search_params.booking_type == 'daily' %}active{% endif %}" onclick="switchSearchTab('daily')">
                    <i class="fas fa-calendar-day"></i> Theo ngày
                </button>
            </div>
            <button type="button" class="close-btn" onclick="collapseSearch()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Hourly Search Form -->
        <form id="hourly-search-form" class="search-form-content {% if search_params.booking_type == 'hourly' or not search_params.booking_type %}active{% endif %}" action="{{ url_for('renter.search') }}" method="GET" style="{% if search_params.booking_type == 'daily' %}display: none;{% endif %}">
            <input type="hidden" name="booking_type" value="hourly">
            <div class="row g-2">
                <div class="col-md-2">
                    <label for="location-hourly" class="form-label">Địa điểm</label>
                    <input type="text" class="form-control" id="location-hourly" name="location" value="{{ search_params.location or '' }}" placeholder="Nhập địa điểm">
                </div>
                <div class="col-md-2">
                    <label for="checkin-date-hourly" class="form-label">Ngày</label>
                    <input type="date" class="form-control" id="checkin-date-hourly" name="checkin_date" value="{{ search_params.checkin_date or '' }}">
                </div>
                <div class="col-md-2">
                    <label for="checkin-time-hourly" class="form-label">Giờ nhận</label>
                    <select class="form-control" id="checkin-time-hourly" name="checkin_time">
                        {% for hour in range(1, 25) %}
                            {% set time_str = '%02d:00'|format(hour if hour <= 24 else hour-24) %}
                            <option value="{{ time_str }}" {% if search_params.checkin_time == time_str %}selected{% endif %}>
                                {{ time_str }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="duration-hourly" class="form-label">Thời gian thuê</label>
                    <select class="form-control" id="duration-hourly" name="hours_duration">
                        <option value="">Chọn thời gian</option>
                        {% for i in range(1, 13) %}
                            <option value="{{ i }}" {% if search_params.hours_duration == i|string or search_params.duration == i|string %}selected{% endif %}>{{ i }} giờ</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="guests-hourly" class="form-label">Khách</label>
                    <input type="text" class="form-control" id="guests-hourly" placeholder="1 người lớn" readonly>
                    <input type="hidden" name="adults" value="{{ search_params.adults or '1' }}">
                    <input type="hidden" name="children" value="{{ search_params.children or '0' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn search-btn w-100">Tìm kiếm</button>
                </div>
            </div>
        </form>
        
        <!-- Daily Search Form -->
        <form id="daily-search-form" class="search-form-content {% if search_params.booking_type == 'daily' %}active{% endif %}" action="{{ url_for('renter.search') }}" method="GET" style="{% if search_params.booking_type != 'daily' %}display: none;{% endif %}">
            <input type="hidden" name="booking_type" value="daily">
            <div class="row g-2">
                <div class="col-md-3">
                    <label for="location-daily" class="form-label">Địa điểm</label>
                    <input type="text" class="form-control" id="location-daily" name="location" value="{{ search_params.location or '' }}" placeholder="Nhập địa điểm">
                </div>
                <div class="col-md-2">
                    <label for="checkin-daily" class="form-label">Nhận phòng</label>
                    <input type="date" class="form-control" id="checkin-daily" name="checkin_date" value="{{ search_params.checkin_date or '' }}">
                </div>
                <div class="col-md-2">
                    <label for="checkout-daily" class="form-label">Trả phòng</label>
                    <input type="date" class="form-control" id="checkout-daily" name="checkout_date" value="{{ search_params.checkout_date or '' }}">
                </div>
                <div class="col-md-2">
                    <label for="guests-daily" class="form-label">Khách</label>
                    <input type="text" class="form-control" id="guests-daily" placeholder="1 người lớn" readonly>
                    <input type="hidden" name="adults" value="{{ search_params.adults or '1' }}">
                    <input type="hidden" name="children" value="{{ search_params.children or '0' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn search-btn w-100">Tìm kiếm</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block head_scripts %}
<!-- noUiSlider for range sliders -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
{% endblock %}

{% block extra_css %}
<style>
    /* Hide global search container on search page */
    .global-search-container {
        display: none !important;
    }
    
    /* Custom 5-column layout for homestay cards */
    .col-5cols {
        flex: 0 0 auto;
        width: 20%; /* 20% width for 5 columns (100% / 5 = 20%) */
    }

    /* Responsive behavior for 5-column layout */
    @media (min-width: 1200px) {
        .col-xl-5cols {
            flex: 0 0 auto;
            width: 20%; /* 5 cards per row on extra large screens */
        }
    }

    @media (min-width: 992px) and (max-width: 1199.98px) {
        .col-lg-5cols {
            flex: 0 0 auto;
            width: 20%; /* 5 cards per row on large screens */
        }
    }

    /* Fallback for smaller screens - keep existing responsive behavior */
    @media (max-width: 991.98px) {
        .col-lg-5cols,
        .col-xl-5cols {
            flex: 0 0 auto;
            width: 50%; /* 2 cards per row on medium screens (same as col-md-6) */
        }
    }

    @media (max-width: 767.98px) {
        .col-lg-5cols,
        .col-xl-5cols {
            flex: 0 0 auto;
            width: 100%; /* 1 card per row on small screens */
        }
    }
    
    /* Homestay Card Styles - matching homepage exactly */
    .homestay-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        background: white;
        min-height: 300px; /* Ensure consistent height for 5-column layout */
    }

    .homestay-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .homestay-card .card-img-container {
        position: relative;
        overflow: hidden;
        height: 160px; /* Reduced height for 5-column layout */
    }

    .homestay-card .card-img-container img {
        transition: transform 0.3s ease;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .homestay-card:hover .card-img-container img {
        transform: scale(1.05);
    }

    .homestay-card .card-body {
        padding: 0.875rem; /* Reduced padding for 5-column layout */
    }

    .homestay-card .card-title {
        font-size: 0.9rem; /* Reduced for 5-column layout */
        color: #333;
        font-weight: 600;
        flex: 1;
        margin-right: 0.5rem;
        line-height: 1.2; /* Tighter line height */
        margin-bottom: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .homestay-card .location-info {
        font-size: 0.8rem; /* Smaller for 5-column layout */
        display: flex;
        align-items: center;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .homestay-card .location-info i {
        color: #9ed649;
        font-size: 0.8rem;
    }

    .homestay-card .price-info {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .homestay-card .btn-outline-primary {
        border-color: #9ed649;
        color: #9ed649;
        border-radius: 6px;
        font-size: 0.8rem; /* Smaller for 5-column layout */
        padding: 0.35rem 0.7rem; /* Reduced padding */
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }

    .homestay-card .btn-outline-primary:hover {
        background-color: #9ed649;
        border-color: #9ed649;
        color: white;
    }

    /* Animation */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .homestay-card:nth-child(1) { animation-delay: 0.1s; }
    .homestay-card:nth-child(2) { animation-delay: 0.2s; }
    .homestay-card:nth-child(3) { animation-delay: 0.3s; }
    .homestay-card:nth-child(4) { animation-delay: 0.4s; }
    .homestay-card:nth-child(5) { animation-delay: 0.5s; }
    
    /* Section Header Styles - matching homepage */
    .section-header {
        margin-bottom: 2rem;
    }
    
    .section-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        line-height: 1.2;
    }
    
    .section-subtitle {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 0;
    }
    
    @media (max-width: 768px) {
        .section-title {
            font-size: 1.5rem;
        }
        
        .section-subtitle {
            font-size: 0.9rem;
        }
    }
    
    /* Navbar search container */
    .navbar-search-container {
        display: flex;
        justify-content: center;
        align-items: center;
        max-width: 600px;
        width: auto;
    }
    
    /* Compact search bar styling */
    .navbar-search-compact {
        background: white;
        border-radius: 25px;
        padding: 8px 16px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        max-width: 550px;
        min-width: 500px;
        height: 48px;
    }
    
    .navbar-search-compact:hover {
        box-shadow: 0 4px 25px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .search-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }
    
    .search-tabs-inline {
        display: flex;
        gap: 12px;
        margin-bottom: 2px;
    }
    
    .tab-inline {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 10px;
        font-weight: 600;
        color: #999;
        transition: all 0.3s ease;
    }
    
    .tab-inline.active {
        color: #8bc34a;
    }
    
    .search-info {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-wrap: nowrap;
        overflow: hidden;
        width: 100%;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 12px;
        color: #333;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .info-item i {
        color: #8bc34a;
        font-size: 11px;
        flex-shrink: 0;
    }
    
    .info-divider {
        color: #ddd;
        font-size: 11px;
        margin: 0 1px;
        flex-shrink: 0;
    }
    
    .search-btn-compact {
        background: #8bc34a;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s ease;
    }
    
    .search-btn-compact:hover {
        background: #689f38;
        transform: scale(1.05);
    }
    
    /* Expanded search form styling */
    .navbar-search-expanded {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        border: 1px solid #dee2e6;
        z-index: 1000;
        margin-top: 10px;
        min-width: 700px;
    }
    
    .search-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .close-btn {
        background: #f8f9fa;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .close-btn:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    .navbar-search-tabs {
        display: flex;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .navbar-search-expanded .search-tab {
        flex: 1;
        background: transparent;
        border: none;
        padding: 10px 15px;
        font-weight: 500;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        justify-content: center;
    }
    
    .navbar-search-expanded .search-tab:hover {
        background: rgba(139, 195, 74, 0.1);
        color: #8bc34a;
    }
    
    .navbar-search-expanded .search-tab.active {
        background: #8bc34a;
        color: white;
        font-weight: 600;
    }
    
    .navbar-search-expanded .form-control {
        height: 40px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0 12px;
        font-size: 13px;
        transition: all 0.3s ease;
    }
    
    .navbar-search-expanded .form-control:focus {
        border-color: #8bc34a;
        box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.1);
    }
    
    .navbar-search-expanded .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 6px;
        font-size: 12px;
    }
    
    .navbar-search-expanded .search-btn {
        background: linear-gradient(135deg, #8bc34a, #689f38);
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        color: white;
        height: 40px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(139, 195, 74, 0.3);
        font-size: 13px;
    }
    
    .navbar-search-expanded .search-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(139, 195, 74, 0.4);
        background: linear-gradient(135deg, #689f38, #558b2f);
    }
    
    .navbar-search-expanded .row {
        align-items: end;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .navbar-search-compact {
            min-width: 500px;
            height: 45px;
            padding: 8px 15px;
            gap: 12px;
        }
        
        .tab-inline {
            font-size: 10px;
        }
        
        .info-item {
            font-size: 12px;
        }
        
        .search-btn-compact {
            width: 30px;
            height: 30px;
        }
        
        .navbar-search-expanded {
            min-width: 600px;
            padding: 15px;
        }
        
        .navbar-search-expanded .form-control {
            height: 35px;
            font-size: 12px;
        }
        
        .navbar-search-expanded .search-btn {
            height: 35px;
            font-size: 12px;
        }
        
        .navbar-search-expanded .form-label {
            font-size: 11px;
        }
    }
    
    @media (max-width: 576px) {
        .navbar-search-compact {
            min-width: 400px;
            height: 40px;
            padding: 6px 12px;
            gap: 10px;
        }
        
        .tab-inline {
            font-size: 9px;
        }
        
        .info-item {
            font-size: 11px;
        }
        
        .search-btn-compact {
            width: 25px;
            height: 25px;
        }
        
        .navbar-search-expanded {
            min-width: 500px;
            padding: 12px;
        }
        
        .navbar-search-expanded .form-control {
            height: 32px;
            font-size: 11px;
        }
        
        .navbar-search-expanded .search-btn {
            height: 32px;
            font-size: 11px;
        }
        
        .navbar-search-expanded .form-label {
            font-size: 10px;
        }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .search-navbar {
            padding: 10px 0;
        }
        
        .search-navbar .search-form {
            padding: 15px;
        }
        
        .search-navbar .search-tab {
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .search-navbar .form-control {
            height: 40px;
            font-size: 13px;
        }
        
        .search-navbar .search-btn {
            height: 40px;
            font-size: 13px;
            padding: 8px 16px;
        }
        
        .search-navbar .form-label {
            font-size: 12px;
        }
        
        .search-navbar .row {
            flex-direction: column;
            gap: 15px;
        }
        
        .search-navbar .row > div {
            width: 100% !important;
        }
    }
    
    @media (max-width: 576px) {
        .search-navbar .search-form {
            padding: 10px;
        }
        
        .search-navbar .search-tabs {
            margin-bottom: 15px;
        }
        
        .search-navbar .search-tab {
            padding: 8px 12px;
            font-size: 13px;
        }
    }
    
    .filter-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }
    
    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        cursor: pointer;
    }
    
    .amenity-checkbox, .rule-checkbox {
        margin-bottom: 12px;
    }
    
    .filter-content {
        margin-bottom: 15px;
    }
    
    .price-inputs {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }
    
    .price-inputs div {
        flex: 1;
    }
    
    .price-inputs .form-control {
        height: 45px;
        font-size: 16px;
    }
    
    .filter-box {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .filter-button {
        padding: 8px 15px;
        background-color: #f8f9fa;
        border-radius: 20px;
        border: 1px solid #dee2e6;
        display: inline-flex;
        align-items: center;
        margin-right: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-button:hover {
        background-color: #e9ecef;
    }
    
    .filter-button i {
        margin-right: 5px;
    }
    
    #filter-offcanvas {
        width: 500px; /* Larger width for modal */
        margin: auto;
        left: 0;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        height: auto;
        max-height: 90vh;
        border-radius: 12px;
        position: fixed;
    }
    
    .amenities-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .range-slider {
        width: 100%;
        margin: 15px 0;
    }
    
    .price-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }
    
    .price-display {
        font-weight: 600;
        color: #0d6efd;
    }
    
    .amenity-group {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
    }
    
    .amenity-group h6 {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .offcanvas-backdrop {
        background-color: rgba(0, 0, 0, 0.6);
    }
    
    .offcanvas-body {
        padding: 20px 25px;
    }
    
    .offcanvas {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>
            {% if search_params.booking_type == 'daily' %}
                Nhà cho thuê theo ngày
            {% else %}
                Nhà cho thuê theo giờ
            {% endif %}
            {% if homes %}({{ homes|length }} kết quả){% endif %}
        </h4>
        
        <!-- Filter Button -->
        <button class="btn btn-outline-secondary btn-lg" type="button" id="filter-button" data-bs-toggle="offcanvas" data-bs-target="#filter-offcanvas">
            <i class="bi bi-sliders me-2"></i> Bộ lọc
        </button>
    </div>
    
    <!-- Filter Tags -->
    <div class="mb-3">
        {% if search_params.location %}
        <div class="filter-button">
            <i class="bi bi-geo-alt"></i> {{ search_params.location }}
        </div>
        {% endif %}
        
        {% if search_params.min_price or search_params.max_price %}
        <div class="filter-button">
            <i class="bi bi-cash"></i> 
            {% if search_params.min_price and search_params.max_price %}
                {{ "{:,.0f}".format(search_params.min_price|float) }} VND - {{ "{:,.0f}".format(search_params.max_price|float) }} VND
            {% elif search_params.min_price %}
                Từ {{ "{:,.0f}".format(search_params.min_price|float) }} VND
            {% elif search_params.max_price %}
                Đến {{ "{:,.0f}".format(search_params.max_price|float) }} VND
            {% endif %}
        </div>
        {% endif %}
        
        {% if search_params.city %}
        <div class="filter-button city-filter">
            <i class="bi bi-building"></i> {{ search_params.city }}
        </div>
        {% endif %}
        
        {% if search_params.district %}
        <div class="filter-button district-filter">
            <i class="bi bi-geo-fill"></i> {{ search_params.district }}
        </div>
        {% endif %}
        
        {% if selected_amenity_ids %}
            {% for amenity in amenities %}
                {% if amenity.id in selected_amenity_ids %}
                <div class="filter-button">
                    <i class="bi {{ amenity.icon }}"></i> {{ amenity.name }}
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        {% if selected_rule_ids %}
            {% for rule in rules %}
                {% if rule.id in selected_rule_ids %}
                <div class="filter-button">
                    <i class="bi {{ rule.icon }}"></i> {{ rule.name }}
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        {% if search_params.location or search_params.min_price or search_params.max_price or search_params.city or search_params.district or selected_amenity_ids %}
        <a href="{{ url_for('renter.search', booking_type=search_params.booking_type) }}" class="filter-button">
            <i class="bi bi-x-circle"></i> Xóa tất cả
        </a>
        {% endif %}
    </div>
    
    <!-- Modal Filter Panel -->
    <div class="offcanvas" tabindex="-1" id="filter-offcanvas" aria-labelledby="filter-offcanvas-label">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="filter-offcanvas-label">Tùy Chọn Lọc</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form method="get" action="{{ url_for('renter.search') }}" id="filter-form">
                <!-- Hidden booking type field -->
                <input type="hidden" name="booking_type" value="{{ search_params.booking_type or 'hourly' }}">
                <input type="hidden" id="min_price" name="min_price" value="{{ search_params.min_price or '0' }}">
                <input type="hidden" id="max_price" name="max_price" value="{{ search_params.max_price or '10000000' }}">
                
                <div class="filter-section">
                    <div class="filter-header">
                        <h6 class="mb-0">Địa điểm</h6>
                    </div>
                    <div class="filter-content">
                        <input type="text" class="form-control form-control-lg" id="location" name="location" 
                               value="{{ search_params.location or '' }}"
                               placeholder="Nhập địa điểm hoặc tên homestay">
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-header">
                        <h6 class="mb-0">Khu vực</h6>
                    </div>
                    <div class="filter-content">
                        <select class="form-select form-select-lg mb-3" id="city" name="city">
                            <option value="">Tất Cả Thành Phố</option>
                            {% for city in cities %}
                            <option value="{{ city }}" {% if search_params.city == city %}selected{% endif %}>{{ city }}</option>
                            {% endfor %}
                        </select>
                        
                        <select class="form-select form-select-lg" id="district" name="district">
                            <option value="">Tất Cả Quận/Huyện</option>
                            {% for district in districts %}
                            <option value="{{ district }}" {% if search_params.district == district %}selected{% endif %}>{{ district }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-header">
                        <h6 class="mb-0">Giá</h6>
                    </div>
                    <div class="filter-content">
                        <div class="price-inputs">
                            <div class="mb-3">
                                <label for="min_price_input" class="form-label">Giá tối thiểu (VND)</label>
                                <input type="number" class="form-control" id="min_price_input" 
                                    placeholder="0" value="{{ search_params.min_price|default(0)|int }}">
                            </div>
                            <div class="mb-3">
                                <label for="max_price_input" class="form-label">Giá tối đa (VND)</label>
                                <input type="number" class="form-control" id="max_price_input" 
                                    placeholder="10000000" value="{{ search_params.max_price|default(10000000)|int }}">
                            </div>
                        </div>
                        
                        <small class="text-muted d-block text-center">
                            {% if search_params.booking_type == 'daily' %}
                                Nhập giá theo đêm (VND)
                            {% else %}
                                Nhập giá theo giờ (VND)
                            {% endif %}
                        </small>
                    </div>
                </div>
                
                <!-- Tiện ích -->
                <div class="filter-section">
                    <div class="filter-header">
                        <h6 class="mb-0">Tiện ích</h6>
                    </div>
                    <div class="filter-content">
                        {% set amenities_by_category = {} %}
                        {% for amenity in amenities %}
                            {% if amenity.amenity_category %}
                                {% if amenity.amenity_category.name not in amenities_by_category %}
                                    {% set _ = amenities_by_category.update({amenity.amenity_category.name: []}) %}
                                {% endif %}
                                {% set _ = amenities_by_category[amenity.amenity_category.name].append(amenity) %}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Group amenities by category -->
                        {% for category_name, category_amenities in amenities_by_category.items() %}
                            <div class="amenity-group">
                                <h6>{{ category_name }}</h6>
                                <div class="amenities-grid">
                                    {% for amenity in category_amenities %}
                                    <div class="form-check amenity-checkbox">
                                        <input class="form-check-input" type="checkbox" value="{{ amenity.id }}" 
                                               id="amenity-{{ amenity.id }}" name="amenities" 
                                               {% if amenity.id in selected_amenity_ids %}checked{% endif %}>
                                        <label class="form-check-label" for="amenity-{{ amenity.id }}">
                                            <i class="bi {{ amenity.icon }} me-2"></i>{{ amenity.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <!-- If no categories exist, show all amenities in a grid -->
                            <div class="amenities-grid">
                                {% for amenity in amenities %}
                                <div class="form-check amenity-checkbox">
                                    <input class="form-check-input" type="checkbox" value="{{ amenity.id }}" 
                                           id="amenity-{{ amenity.id }}" name="amenities" 
                                           {% if amenity.id in selected_amenity_ids %}checked{% endif %}>
                                    <label class="form-check-label" for="amenity-{{ amenity.id }}">
                                        <i class="bi {{ amenity.icon }} me-2"></i>{{ amenity.name }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Nội quy -->
                <div class="filter-section">
                    <div class="filter-header">
                        <h6 class="mb-0">Nội Quy</h6>
                    </div>
                    <div class="filter-content">
                        <div class="rules-grid amenities-grid">
                            {% for rule in rules %}
                            <div class="form-check rule-checkbox">
                                <input class="form-check-input" type="checkbox" value="{{ rule.id }}" 
                                       id="rule-{{ rule.id }}" name="rules" 
                                       {% if rule.id in selected_rule_ids %}checked{% endif %}>
                                <label class="form-check-label" for="rule-{{ rule.id }}">
                                    <i class="bi {{ rule.icon }} me-2"></i>{{ rule.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Áp dụng</button>
                    <a href="{{ url_for('renter.search', booking_type=search_params.booking_type) }}" class="btn btn-outline-secondary">Xóa tất cả</a>
                </div>
            </form>
        </div>
    </div>
    <!-- This section was duplicated - removed -->

    <!-- Home Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="section-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                <div class="section-title-wrapper text-center text-md-start mb-3 mb-md-0">
                    <h2 class="section-title mb-0">
                        {% if homes %}
                            Tìm thấy {{ homes|length }} kết quả phù hợp
                        {% else %}
                            Kết quả tìm kiếm
                        {% endif %}
                    </h2>
                    <p class="section-subtitle text-muted mb-0">
                        {% if search_params.location %}
                            Homestay tại {{ search_params.location }}
                        {% else %}
                            Khám phá những homestay tuyệt vời
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        {% if homes %}
            {% for home in homes %}
            <div class="col-xl-5cols col-lg-5cols col-md-6">
                <div class="card homestay-card h-100">
                    <div class="card-img-container">
                        {% if home.images and home.images|length > 0 %}
                            {% set featured_image = home.images|selectattr('is_featured', 'equalto', True)|list|first %}
                            {% if featured_image %}
                                <img src="{{ url_for('static', filename=featured_image.image_path) }}" class="card-img-top" alt="{{ home.title }}">
                            {% else %}
                                <img src="{{ url_for('static', filename=home.images[0].image_path) }}" class="card-img-top" alt="{{ home.title }}">
                            {% endif %}
                        {% else %}
                            <img src="{{ url_for('static', filename='data/system/default-homestay.jpg') }}" class="card-img-top" alt="Default Image">
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <!-- Title and detail button -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">{{ home.title }}</h5>
                            <a href="{{ url_for('renter.view_home', id=home.id) }}" class="btn btn-outline-primary btn-sm">
                                Chi tiết
                            </a>
                        </div>
                        
                        <!-- Location -->
                        <div class="location-info mb-3">
                            <i class="bi bi-geo-alt me-1 text-muted"></i>
                            <span class="text-muted">{{ home.district | format_district }}, {{ home.city | format_city }}</span>
                        </div>
                        
                        <!-- Price -->
                        <div class="price-info">
                            <span class="text-muted">từ </span>
                            <span class="fw-bold text-dark">
                                {% if search_params.booking_type == 'daily' %}
                                    {% if home.display_price_per_night %}
                                        {{ "{:,.0f}".format(home.display_price_per_night) }} VND/ngày
                                    {% elif home.price_per_night %}
                                        {{ "{:,.0f}".format(home.price_per_night) }} VND/ngày
                                    {% elif home.price_per_day %}
                                        {{ "{:,.0f}".format(home.price_per_day) }} VND/ngày
                                    {% elif home.price_overnight %}
                                        {{ "{:,.0f}".format(home.price_overnight) }} VND/qua đêm
                                    {% elif home.price_daytime %}
                                        {{ "{:,.0f}".format(home.price_daytime) }} VND/ban ngày
                                    {% else %}
                                        Liên hệ để biết giá
                                    {% endif %}
                                {% else %}
                                    {% if home.display_price %}
                                        {{ "{:,}".format(home.display_price) }} VND/h
                                    {% elif home.price_per_hour %}
                                        {{ "{:,.0f}".format(home.price_per_hour) }} VND/giờ
                                    {% elif home.price_first_2_hours %}
                                        {{ "{:,.0f}".format(home.price_first_2_hours) }} VND/2 giờ đầu
                                    {% elif home.price_per_additional_hour %}
                                        {{ "{:,.0f}".format(home.price_per_additional_hour) }} VND/giờ thêm
                                    {% else %}
                                        Liên hệ để biết giá
                                    {% endif %}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    Không tìm thấy nhà phù hợp với tiêu chí tìm kiếm. Vui lòng thử lại với bộ lọc khác.
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Format price function
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price) + 'đ';
        }
        
        // Price input functionality
        const minPriceInput = document.getElementById('min_price');
        const maxPriceInput = document.getElementById('max_price');
        const minPriceInputField = document.getElementById('min_price_input');
        const maxPriceInputField = document.getElementById('max_price_input');
        
        // Set initial min/max values if not already set
        const initialMinPrice = parseFloat(minPriceInput.value) || 0;
        const initialMaxPrice = parseFloat(maxPriceInput.value) || 10000000;
        
        // Initialize price input fields
        minPriceInputField.value = initialMinPrice;
        maxPriceInputField.value = initialMaxPrice;
        
        // Update hidden inputs when number inputs change
        minPriceInputField.addEventListener('input', function() {
            minPriceInput.value = this.value || 0;
        });
        
        maxPriceInputField.addEventListener('input', function() {
            maxPriceInput.value = this.value || 10000000;
        });
        
        // Show active filters
        const filterButtons = document.querySelectorAll('.filter-button');
        filterButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // If this is the "clear all" button, don't need special handling
                if (this.querySelector('.bi-x-circle')) return;
                
                // Otherwise remove just this filter
                const filterType = this.querySelector('i').className;
                if (filterType.includes('bi-geo-alt')) {
                    document.getElementById('location').value = '';
                } else if (filterType.includes('bi-building')) {
                    document.getElementById('city').value = '';
                } else if (filterType.includes('bi-geo-fill')) {
                    document.getElementById('district').value = '';
                } else if (filterType.includes('bi-cash')) {
                    document.getElementById('min_price').value = '0';
                    document.getElementById('max_price').value = '10000000';
                    document.getElementById('min_price_input').value = '0';
                    document.getElementById('max_price_input').value = '10000000';
                } else {
                    // Must be an amenity filter
                    const amenityText = this.textContent.trim();
                    document.querySelectorAll('.amenity-checkbox label').forEach(label => {
                        if (label.textContent.trim() === amenityText) {
                            label.previousElementSibling.checked = false;
                        }
                    });
                }
                
                // Submit the form
                document.querySelector('#filter-form').submit();
                e.preventDefault();
            });
        });
        
        // Make district dropdown dependent on city selection
        const citySelect = document.getElementById('city');
        const districtSelect = document.getElementById('district');
        
        citySelect.addEventListener('change', function() {
            const selectedCity = this.value;
            // This could be enhanced with AJAX to load only relevant districts
            // For now, just reset the district dropdown
            districtSelect.value = '';
        });
        
        // The filter modal is now automatically centered using CSS
    });
    
    // Search Tab Switching
    function switchSearchTab(tabType) {
        // Update tab buttons
        document.querySelectorAll('.search-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[onclick="switchSearchTab('${tabType}')"]`).classList.add('active');
        
        // Update form visibility
        document.querySelectorAll('.search-form-content').forEach(form => {
            form.style.display = 'none';
        });
        document.getElementById(`${tabType}-search-form`).style.display = 'block';
    }
    
    // DEBUG: Log when script loads
    console.log('DEBUG: Search page script loaded');
    
    // Expand/Collapse search functions
    function expandSearch() {
        document.getElementById('compact-search').style.display = 'none';
        document.getElementById('expanded-search').style.display = 'block';
    }
    
    function collapseSearch() {
        document.getElementById('expanded-search').style.display = 'none';
        document.getElementById('compact-search').style.display = 'flex';
    }
    
    // Close expanded search when clicking outside
    document.addEventListener('click', function(event) {
        const expandedSearch = document.getElementById('expanded-search');
        const compactSearch = document.getElementById('compact-search');
        
        if (expandedSearch && expandedSearch.style.display === 'block') {
            if (!expandedSearch.contains(event.target) && !compactSearch.contains(event.target)) {
                collapseSearch();
            }
        }
    });
    
    // Initialize search form with current values
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DEBUG: DOMContentLoaded fired');
        console.log('DEBUG: Search navbar element:', document.querySelector('.search-navbar'));
        console.log('DEBUG: Search form element:', document.querySelector('.search-form'));
        // Set current values for hourly form
        {% if search_params.booking_type == 'hourly' or not search_params.booking_type %}
            {% if search_params.adults or search_params.children %}
                const adultsHourly = {{ search_params.adults or 1 }};
                const childrenHourly = {{ search_params.children or 0 }};
                let guestTextHourly = `${adultsHourly} người lớn`;
                if (childrenHourly > 0) {
                    guestTextHourly += `, ${childrenHourly} trẻ em`;
                }
                const guestHourlyEl = document.getElementById('guests-hourly');
                if (guestHourlyEl) {
                    guestHourlyEl.value = guestTextHourly;
                }
            {% endif %}
        {% endif %}
        
        // Set current values for daily form
        {% if search_params.booking_type == 'daily' %}
            {% if search_params.adults or search_params.children %}
                const adultsDaily = {{ search_params.adults or 1 }};
                const childrenDaily = {{ search_params.children or 0 }};
                let guestTextDaily = `${adultsDaily} người lớn`;
                if (childrenDaily > 0) {
                    guestTextDaily += `, ${childrenDaily} trẻ em`;
                }
                const guestDailyEl = document.getElementById('guests-daily');
                if (guestDailyEl) {
                    guestDailyEl.value = guestTextDaily;
                }
            {% endif %}
        {% endif %}
    });
</script>
{% endblock %}
