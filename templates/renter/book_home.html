<!-- templates/renter/book_home.html -->
{% extends 'base.html' %}
{% block title %}Book Home: {{ home.title }}{% endblock %}

{% macro daily_booking_block(home) %}
  <div id="daily-section">
    <div class="mb-3">
      <label for="start_date" class="form-label">Ng√†y nh·∫≠n ph√≤ng</label>
      <input type="text" class="form-control" id="start_date" name="start_date" required>
    </div>
    <div class="mb-3">
      <label for="duration" class="form-label">S·ªë ng√†y thu√™</label>
      <input type="number" class="form-control" id="duration" name="duration" min="1" value="1" required>
    </div>
    <div class="mb-3">
      <label for="guests_daily" class="form-label">S·ªë kh√°ch</label>
      <input type="number" class="form-control" id="guests_daily" name="guests" min="1" max="{{ home.max_guests }}" value="1" required>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5>T√≥m t·∫Øt ƒë·∫∑t ph√≤ng</h5>
        <p class="text-muted">Gi√° s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n sau khi b·∫°n nh·∫•n "X√°c nh·∫≠n ƒë·∫∑t ph√≤ng"</p>
      </div>
    </div>
    <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n ƒë·∫∑t ph√≤ng</button>
  </div>
{% endmacro %}

{% macro hourly_booking_block(home) %}
  <div id="hourly-section">
    <!-- Hi·ªÉn th·ªã th√¥ng tin gi√° -->
    {% if home.price_overnight or home.price_daytime %}
    <div class="alert alert-info mb-3">
      <h6 class="mb-2">üí° Gi√° theo khung gi·ªù ƒë·∫∑c bi·ªát:</h6>
      <div class="row">
        {% if home.price_overnight %}
        <div class="col-md-6">
          <span class="badge bg-primary">üåô Qua ƒë√™m (21h-8h)</span>
          <br><strong>{{ "{:,.0f}".format(home.price_overnight) }} VND</strong>
          <br><small class="text-muted">√Åp d·ª•ng cho booking t·ª´ 8h tr·ªü l√™n</small>
        </div>
        {% endif %}
        {% if home.price_daytime %}
        <div class="col-md-6">
          <span class="badge bg-info">‚òÄÔ∏è Qua ng√†y (9h-20h)</span>
          <br><strong>{{ "{:,.0f}".format(home.price_daytime) }} VND</strong>
          <br><small class="text-muted">√Åp d·ª•ng cho booking t·ª´ 8h tr·ªü l√™n</small>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <div class="mb-3">
      <label for="start_date_hourly" class="form-label">Ng√†y thu√™</label>
      <input type="text" class="form-control" id="start_date_hourly" name="start_date_hourly" required>
    </div>
    <div class="mb-3">
      <label for="start_time" class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu</label>
      <input type="time" class="form-control" id="start_time" name="start_time" required>
    </div>
    <div class="mb-3">
      <label for="duration_hourly" class="form-label">S·ªë gi·ªù thu√™</label>
      <input type="number" class="form-control" id="duration_hourly" name="duration_hourly" min="1" value="2" required>
    </div>
    <div class="mb-3">
      <label for="guests_hourly" class="form-label">S·ªë kh√°ch</label>
      <input type="number" class="form-control" id="guests_hourly" name="guests" min="1" max="{{ home.max_guests }}" value="1" required>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5>T√≥m t·∫Øt ƒë·∫∑t ph√≤ng</h5>
        <p class="text-muted">Gi√° s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n sau khi b·∫°n nh·∫•n "X√°c nh·∫≠n ƒë·∫∑t ph√≤ng"</p>
      </div>
    </div>
    <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n ƒë·∫∑t ph√≤ng</button>
  </div>
{% endmacro %}

{% block content %}
<div class="row">
  <div class="col-md-8 mx-auto">
    <div class="card">
      <div class="card-header">
        <h4 data-translate="book-home">Book Home: {{ home.title }}</h4>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('renter.book_home', home_id=home.id) }}" id="booking-form">
          {% set has_daily = home.price_per_night or home.price_per_day %}
          {% set has_hourly = home.price_first_2_hours or home.price_per_hour or home.price_per_additional_hour or home.price_overnight or home.price_daytime %}
          {% if has_daily and has_hourly %}
            <div class="mb-3">
              <label class="form-label">Ch·ªçn lo·∫°i h√¨nh thu√™</label>
              <div>
                <input type="radio" id="booking_type_daily" name="booking_type" value="daily" checked>
                <label for="booking_type_daily">Thu√™ theo ng√†y</label>
                <input type="radio" id="booking_type_hourly" name="booking_type" value="hourly" class="ms-3">
                <label for="booking_type_hourly">Thu√™ theo gi·ªù</label>
              </div>
            </div>
            <div id="hybrid-daily-block">{{ daily_booking_block(home) }}</div>
            <div id="hybrid-hourly-block" style="display:none;">{{ hourly_booking_block(home) }}</div>
          {% elif has_hourly and not has_daily %}
            {{ hourly_booking_block(home) }}
          {% else %}
            {{ daily_booking_block(home) }}
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize date pickers
  flatpickr("#start_date_hourly", { minDate: "today", dateFormat: "Y-m-d" });
  flatpickr("#start_date", { minDate: "today", dateFormat: "Y-m-d" });
  
  // Simple booking type switching
  const dailyRadio = document.getElementById('booking_type_daily');
  const hourlyRadio = document.getElementById('booking_type_hourly');
  const dailyBlock = document.getElementById('hybrid-daily-block');
  const hourlyBlock = document.getElementById('hybrid-hourly-block');
  
  if (dailyRadio && hourlyRadio && dailyBlock && hourlyBlock) {
    dailyRadio.addEventListener('change', function() {
      if (this.checked) {
        dailyBlock.style.display = '';
        hourlyBlock.style.display = 'none';
        
        // Disable required fields in hourly block
        document.getElementById('start_date_hourly').required = false;
        document.getElementById('start_time').required = false;
        document.getElementById('duration_hourly').required = false;
        document.getElementById('guests_hourly').required = false;
        
        // Enable required fields in daily block
        document.getElementById('start_date').required = true;
        document.getElementById('duration').required = true;
        document.getElementById('guests_daily').required = true;
      }
    });
    
    hourlyRadio.addEventListener('change', function() {
      if (this.checked) {
        dailyBlock.style.display = 'none';
        hourlyBlock.style.display = '';
        
        // Disable required fields in daily block
        document.getElementById('start_date').required = false;
        document.getElementById('duration').required = false;
        document.getElementById('guests_daily').required = false;
        
        // Enable required fields in hourly block
        document.getElementById('start_date_hourly').required = true;
        document.getElementById('start_time').required = true;
        document.getElementById('duration_hourly').required = true;
        document.getElementById('guests_hourly').required = true;
      }
    });
  }
  
  // Form submission handler
  const form = document.getElementById('booking-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Check which booking type is selected
      const dailyRadio = document.getElementById('booking_type_daily');
      const hourlyRadio = document.getElementById('booking_type_hourly');
      const selectedType = dailyRadio && dailyRadio.checked ? 'daily' : 'hourly';
      
      // Check required fields based on booking type
      if (selectedType === 'daily') {
        const startDate = document.getElementById('start_date').value;
        const duration = document.getElementById('duration').value;
        const guests = document.getElementById('guests_daily').value;
        
        if (!startDate || !duration || !guests) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin: Ng√†y nh·∫≠n ph√≤ng, S·ªë ng√†y thu√™, S·ªë kh√°ch');
          e.preventDefault();
          return false;
        }
      } else {
        const startDateHourly = document.getElementById('start_date_hourly').value;
        const startTime = document.getElementById('start_time').value;
        const durationHourly = document.getElementById('duration_hourly').value;
        const guests = document.getElementById('guests_hourly').value;
        
        if (!startDateHourly || !startTime || !durationHourly || !guests) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin: Ng√†y thu√™, Gi·ªù b·∫Øt ƒë·∫ßu, S·ªë gi·ªù thu√™, S·ªë kh√°ch');
          e.preventDefault();
          return false;
        }
      }
      
      // Let the form submit normally
      return true;
    });
  }
  
  // Initialize form state based on default selection
  if (dailyRadio && dailyRadio.checked) {
    // Daily is selected by default, disable hourly fields
    document.getElementById('start_date_hourly').required = false;
    document.getElementById('start_time').required = false;
    document.getElementById('duration_hourly').required = false;
    document.getElementById('guests_hourly').required = false;
  }
});
</script>
{% endblock %} 