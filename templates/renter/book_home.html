<!-- templates/renter/book_home.html -->
{% extends 'base.html' %}
{% block title %}Book Home: {{ home.title }}{% endblock %}

{% macro daily_booking_block(home) %}
  <div id="daily-section">
    <div class="mb-3">
      <label for="start_date" class="form-label">Ng√†y nh·∫≠n ph√≤ng</label>
      <input type="text" class="form-control" id="start_date" name="start_date" required>
    </div>
    <div class="mb-3">
      <label for="duration" class="form-label">S·ªë ng√†y thu√™</label>
      <input type="number" class="form-control" id="duration" name="duration" min="1" value="1" required>
    </div>
    <div class="mb-3">
      <label for="guests_daily" class="form-label">S·ªë kh√°ch</label>
      <input type="number" class="form-control" id="guests_daily" name="guests" min="1" max="{{ home.max_guests }}" value="1" required>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5>T√≥m t·∫Øt ƒë·∫∑t ph√≤ng</h5>
        <p class="text-muted">Gi√° s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n sau khi b·∫°n nh·∫•n "X√°c nh·∫≠n ƒë·∫∑t ph√≤ng"</p>
      </div>
    </div>
    <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n ƒë·∫∑t ph√≤ng</button>
  </div>
{% endmacro %}

{% macro hourly_booking_block(home) %}
  <div id="hourly-section">
    <!-- Hi·ªÉn th·ªã th√¥ng tin gi√° -->
    {% if home.price_overnight or home.price_daytime %}
    <div class="alert alert-info mb-3">
      <h6 class="mb-2">üí° Gi√° theo khung gi·ªù ƒë·∫∑c bi·ªát:</h6>
      <div class="row">
        {% if home.price_overnight %}
        <div class="col-md-6">
          <span class="badge bg-primary">üåô Qua ƒë√™m (21h-8h)</span>
          <br><strong>{{ "{:,.0f}".format(home.price_overnight) }} VND</strong>
          <br><small class="text-muted">√Åp d·ª•ng cho booking t·ª´ 8h tr·ªü l√™n</small>
        </div>
        {% endif %}
        {% if home.price_daytime %}
        <div class="col-md-6">
          <span class="badge bg-info">‚òÄÔ∏è Qua ng√†y (9h-20h)</span>
          <br><strong>{{ "{:,.0f}".format(home.price_daytime) }} VND</strong>
          <br><small class="text-muted">√Åp d·ª•ng cho booking t·ª´ 8h tr·ªü l√™n</small>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <div class="mb-3">
      <label for="start_date_hourly" class="form-label">Ng√†y thu√™</label>
      <input type="text" class="form-control" id="start_date_hourly" name="start_date_hourly" required>
    </div>
    <div class="mb-3">
      <label for="start_time" class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu</label>
      <div class="time-selector" style="position:relative;">
        <input type="text" class="form-control" id="start_time_display" value="Ch·ªçn gi·ªù" readonly required>
        <input type="hidden" id="start_time" name="start_time" required>
        <div class="time-dropdown" id="time-dropdown" style="display:none; position:absolute; z-index:1000; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:12px; min-width:320px;">
          <div class="time-grid" style="display:grid; grid-template-columns:repeat(6,1fr); gap:8px;">
            <button type="button" class="time-slot" data-time="01:00">01:00</button>
            <button type="button" class="time-slot" data-time="02:00">02:00</button>
            <button type="button" class="time-slot" data-time="03:00">03:00</button>
            <button type="button" class="time-slot" data-time="04:00">04:00</button>
            <button type="button" class="time-slot" data-time="05:00">05:00</button>
            <button type="button" class="time-slot" data-time="06:00">06:00</button>
            <button type="button" class="time-slot" data-time="07:00">07:00</button>
            <button type="button" class="time-slot" data-time="08:00">08:00</button>
            <button type="button" class="time-slot" data-time="09:00">09:00</button>
            <button type="button" class="time-slot" data-time="10:00">10:00</button>
            <button type="button" class="time-slot" data-time="11:00">11:00</button>
            <button type="button" class="time-slot" data-time="12:00">12:00</button>
            <button type="button" class="time-slot" data-time="13:00">13:00</button>
            <button type="button" class="time-slot" data-time="14:00">14:00</button>
            <button type="button" class="time-slot" data-time="15:00">15:00</button>
            <button type="button" class="time-slot" data-time="16:00">16:00</button>
            <button type="button" class="time-slot" data-time="17:00">17:00</button>
            <button type="button" class="time-slot" data-time="18:00">18:00</button>
            <button type="button" class="time-slot" data-time="19:00">19:00</button>
            <button type="button" class="time-slot" data-time="20:00">20:00</button>
            <button type="button" class="time-slot" data-time="21:00">21:00</button>
            <button type="button" class="time-slot" data-time="22:00">22:00</button>
            <button type="button" class="time-slot" data-time="23:00">23:00</button>
            <button type="button" class="time-slot" data-time="24:00">24:00</button>
          </div>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <label for="duration_hourly" class="form-label">S·ªë gi·ªù thu√™</label>
      <div class="duration-selector" style="position:relative;">
        <input type="text" class="form-control" id="duration_hourly_display" value="Ch·ªçn s·ªë gi·ªù" readonly required>
        <input type="hidden" id="duration_hourly" name="duration_hourly" required>
        <div class="duration-dropdown" id="duration-dropdown" style="display:none; position:absolute; z-index:1000; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:12px; min-width:220px;">
          <div class="duration-grid" style="display:grid; grid-template-columns:repeat(9,1fr); gap:8px;">
            <button type="button" class="duration-slot" data-duration="2">2 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="3">3 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="4">4 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="5">5 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="6">6 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="7">7 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="8">8 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="9">9 gi·ªù</button>
            <button type="button" class="duration-slot" data-duration="10">10 gi·ªù</button>
          </div>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <label for="guests_hourly" class="form-label">S·ªë kh√°ch</label>
      <input type="number" class="form-control" id="guests_hourly" name="guests" min="1" max="{{ home.max_guests }}" value="1" required>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5>T√≥m t·∫Øt ƒë·∫∑t ph√≤ng</h5>
        <p class="text-muted">Gi√° s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n sau khi b·∫°n nh·∫•n "X√°c nh·∫≠n ƒë·∫∑t ph√≤ng"</p>
      </div>
    </div>
    <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n ƒë·∫∑t ph√≤ng</button>
  </div>
{% endmacro %}

{% block content %}
<input type="hidden" id="current_home_id" value="{{ home.id }}">
<div class="row">
  <div class="col-md-8 mx-auto">
    <div class="card">
      <div class="card-header">
        <h4 data-translate="book-home">Book Home: {{ home.title }}</h4>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('renter.book_home', home_id=home.id) }}" id="booking-form">
          {% set has_daily = home.price_per_night or home.price_per_day %}
          {% set has_hourly = home.price_first_2_hours or home.price_per_hour or home.price_per_additional_hour or home.price_overnight or home.price_daytime %}
          {% if has_daily and has_hourly %}
            <div class="mb-3">
              <label class="form-label">Ch·ªçn lo·∫°i h√¨nh thu√™</label>
              <div>
                <input type="radio" id="booking_type_daily" name="booking_type" value="daily" checked>
                <label for="booking_type_daily">Thu√™ theo ng√†y</label>
                <input type="radio" id="booking_type_hourly" name="booking_type" value="hourly" class="ms-3">
                <label for="booking_type_hourly">Thu√™ theo gi·ªù</label>
              </div>
            </div>
            <div id="hybrid-daily-block">{{ daily_booking_block(home) }}</div>
            <div id="hybrid-hourly-block" style="display:none;">{{ hourly_booking_block(home) }}</div>
          {% elif has_hourly and not has_daily %}
            {{ hourly_booking_block(home) }}
          {% else %}
            {{ daily_booking_block(home) }}
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize date pickers
  flatpickr("#start_date_hourly", { minDate: "today", dateFormat: "Y-m-d" });
  flatpickr("#start_date", { minDate: "today", dateFormat: "Y-m-d" });
  
  // Simple booking type switching
  const dailyRadio = document.getElementById('booking_type_daily');
  const hourlyRadio = document.getElementById('booking_type_hourly');
  const dailyBlock = document.getElementById('hybrid-daily-block');
  const hourlyBlock = document.getElementById('hybrid-hourly-block');
  
  if (dailyRadio && hourlyRadio && dailyBlock && hourlyBlock) {
    dailyRadio.addEventListener('change', function() {
      if (this.checked) {
        dailyBlock.style.display = '';
        hourlyBlock.style.display = 'none';
        
        // Disable required fields in hourly block
        document.getElementById('start_date_hourly').required = false;
        document.getElementById('start_time_display').required = false; // Hide the display input
        document.getElementById('duration_hourly_display').required = false; // Hide the display input
        document.getElementById('duration_hourly').required = false;
        document.getElementById('guests_hourly').required = false;
        
        // Enable required fields in daily block
        document.getElementById('start_date').required = true;
        document.getElementById('duration').required = true;
        document.getElementById('guests_daily').required = true;
      }
    });
    
    hourlyRadio.addEventListener('change', function() {
      if (this.checked) {
        dailyBlock.style.display = 'none';
        hourlyBlock.style.display = '';
        
        // Disable required fields in daily block
        document.getElementById('start_date').required = false;
        document.getElementById('duration').required = false;
        document.getElementById('guests_daily').required = false;
        
        // Enable required fields in hourly block
        document.getElementById('start_date_hourly').required = true;
        document.getElementById('start_time_display').required = true; // Show the display input
        document.getElementById('duration_hourly_display').required = true; // Show the display input
        document.getElementById('duration_hourly').required = true;
        document.getElementById('guests_hourly').required = true;
      }
    });
  }
  
  // Form submission handler
  const form = document.getElementById('booking-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Check which booking type is selected
      const dailyRadio = document.getElementById('booking_type_daily');
      const hourlyRadio = document.getElementById('booking_type_hourly');
      const selectedType = dailyRadio && dailyRadio.checked ? 'daily' : 'hourly';
      
      // Check required fields based on booking type
      if (selectedType === 'daily') {
        const startDate = document.getElementById('start_date').value;
        const duration = document.getElementById('duration').value;
        const guests = document.getElementById('guests_daily').value;
        
        if (!startDate || !duration || !guests) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin: Ng√†y nh·∫≠n ph√≤ng, S·ªë ng√†y thu√™, S·ªë kh√°ch');
          e.preventDefault();
          return false;
        }
      } else {
        const startDateHourly = document.getElementById('start_date_hourly').value;
        const startTime = document.getElementById('start_time').value;
        const durationHourly = document.getElementById('duration_hourly').value;
        const guests = document.getElementById('guests_hourly').value;
        
        if (!startDateHourly || !startTime || !durationHourly || !guests) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin: Ng√†y thu√™, Gi·ªù b·∫Øt ƒë·∫ßu, S·ªë gi·ªù thu√™, S·ªë kh√°ch');
          e.preventDefault();
          return false;
        }
      }
      
      // Let the form submit normally
      return true;
    });
  }
  
  // Initialize form state based on default selection
  if (dailyRadio && dailyRadio.checked) {
    // Daily is selected by default, disable hourly fields
    document.getElementById('start_date_hourly').required = false;
    document.getElementById('start_time_display').required = false; // Hide the display input
    document.getElementById('duration_hourly_display').required = false; // Hide the display input
    document.getElementById('duration_hourly').required = false;
    document.getElementById('guests_hourly').required = false;
  }

  // --- Dropdown ch·ªçn gi·ªù b·∫Øt ƒë·∫ßu (hourly) ---
  const timeDisplay = document.getElementById('start_time_display');
  const timeDropdown = document.getElementById('time-dropdown');
  const timeHidden = document.getElementById('start_time');
  if (timeDisplay && timeDropdown && timeHidden) {
    timeDisplay.addEventListener('click', function(e) {
      e.stopPropagation();
      updateTimeSlotsDisable(); // Lu√¥n update l·∫°i disable khi m·ªü dropdown
      timeDropdown.style.display = 'block';
    });
    document.querySelectorAll('.time-slot').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (btn.disabled) return; // Kh√¥ng cho ch·ªçn n·∫øu b·ªã disable
        timeDisplay.value = this.dataset.time;
        timeHidden.value = this.dataset.time;
        timeDropdown.style.display = 'none';
        timeDisplay.classList.remove('is-invalid');
      });
    });
    // ·∫®n dropdown khi click ra ngo√†i
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.time-selector')) {
        timeDropdown.style.display = 'none';
      }
    });
    // N·∫øu submit m√† ch∆∞a ch·ªçn gi·ªù th√¨ b√°o l·ªói
    const form = document.getElementById('booking-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        if (timeDisplay.required && !timeHidden.value) {
          timeDisplay.classList.add('is-invalid');
          timeDropdown.style.display = 'block';
          e.preventDefault();
        }
      });
    }
  }

  // --- Dropdown ch·ªçn s·ªë gi·ªù thu√™ (hourly) ---
  const durationDisplay = document.getElementById('duration_hourly_display');
  const durationDropdown = document.getElementById('duration-dropdown');
  const durationHidden = document.getElementById('duration_hourly');
  if (durationDisplay && durationDropdown && durationHidden) {
    durationDisplay.addEventListener('click', function(e) {
      e.stopPropagation();
      durationDropdown.style.display = 'block';
    });
    document.querySelectorAll('.duration-slot').forEach(function(btn) {
      btn.addEventListener('click', function() {
        durationDisplay.value = this.dataset.duration + ' gi·ªù';
        durationHidden.value = this.dataset.duration;
        durationDropdown.style.display = 'none';
        durationDisplay.classList.remove('is-invalid');
      });
    });
    // ·∫®n dropdown khi click ra ngo√†i
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.duration-selector')) {
        durationDropdown.style.display = 'none';
      }
    });
    // N·∫øu submit m√† ch∆∞a ch·ªçn s·ªë gi·ªù th√¨ b√°o l·ªói
    const form = document.getElementById('booking-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        if (durationDisplay.required && !durationHidden.value) {
          durationDisplay.classList.add('is-invalid');
          durationDropdown.style.display = 'block';
          e.preventDefault();
        }
      });
    }
  }

  // --- Disable block gi·ªù tr√πng booking ---
  // L∆∞u tr·∫°ng th√°i booking theo ng√†y
  let bookingsInDay = [];

  // L·∫•y home_id t·ª´ input ·∫©n
  const homeId = document.getElementById('current_home_id')?.value;
  const startDateInput = document.getElementById('start_date_hourly');

  // H√†m fetch booking theo ng√†y
  async function fetchBookingsForDay(dateStr) {
    if (!homeId || !dateStr) return [];
    try {
      const res = await fetch(`/renter/api/bookings/${homeId}/${dateStr}`);
      const data = await res.json();
      if (data.success) return data.bookings;
      return [];
    } catch (e) { return []; }
  }

  // H√†m ki·ªÉm tra block gi·ªù c√≥ b·ªã tr√πng kh√¥ng (so s√°nh c·∫£ ng√†y v√† gi·ªù)
  function isTimeSlotDisabled(startHour, duration) {
    const d = parseInt(duration || 2) + 1;
    const dateStr = startDateInput?.value;
    if (!dateStr) return false;
    // T·∫°o kho·∫£ng th·ªùi gian mu·ªën ki·ªÉm tra (ng√†y ƒëang ch·ªçn)
    const start = new Date(dateStr + 'T' + (startHour < 10 ? '0' : '') + startHour + ':00');
    const end = new Date(start.getTime() + d * 60 * 60 * 1000);
    for (const b of bookingsInDay) {
      const bStart = new Date(b.start_time.replace(' ', 'T'));
      const bEnd = new Date(b.end_time.replace(' ', 'T'));
      // So s√°nh c√πng ng√†y
      if (
        start.getFullYear() === bStart.getFullYear() &&
        start.getMonth() === bStart.getMonth() &&
        start.getDate() === bStart.getDate()
      ) {
        // N·∫øu c√≥ overlap th√¨ disable
        if (start < bEnd && end > bStart) return true;
      }
    }
    return false;
  }

  // C·∫≠p nh·∫≠t tr·∫°ng th√°i disable cho c√°c block gi·ªù
  function updateTimeSlotsDisable() {
    const duration = durationHidden.value || 2;
    console.log('Bookings trong ng√†y:', bookingsInDay);
    document.querySelectorAll('.time-slot').forEach(btn => {
      const hour = parseInt(btn.dataset.time.split(':')[0]);
      const disabled = isTimeSlotDisabled(hour, duration);
      console.log('Gi·ªù:', btn.dataset.time, 'Disable:', disabled);
      if (disabled) {
        btn.disabled = true;
        btn.classList.add('disabled');
        btn.style.background = '#eee';
        btn.style.color = '#aaa';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.classList.remove('disabled');
        btn.style.background = '';
        btn.style.color = '';
        btn.style.cursor = '';
      }
    });
  }

  // Khi ch·ªçn ng√†y ho·∫∑c s·ªë gi·ªù thu√™ th√¨ fetch l·∫°i bookings v√† c·∫≠p nh·∫≠t block gi·ªù
  async function handleDateOrDurationChange() {
    const dateStr = startDateInput?.value;
    if (!dateStr) return;
    bookingsInDay = await fetchBookingsForDay(dateStr);
    updateTimeSlotsDisable();
  }

  if (startDateInput) {
    startDateInput.addEventListener('change', handleDateOrDurationChange);
  }
  if (durationHidden) {
    durationHidden.addEventListener('change', updateTimeSlotsDisable);
  }
  // Khi ch·ªçn s·ªë gi·ªù thu√™ th√¨ c≈©ng g·ªçi l·∫°i updateTimeSlotsDisable sau khi ch·ªçn
  document.querySelectorAll('.duration-slot').forEach(btn => {
    btn.addEventListener('click', function() {
      setTimeout(updateTimeSlotsDisable, 100); // delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o value ƒë√£ c·∫≠p nh·∫≠t
    });
  });

  // Khi trang load, n·∫øu ƒë√£ c√≥ ng√†y v√† s·ªë gi·ªù thu√™, g·ªçi lu√¥n h√†m fetch bookings v√† disable block gi·ªù
  const dateStrInit = startDateInput?.value;
  if (dateStrInit) {
    handleDateOrDurationChange();
  }
});
</script>
{% endblock %} 