{% extends 'base.html' %}
{% block title %}{{ room.homestay.business_name or room.homestay.full_name }} - Phòng {{ room.room_number }}{% endblock %}

{% block content %}
<style>
    .room-detail-container {
        margin-top: -50px !important;
        background: #f8f9fa;
    }
    
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title i {
        color: #8bc34a;
        font-size: 20px;
    }

    .description-text {
        color: #4a5568;
        line-height: 1.6;
        font-size: 15px;
    }

    .address-text {
        color: #4a5568;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .address-text i {
        color: #8bc34a;
    }

    .amenity-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #4a5568;
        font-size: 15px;
        margin-bottom: 12px;
    }

    .amenity-item i {
        color: #8bc34a;
        font-size: 18px;
    }

    .rule-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #4a5568;
        font-size: 15px;
        margin-bottom: 12px;
    }

    .rule-item i {
        color: #8bc34a;
        font-size: 18px;
    }
    
    /* Hover effect cho nút xem tất cả */
    .amenities-btn:hover {
        background-color: #8bc34a !important;
        border-color: #8bc34a !important;
        color: white !important;
    }
    
    .rules-btn:hover {
        background-color: #8bc34a !important;
        border-color: #8bc34a !important;
        color: white !important;
    }
    
    .amenities-btn,
    .rules-btn {
        transition: all 0.3s ease;
        color: #8bc34a !important;
        border-color: #8bc34a !important;
    }
    
    /* Đảm bảo địa chỉ hiển thị đầy đủ */
    .address-text {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow: visible !important;
        text-overflow: unset !important;
        max-width: none !important;
    }
    
    /* Gallery image hover effect */
    .gallery-img {
        transition: all 0.3s ease;
    }
    
    .gallery-img:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    /* Đảm bảo modal hiển thị trên cùng */
    .modal {
        z-index: 1060 !important;
    }
    
    .modal-backdrop {
        z-index: 1055 !important;
    }
    
    /* Single image modal có z-index cao nhất */
    #singleImageModal {
        z-index: 1070 !important;
    }
    
    #singleImageModal .modal-backdrop {
        z-index: 1065 !important;
    }
    
    /* Backdrop làm mờ xung quanh */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.7) !important;
    }
    
    .modal-backdrop.show {
        opacity: 1 !important;
    }
    
    /* Single image modal backdrop làm mờ mạnh hơn */
    #singleImageModal + .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.9) !important;
    }
    
    /* Transition cho modal gallery */
    #imageGalleryModal {
        transition: all 0.3s ease;
    }
    
    /* Placeholder hướng dẫn xem ảnh */
    .image-guide {
        background: linear-gradient(135deg, #8bc34a, #7cb342);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 13px;
        position: relative;
        margin-top: 10px;
        display: inline-block;
        box-shadow: 0 2px 10px rgba(139, 195, 74, 0.3);
    }
    
    .image-guide::before {
        content: '';
        position: absolute;
        top: -5px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #8bc34a;
    }
    
    .image-hover-tip {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }
    
    .position-relative:hover .image-hover-tip {
        opacity: 1;
    }
    
    /* Hover effect cho ảnh chính và phụ */
    .main-image, .side-image {
        transition: all 0.3s ease;
    }
    
    .main-image:hover {
        transform: scale(1.015);
    }
    
    .side-image:hover {
        transform: scale(1.03);
    }
    
    .image-hover-simple {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
        white-space: nowrap;
    }
    
    .position-relative:hover .image-hover-simple {
        opacity: 1;
    }

    /* CSS cho modal */
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .modal-header {
        border-bottom: 1px solid #eee;
        padding: 20px;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-title i {
        color: #8bc34a;
    }

    /* Hover effect cho các item */
    .modal-body .rounded {
        transition: all 0.2s ease;
    }

    .modal-body .rounded:hover {
        background: #f0f0f0 !important;
    }

    /* Icon styles */
    .modal-body i {
        color: #8bc34a;
        width: 24px;
        text-align: center;
    }

    /* Amenity badge styling */
    .amenity-badge {
        background: #f8f9fa !important;
        border: 1px solid #e9ecef;
        padding: 8px 12px !important;
        font-size: 13px;
        transition: all 0.2s ease;
        height: 36px;
        min-height: 36px;
    }

    .amenity-badge:hover {
        background: #e9ecef !important;
        border-color: #8bc34a;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(139, 195, 74, 0.2);
    }

    .amenity-badge i {
        color: #8bc34a;
        font-size: 14px;
        width: 16px;
        text-align: center;
    }

    .amenity-text {
        font-size: 13px;
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Rule badge styling - giống amenity badge */
    .rule-badge {
        background: #f8f9fa !important;
        border: 1px solid #e9ecef;
        padding: 8px 12px !important;
        font-size: 13px;
        transition: all 0.2s ease;
        height: 36px;
        min-height: 36px;
    }

    .rule-badge:hover {
        background: #e9ecef !important;
        border-color: #8bc34a;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(139, 195, 74, 0.2);
    }

    .rule-badge i {
        color: #8bc34a;
        font-size: 14px;
        width: 16px;
        text-align: center;
    }

    .rule-text {
        font-size: 13px;
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Header action buttons styling */
    .header-action-btn {
        min-width: 44px;
        height: 36px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        border-width: 1.5px;
    }
    
    .header-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .header-action-btn i {
        font-size: 14px;
    }
    
    /* Saved state for heart button */
    .header-action-btn.saved {
        background-color: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white !important;
    }
    
    .header-action-btn.saved:hover {
        background-color: #c82333 !important;
        border-color: #c82333 !important;
    }
    
    /* Success button custom styling */
    .btn-success.header-action-btn {
        background: linear-gradient(135deg, #8bc34a, #7cb342);
        border-color: #8bc34a;
        font-weight: 600;
    }
    
    .btn-success.header-action-btn:hover {
        background: linear-gradient(135deg, #7cb342, #689f38);
        border-color: #7cb342;
    }
</style>
<div class="container-fluid px-4 pt-4 pb-5 room-detail-container">
    <!-- Header -->
    <div class="section-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="h2 fw-bold mb-2">{{ room.homestay.business_name}}</h1>
                <p class="address-text mb-0">
                    <i class="bi bi-geo-alt"></i>
                    {{ room.address }}, 
                    {% if room.district.lower().startswith('quan') %}
                        {{ room.district|title|replace('Quan', 'Quận ')|replace('Quận quan', 'Quận ') }}
                    {% else %}
                        {{ room.district }}
                    {% endif %}, 
                    {% if room.city.lower() == 'hcm' or room.city.lower() == 'ho chi minh' %}
                        Thành phố Hồ Chí Minh
                    {% elif room.city.lower() == 'hn' or room.city.lower() == 'hanoi' %}
                        Thành phố Hà Nội
                    {% elif room.city.lower() == 'dn' or room.city.lower() == 'da nang' %}
                        Thành phố Đà Nẵng
                    {% else %}
                        {{ room.city }}
                    {% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm header-action-btn" onclick="shareRoom()" title="Chia sẻ">
                    <i class="bi bi-share"></i>
                    <span class="d-none d-md-inline ms-1">Chia sẻ</span>
                </button>
                <button class="btn btn-outline-danger btn-sm header-action-btn" onclick="toggleSaveRoom()" title="Lưu" id="saveRoomBtn">
                    <i class="bi bi-heart"></i>
                    <span class="d-none d-md-inline ms-1">Lưu</span>
                </button>
                <a href="{{ url_for('renter.book_room', room_id=room.id) }}" class="btn btn-success btn-sm header-action-btn" title="Đặt ngay">
                    <i class="bi bi-calendar-check"></i>
                    <span class="d-none d-md-inline ms-1">Đặt ngay</span>
                </a>
            </div>
        </div>
    </div>
                
    <!-- Gallery -->
    <div class="section-card">
            <div class="row g-2">
                <div class="col-md-8">
                    <div class="position-relative" style="height: 400px;">
                        {% if room.images %}
                            {% set featured_image = room.images|selectattr('is_featured', 'equalto', True)|list|first %}
                            <img src="{{ url_for('static', filename=(featured_image.image_path if featured_image else room.images[0].image_path)) }}" 
                                 class="img-fluid w-100 h-100 rounded-3 main-image" 
                                 style="object-fit: cover; cursor: pointer;" 
                                 alt="Main room image"
                                 onclick="showSingleImage('{{ url_for('static', filename=(featured_image.image_path if featured_image else room.images[0].image_path)) }}', 'Ảnh chính')">
                            <div class="image-hover-simple">
                                Click để xem toàn bộ ảnh
                            </div>
                        {% else %}
                            <div class="bg-secondary w-100 h-100 rounded-3 d-flex align-items-center justify-content-center" style="background-color: #C8C8C8 !important;">
                                <span class="text-muted">Không có hình ảnh</span>
                            </div>
                        {% endif %}
                </div>
            </div>
            
                <div class="col-md-4">
                    <!-- Side Images -->
                    <div class="row g-2">
                        <div class="col-12 position-relative" style="height: 195px;">
                            {% if room.images and room.images|length > 1 %}
                                <img src="{{ url_for('static', filename=room.images[1].image_path) }}" 
                                     class="img-fluid w-100 h-100 rounded-2 side-image" 
                                     style="object-fit: cover; cursor: pointer;" 
                                     alt="Room image"
                                     onclick="showSingleImage('{{ url_for('static', filename=room.images[1].image_path) }}', 'Ảnh phụ 1')">
                                <div class="image-hover-simple">
                                    Click để xem toàn bộ ảnh
                                </div>
                            {% else %}
                                <div class="bg-secondary w-100 h-100 rounded-2" style="background-color: #C8C8C8 !important;"></div>
        {% endif %}
                        </div>
                        <div class="col-12 position-relative" style="height: 195px;">
                            {% if room.images and room.images|length > 2 %}
                                <img src="{{ url_for('static', filename=room.images[2].image_path) }}" 
                                     class="img-fluid w-100 h-100 rounded-2 side-image" 
                                     style="object-fit: cover; cursor: pointer;" 
                                     alt="Room image"
                                     onclick="showSingleImage('{{ url_for('static', filename=room.images[2].image_path) }}', 'Ảnh phụ 2')">
                                <div class="image-hover-simple">
                                    Click để xem toàn bộ ảnh
                                </div>
                                <div class="position-absolute bottom-0 end-0 p-2">
                                    <button class="btn btn-light btn-sm fw-bold" onclick="showAllImages()" style="font-size: 12px; padding: 4px 8px;">
                                        <i class="bi bi-grid-3x3-gap me-1"></i>
                                        Toàn bộ ảnh
                            </button>
                                </div>
                            {% else %}
                            <div class="bg-secondary w-100 h-100 rounded-2" style="background-color: #C8C8C8 !important;"></div>
                            {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Mô tả -->
    <div class="section-card">
        <h2 class="section-title">
            <i class="bi bi-info-circle"></i>
            Mô tả
        </h2>
        <p class="description-text mb-0">
            Hai căn phòng "đủ đầy" giữa lòng Quận 5 Bạn đang tìm một chốn dừng chân chill chill, tiện nghi và riêng tư giữa trung tâm Sài Gòn? Onyx và Solis tại Vitamin Homestay chính là lựa chọn không thể bỏ qua!
        </p>
    </div>

    <!-- Tiện nghi & Nội quy -->
    <div class="section-card">
    <div class="row">
            <!-- Tiện nghi -->
            <div class="col-md-6 border-end">
                <h2 class="section-title">
                    <i class="bi bi-house-check"></i>
                    Tiện nghi
                </h2>
                <div class="amenity-item">
                    <i class="bi bi-wifi"></i>
                    WiFi miễn phí
                </div>
                <div class="amenity-item">
                    <i class="bi bi-brush"></i>
                    Dọn phòng hàng ngày
                </div>
                <div class="amenity-item">
                    <i class="bi bi-droplet"></i>
                    Đồ vệ sinh cá nhân
                </div>
                <div class="amenity-item">
                    <i class="bi bi-p-square"></i>
                    Bãi đỗ xe
                </div>
                <div class="amenity-item mb-3">
                    <i class="bi bi-clock"></i>
                    Lễ tân 24/7
                </div>
                <button class="btn btn-outline-success btn-sm amenities-btn" onclick="showAmenitiesModal()">
                    <i class="bi bi-list-ul me-1"></i>
                    Xem tất cả tiện nghi
                </button>
            </div>

            <!-- Nội quy -->
            <div class="col-md-6">
                <h2 class="section-title">
                    <i class="bi bi-shield-check"></i>
                    Nội quy
                </h2>
                <div class="rule-item">
                    <i class="bi bi-x-circle"></i>
                    Không hút thuốc
                </div>
                <div class="rule-item">
                    <i class="bi bi-check-circle"></i>
                    Được phép hút thuốc
                </div>
                <div class="rule-item mb-3">
                    <i class="bi bi-x-circle"></i>
                    Hút thuốc ngoài ban công
                </div>
                <button class="btn btn-outline-success btn-sm rules-btn" onclick="showRulesModal()">
                    <i class="bi bi-list-ul me-1"></i>
                    Xem tất cả nội quy
                </button>
            </div>
        </div>
    </div>

    <!-- Địa điểm -->
    <div class="section-card">
        <h2 class="section-title">
            <i class="bi bi-geo-alt"></i>
            Địa điểm
        </h2>
                <div class="bg-light rounded-3 overflow-hidden position-relative" style="height: 400px;">
                    {% set district_full = room.district|title|replace('Quan', 'Quận ')|replace('Quận quan', 'Quận ') if room.district.lower().startswith('quan') else room.district %}
                    {% set city_full = 'Thành phố Hồ Chí Minh' if room.city.lower() == 'hcm' or room.city.lower() == 'ho chi minh' else ('Thành phố Hà Nội' if room.city.lower() == 'hn' or room.city.lower() == 'hanoi' else ('Thành phố Đà Nẵng' if room.city.lower() == 'dn' or room.city.lower() == 'da nang' else room.city)) %}
                    {% set map_address = room.address + ', ' + district_full + ', ' + city_full + ', Vietnam' %}
                    {% set encoded_map_address = map_address|urlencode %}
                    
                    <!-- Mapbox GL JS -->
                    <div id="map" style="width: 100%; height: 100%; border-radius: 12px;"></div>
                    
                    <!-- Nút mở trên Google Maps -->
                    <div class="position-absolute top-0 end-0 m-2" style="z-index: 1000;">
                        {% set directions_url = 'https://www.google.com/maps/search/?api=1&query=' + encoded_map_address %}
                        <a href="{{ directions_url }}" class="btn btn-light btn-sm shadow-sm" target="_blank" title="Mở trên Google Maps">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Mapbox GL CSS và JS -->
                <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
                <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
                
                <script>
                // Mapbox access token của bạn
                mapboxgl.accessToken = 'pk.eyJ1IjoiYmVja2Nvcm4iLCJhIjoiY21ib3k1ZXZyMXVmMjJtcXR2a2gxYjQwciJ9.nvLXNWoct7Cdc4BDJiQRzw';
        
        // Custom style cho popup
        const customPopupStyle = `
            .mapboxgl-popup {
                max-width: 300px !important;
            }
            .mapboxgl-popup-content {
                padding: 0 !important;
                border-radius: 12px !important;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
                overflow: hidden !important;
            }
            .mapboxgl-popup-close-button {
                padding: 8px !important;
                color: #666 !important;
                font-size: 20px !important;
                line-height: 14px !important;
                right: 4px !important;
                top: 4px !important;
                z-index: 10 !important;
            }
            .mapboxgl-popup-close-button:hover {
                background: none !important;
                color: #333 !important;
            }
            .custom-popup-header {
                background: #8bc34a;
                color: white;
                padding: 12px 15px;
                font-weight: 600;
                font-size: 16px;
                text-align: left;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }
            .custom-popup-content {
                padding: 15px;
                background: white;
            }
            .custom-popup-address {
                color: #666;
                font-size: 14px;
                margin-bottom: 12px;
                line-height: 1.4;
            }
            .custom-popup-actions {
                display: flex;
                gap: 8px;
            }
            .custom-popup-btn {
                flex: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                text-decoration: none;
                transition: all 0.2s ease;
            }
            .custom-popup-btn.primary {
                background: #8bc34a;
                color: white;
            }
            .custom-popup-btn.primary:hover {
                background: #7cb342;
            }
            .custom-popup-btn.secondary {
                background: #f8f9fa;
                color: #333;
                border: 1px solid #dee2e6;
            }
            .custom-popup-btn.secondary:hover {
                background: #e9ecef;
            }
            .custom-popup-btn i {
                margin-right: 6px;
            }
        `;

        // Thêm style vào head
        const styleElement = document.createElement('style');
        styleElement.textContent = customPopupStyle;
        document.head.appendChild(styleElement);
                
                // Tạo bản đồ Mapbox với style đẹp
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12', // Mapbox Streets style
                    center: [106.6297, 10.8231], // [lng, lat] for Mapbox
                    zoom: 13,
                    attributionControl: true,
            scrollZoom: false // Tắt scroll zoom mặc định
        });

        // Thêm event listener cho hover
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.addEventListener('mouseenter', () => {
                map.scrollZoom.enable(); // Bật scroll zoom khi hover
            });
            
            mapContainer.addEventListener('mouseleave', () => {
                map.scrollZoom.disable(); // Tắt scroll zoom khi không hover
                });
        }
                
                // Thêm controls đẹp
                map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
                map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
                
                // Geocoding với Mapbox Geocoding API (chính xác hơn)
                var address = "{{ map_address }}";
                var geocodeUrl = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' + encodeURIComponent(address) + '.json?access_token=' + mapboxgl.accessToken + '&country=vn&limit=1&types=address,poi';
                
                fetch(geocodeUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.features && data.features.length > 0) {
                            var coordinates = data.features[0].center; // [lng, lat]
                            var placeName = data.features[0].place_name;
                            
                            // Fly to location với animation mượt mà
                            map.flyTo({
                                center: coordinates,
                                zoom: 15,
                                duration: 2500,
                                essential: true
                            });
                            
                            // Tạo custom marker element
                            var markerEl = document.createElement('div');
                            markerEl.innerHTML = `
                                <div style="
                                    color: #8bc34a;
                                    font-size: 32px;
                                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                                    cursor: pointer;
                                ">
                                    <i class="bi bi-geo-alt-fill"></i>
                                </div>
                            `;
                            
                            // Thêm marker với popup đơn giản
                            var marker = new mapboxgl.Marker(markerEl)
                                .setLngLat(coordinates)
                                .setPopup(new mapboxgl.Popup({ 
                                    offset: 30,
                                    closeButton: true,
                                    closeOnClick: false
                                }).setHTML(`
                            <div>
                                <div class="custom-popup-header">
                                    {{ room.homestay.business_name }}
                                </div>
                                <div class="custom-popup-content">
                                    <div class="custom-popup-address">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        {{ room.address }}, {{ district_full }}, {{ city_full }}
                                    </div>
                                    <div class="custom-popup-actions">
                                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ encoded_map_address }}" 
                                           target="_blank" 
                                           class="custom-popup-btn primary">
                                            <i class="bi bi-signpost-2"></i>
                                            Chỉ đường
                                        </a>
                                        <a href="https://www.google.com/maps/search/?api=1&query={{ encoded_map_address }}" 
                                           target="_blank" 
                                           class="custom-popup-btn secondary">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                            Google Maps
                                        </a>
                                    </div>
                                </div>
                                    </div>
                                `))
                                .addTo(map);
                            
                            // Mở popup ngay lập tức
                            marker.getPopup().addTo(map);
                            
                            // Add some animation to marker
                            setTimeout(() => {
                                markerEl.style.animation = 'bounce 1s ease-in-out';
                            }, 2500);
                        }
                    })
                    .catch(error => {
                        console.log('Geocoding error, using fallback:', error);
                        // Fallback: hiển thị tọa độ mặc định
                        var fallbackCoords;
                        {% if room.city.lower() == 'hcm' or room.city.lower() == 'ho chi minh' %}
                            fallbackCoords = [106.6297, 10.8231];
                        {% elif room.city.lower() == 'hn' or room.city.lower() == 'hanoi' %}
                            fallbackCoords = [105.8542, 21.0285];
                        {% elif room.city.lower() == 'dn' or room.city.lower() == 'da nang' %}
                            fallbackCoords = [108.2068, 16.0471];
                        {% else %}
                            fallbackCoords = [106.6297, 10.8231];
                        {% endif %}
                        
                        map.flyTo({ center: fallbackCoords, zoom: 13 });
                        
                        var markerEl = document.createElement('div');
                        markerEl.innerHTML = `
                            <div style="
                                color: #8bc34a;
                                font-size: 32px;
                                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                                cursor: pointer;
                            ">
                                <i class="bi bi-geo-alt-fill"></i>
                            </div>
                        `;
                        
                        new mapboxgl.Marker(markerEl)
                            .setLngLat(fallbackCoords)
                            .setPopup(new mapboxgl.Popup({ offset: 30 })
                                .setHTML(`
                            <div>
                                <div class="custom-popup-header">
                                    {{ room.homestay.business_name }}
                                </div>
                                <div class="custom-popup-content">
                                    <div class="custom-popup-address">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        {{ room.address }}, {{ district_full }}, {{ city_full }}
                                    </div>
                                    <div class="custom-popup-actions">
                                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ encoded_map_address }}" 
                                           target="_blank" 
                                           class="custom-popup-btn primary">
                                            <i class="bi bi-signpost-2"></i>
                                            Chỉ đường
                                        </a>
                                        <a href="https://www.google.com/maps/search/?api=1&query={{ encoded_map_address }}" 
                                           target="_blank" 
                                           class="custom-popup-btn secondary">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                            Google Maps
                                        </a>
                                    </div>
                                </div>
                                    </div>
                                `))
                            .addTo(map);
                    });
                
                // Thêm CSS cho animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes bounce {
                        0%, 20%, 60%, 100% { transform: translateY(0) rotate(-45deg); }
                        40% { transform: translateY(-20px) rotate(-45deg); }
                        80% { transform: translateY(-10px) rotate(-45deg); }
                    }
                `;
                document.head.appendChild(style);
                </script>
    </div>
</div>

<!-- Modal hiển thị ảnh đơn lẻ -->
<div class="modal fade" id="singleImageModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true" style="z-index: 1070;" data-bs-focus="false">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90vw;">
        <div class="modal-content bg-transparent border-0" style="z-index: 1071;">
            <div class="modal-body p-0 text-center" data-bs-dismiss="modal" style="cursor: pointer;">
                <img id="singleImageDisplay" src="" class="img-fluid rounded-3" style="max-height: 90vh; max-width: 100%; object-fit: contain; pointer-events: none;" alt="Room image">
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị tất cả ảnh -->
<div class="modal fade" id="imageGalleryModal" tabindex="-1" aria-labelledby="imageGalleryModalLabel" aria-hidden="true" style="z-index: 1060;" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="z-index: 1061;">
            <div class="modal-header border-0">
                <div class="d-flex align-items-center">
                    <i class="bi bi-images me-2 fs-5" style="color: #8bc34a;"></i>
                    <h4 class="modal-title fw-bold mb-0" id="imageGalleryModalLabel">
                        Tất cả ảnh phòng
                        {% if room.images and room.images|length > 3 %}
                            <span class="text-muted fs-6 fw-normal">({{ room.images|length - 3 }} ảnh)</span>
                        {% endif %}
                    </h4>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    {% if room.images and room.images|length > 3 %}
                        {% for image in room.images[3:] %}
                            <div class="col-md-4">
                                <div class="position-relative" style="height: 250px;">
                                    <img src="{{ url_for('static', filename=image.image_path) }}" 
                                         class="img-fluid w-100 h-100 rounded gallery-img" 
                                         style="object-fit: cover; cursor: pointer;" 
                                         alt="Room image"
                                         data-image-src="{{ url_for('static', filename=image.image_path) }}">
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-images text-muted fs-1 mb-3"></i>
                            <p class="text-muted">Không có thêm ảnh để hiển thị</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị tất cả tiện nghi -->
<div class="modal fade" id="amenitiesModal" tabindex="-1" aria-labelledby="amenitiesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title fw-bold" id="amenitiesModalLabel">
                    <i class="bi bi-house-check me-2"></i>
                        Tất cả tiện nghi
                        {% if room.amenities %}
                            <span class="text-muted fs-6 fw-normal">({{ room.amenities|length }} tiện nghi)</span>
                        {% endif %}
                    </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                    {% if room.amenities %}
                    <div class="row g-4">
                        <!-- Tiện nghi phòng -->
                        {% set room_amenities = room.amenities|selectattr('amenity_category')|selectattr('amenity_category.code', 'equalto', 'room')|list %}
                        {% if room_amenities %}
                        <div class="col-12">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-house-door me-2" style="color: #8bc34a;"></i>
                                Tiện nghi phòng
                            </h5>
                            <div class="row g-2">
                                {% for amenity in room_amenities %}
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded amenity-badge">
                                            <i class="{{ amenity.icon or 'bi bi-check-circle' }} me-2"></i>
                                            <span class="amenity-text">{{ amenity.name }}</span>
                                </div>
                            </div>
                        {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Tiện nghi phổ biến -->
                        {% set common_amenities = room.amenities|selectattr('amenity_category')|selectattr('amenity_category.code', 'equalto', 'common')|list %}
                        {% if common_amenities %}
                        <div class="col-12">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-star me-2" style="color: #8bc34a;"></i>
                                Tiện nghi phổ biến
                            </h5>
                            <div class="row g-2">
                                {% for amenity in common_amenities %}
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded amenity-badge">
                                            <i class="{{ amenity.icon or 'bi bi-check-circle' }} me-2"></i>
                                            <span class="amenity-text">{{ amenity.name }}</span>
                                </div>
                            </div>
                        {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                        <!-- Tiện nghi độc đáo -->
                        {% set unique_amenities = room.amenities|selectattr('amenity_category')|selectattr('amenity_category.code', 'equalto', 'unique')|list %}
                        {% if unique_amenities %}
                        <div class="col-12">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-gem me-2" style="color: #8bc34a;"></i>
                                Tiện nghi độc đáo
                            </h5>
                            <div class="row g-2">
                                {% for amenity in unique_amenities %}
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded amenity-badge">
                                            <i class="{{ amenity.icon or 'bi bi-check-circle' }} me-2"></i>
                                            <span class="amenity-text">{{ amenity.name }}</span>
                </div>
            </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Fallback: Hiển thị tất cả tiện nghi nếu không có category hoặc category không hoạt động -->
                        {% set uncategorized_amenities = room.amenities|rejectattr('amenity_category')|list %}
                        {% if uncategorized_amenities or (not room_amenities and not common_amenities and not unique_amenities) %}
                        <div class="col-12">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-list-check me-2" style="color: #8bc34a;"></i>
                                Tất cả tiện nghi
                            </h5>
                            <div class="row g-2">
                                {% for amenity in room.amenities %}
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center p-2 rounded amenity-badge">
                                            <i class="{{ amenity.icon or 'bi bi-check-circle' }} me-2"></i>
                                            <span class="amenity-text">{{ amenity.name }}</span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-house-check text-muted fs-1 mb-3"></i>
                        <p class="text-muted">Chưa có thông tin tiện nghi cho phòng này</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị tất cả nội quy -->
<div class="modal fade" id="rulesModal" tabindex="-1" aria-labelledby="rulesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title fw-bold" id="rulesModalLabel">
                    <i class="bi bi-shield-check me-2"></i>
                        Tất cả nội quy
                        {% if room.rules %}
                            <span class="text-muted fs-6 fw-normal">({{ room.rules|length }} nội quy)</span>
                        {% endif %}
                    </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                    {% if room.rules %}
                    <div class="row g-4">
                        <!-- Nội quy chung -->
                            <div class="col-12">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-clock me-2" style="color: #8bc34a;"></i>
                                Nội quy chung
                            </h5>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-2 rounded rule-badge">
                                        <i class="bi bi-clock me-2"></i>
                                        <span class="rule-text">Giờ nhận phòng: 14:00 - Giờ trả phòng: 12:00</span>
                                </div>
                            </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-2 rounded rule-badge">
                                        <i class="bi bi-volume-mute me-2"></i>
                                        <span class="rule-text">Giữ yên lặng sau 22:00</span>
                            </div>
                        </div>
                            </div>
                        </div>

                        <!-- Nội quy khác -->
                        <div class="col-12">
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-info-circle me-2" style="color: #8bc34a;"></i>
                                Nội quy khác
                            </h5>
                            <div class="row g-2">
                                {% for rule in room.rules %}
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center p-2 rounded rule-badge">
                                            <i class="{{ rule.icon or 'bi bi-info-circle' }} me-2"></i>
                                            <span class="rule-text">{{ rule.name }}</span>
                            </div>
                        </div>
                                {% endfor %}
                </div>
            </div>
        </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-shield-check text-muted fs-1 mb-3"></i>
                        <p class="text-muted">Chưa có thông tin nội quy cho phòng này</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function showSingleImage(imageSrc, title) {
    document.getElementById('singleImageDisplay').src = imageSrc;
    
    // Làm mờ modal gallery
    var galleryModal = document.getElementById('imageGalleryModal');
    if (galleryModal) {
        galleryModal.style.filter = 'blur(3px)';
        galleryModal.style.opacity = '0.3';
    }
    
    var modal = new bootstrap.Modal(document.getElementById('singleImageModal'));
    modal.show();
    
    // Reset modal gallery khi đóng single image modal
    document.getElementById('singleImageModal').addEventListener('hidden.bs.modal', function() {
        if (galleryModal) {
            galleryModal.style.filter = 'none';
            galleryModal.style.opacity = '1';
        }
    });
}

function showAllImages() {
    var modal = new bootstrap.Modal(document.getElementById('imageGalleryModal'));
    modal.show();
}

function showAmenitiesModal() {
    var modal = new bootstrap.Modal(document.getElementById('amenitiesModal'));
    modal.show();
}

function showRulesModal() {
    var modal = new bootstrap.Modal(document.getElementById('rulesModal'));
    modal.show();
}

// Thêm event listener cho gallery images
document.addEventListener('DOMContentLoaded', function() {
    // Add click event to gallery images
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('gallery-img')) {
            var imageSrc = e.target.getAttribute('data-image-src');
            showSingleImage(imageSrc, 'Ảnh phòng');
        }
    });
});

// Header action buttons functionality
function shareRoom() {
    const roomTitle = "{{ room.homestay.business_name|e }}";
    const roomUrl = window.location.href;
    
    if (navigator.share) {
        // Web Share API (mobile)
        navigator.share({
            title: roomTitle,
            text: 'Xem homestay tuyệt vời này!',
            url: roomUrl
        }).catch(err => {
            console.log('Error sharing:', err);
            copyToClipboard(roomUrl);
        });
    } else {
        // Fallback: copy to clipboard
        copyToClipboard(roomUrl);
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        showToast('Đã sao chép link vào clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Đã sao chép link vào clipboard!', 'success');
    });
}

function toggleSaveRoom() {
    const saveBtn = document.getElementById('saveRoomBtn');
    const icon = saveBtn.querySelector('i');
    const text = saveBtn.querySelector('span');
    
    if (saveBtn.classList.contains('saved')) {
        // Remove from saved
        saveBtn.classList.remove('saved');
        saveBtn.classList.add('btn-outline-danger');
        icon.className = 'bi bi-heart';
        if (text) text.textContent = 'Lưu';
        showToast('Đã bỏ lưu homestay!', 'info');
    } else {
        // Add to saved
        saveBtn.classList.add('saved');
        saveBtn.classList.remove('btn-outline-danger');
        icon.className = 'bi bi-heart-fill';
        if (text) text.textContent = 'Đã lưu';
        showToast('Đã lưu homestay!', 'success');
    }
}

function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    
    bsToast.show();
    
    // Remove toast element after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}