{% extends 'base.html' %}
{% block title %}<span data-translate="add-room">Thêm phòng mới</span>{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="add-room-wizard">


                <div class="wizard-layout">
            <!-- Sidebar Steps -->
            <div class="steps-sidebar">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Thông tin cơ bản</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Thông tin chi tiết</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Thêm hình ảnh và giá</div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="wizard-content">
                <form method="post" enctype="multipart/form-data" class="wizard-form" onsubmit="prepareFormData()">
            <!-- Hidden inputs for counter values -->
            <input type="hidden" name="bathroom_count" id="bathroom_count_input" value="2">
            <input type="hidden" name="bed_count" id="bed_count_input" value="1">
            <input type="hidden" name="guest_count" id="guest_count_input" value="1">
            <!-- Step 1: Basic Information -->
            <div class="step-content active" id="step-1">
                <div class="form-section">
                    <h3>Tiêu đề phòng</h3>
                    <div class="form-content">
                        <input type="text" name="room_title" placeholder="Thêm tiêu đề" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Mô tả phòng</h3>
                    <div class="form-content">
                        <div class="textarea-container">
                            <textarea name="room_description" placeholder="Thêm miêu tả homestay" class="form-textarea" required></textarea>
                            <div class="char-count">0/500</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Mô hình Phòng</h3>
                    <div class="form-content">
                        <div class="property-type-selection">
                            <div class="property-option">
                                <input type="radio" id="house" name="property_type" value="house" class="property-radio">
                                <label for="house" class="property-label">
                                    <div class="property-icon">
                                        <i class="bi bi-house-door"></i>
                                    </div>
                                    <div class="property-text">Nhà</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="apartment" name="property_type" value="apartment" class="property-radio">
                                <label for="apartment" class="property-label">
                                    <div class="property-icon">
                                        <i class="bi bi-building"></i>
                                    </div>
                                    <div class="property-text">Căn hộ</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="hotel" name="property_type" value="hotel" class="property-radio">
                                <label for="hotel" class="property-label">
                                    <div class="property-icon">
                                        <i class="bi bi-building-fill"></i>
                                    </div>
                                    <div class="property-text">Khách sạn</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Địa chỉ phòng</h3>
                    <div class="form-content">
                        <div class="location-inputs">
                            <select name="province" id="provinceSelect" class="form-select" onchange="updateDistricts()">
                                <option value="" disabled selected>Tỉnh/Thành phố</option>
                                <option value="hcm">TP. Hồ Chí Minh</option>
                                <option value="hanoi">Hà Nội</option>
                            </select>
                            <select name="district" id="districtSelect" class="form-select" onchange="updateWards()" disabled>
                                <option value="" disabled selected>Quận/Huyện</option>
                            </select>
                            <select name="ward" id="wardSelect" class="form-select" disabled>
                                <option value="" disabled selected>Phường/Xã</option>
                            </select>
                            <input type="text" name="street" class="form-input" placeholder="Tên đường, số nhà/tòa nhà" required>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="goBack()">Quay lại</button>
                    <button type="button" class="btn-primary" onclick="nextStep()">Tiếp theo</button>
                </div>
            </div>

            <!-- Step 2: Detailed Information -->
            <div class="step-content" id="step-2">
                <div class="form-section">
                    <h3>Sức chứa của phòng</h3>
                    <div class="form-content">
                        <div class="room-details">
                            <div class="detail-row">
                                <span>Số lượng phòng tắm trong phòng</span>
                                <div class="counter">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('bathroom')">-</button>
                                    <span id="bathroom-count">2</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('bathroom')">+</button>
                                </div>
                            </div>
                            <div class="detail-row">
                                <span>Số lượng giường trong phòng</span>
                                <div class="counter">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('bed')">-</button>
                                    <span id="bed-count">1</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('bed')">+</button>
                                </div>
                            </div>
                            <div class="detail-row">
                                <span>Số lượng khách tối đa</span>
                                <div class="counter">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('guest')">-</button>
                                    <span id="guest-count">1</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('guest')">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Nội quy tại phòng</h3>
                    <div class="form-content">
                        <div class="rules-row">
                            <div class="selected-rules" id="selectedRules">
                                <!-- Selected rules will appear here -->
                            </div>
                            <button type="button" class="add-rule-btn" onclick="showRulesModal()">
                                <i class="bi bi-plus-circle"></i>
                                <span>Thêm nội quy</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Hình thức cho thuê</h3>
                    <div class="form-content">
                        <div class="rental-type-selection">
                            <div class="rental-option">
                                <input type="radio" id="hourly" name="rental_type" value="hourly" class="rental-radio">
                                <label for="hourly" class="rental-label">
                                    <i class="rental-icon bi bi-clock"></i>
                                    <span class="rental-text">Theo giờ</span>
                                </label>
                            </div>
                            <div class="rental-option">
                                <input type="radio" id="nightly" name="rental_type" value="nightly" class="rental-radio">
                                <label for="nightly" class="rental-label">
                                    <i class="rental-icon bi bi-moon"></i>
                                    <span class="rental-text">Qua đêm</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                                <div class="form-section">
                    <h3>Thêm tiện nghi</h3>
                    <div class="form-content">
                        <div class="amenities-row">
                            <div class="selected-amenities" id="selectedAmenities">
                                <!-- Selected amenities will appear here -->
                            </div>
                            <button type="button" class="add-amenity-btn" onclick="showAmenityModal()">
                                <i class="bi bi-plus-circle"></i>
                                <span>Thêm tiện nghi</span>
                            </button>
                        </div>
                        <!-- Hidden inputs cho selected amenities -->
                        <div id="amenityInputs"></div>
                    </div>
  </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="prevStep()">Quay lại</button>
                    <button type="button" class="btn-primary" onclick="nextStep()">Tiếp theo</button>
                </div>
  </div>

            <!-- Step 3: Images and Pricing -->
            <div class="step-content" id="step-3">
                                <div class="form-section">
                    <h3>Thêm ảnh phòng</h3>
                    <div class="form-content">
                        <div class="upload-grid">
                            <div class="upload-item main-upload">
                                <span>Ảnh bìa</span>
                                <input type="file" id="main-image" name="main_image" accept="image/*">
                                <div class="upload-placeholder">
                                    <i class="icon-camera"></i>
                                    <span>Chọn ảnh</span>
                                </div>
                            </div>
                            <div class="upload-item">
                                <input type="file" name="images[]" accept="image/*" multiple>
                                <div class="upload-placeholder">
                                    <i class="icon-camera"></i>
                                </div>
                            </div>
                            <div class="upload-item">
                                <input type="file" name="images[]" accept="image/*" multiple>
                                <div class="upload-placeholder">
                                    <i class="icon-camera"></i>
                                </div>
                            </div>
                            <div class="upload-item">
                                <input type="file" name="images[]" accept="image/*" multiple>
                                <div class="upload-placeholder">
                                    <i class="icon-camera"></i>
                                </div>
                            </div>
                            <div class="upload-item">
                                <input type="file" name="images[]" accept="image/*" multiple>
                                <div class="upload-placeholder">
                                    <i class="icon-camera"></i>
                                </div>
                            </div>
                            <div class="upload-item add-more">
                                <div class="upload-placeholder">
                                    <i class="icon-plus"></i>
                                    <span>Thêm ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>
  </div>

                                <div class="form-section">
                    <h3>Thêm giá dịch vụ</h3>
                    <div class="form-content">
                        <div class="pricing-section">
                            <div class="pricing-option">
                                <h4>Theo giờ</h4>
                                <p>Giá thuê theo giờ với giá gốc homestay ban đầu từ 50.000đ</p>
                                <div class="price-input">
                                    <span class="currency">VND</span>
                                    <input type="number" name="hourly_price" placeholder="Gợi ý 200.000đ" class="price-field">
                                </div>
                            </div>
                            <div class="pricing-option">
                                <h4>Theo đêm</h4>
                                <p>Giá thuê theo đêm với giá gốc homestay ban đầu từ 400.000đ</p>
                                <div class="price-input">
                                    <span class="currency">VND</span>
                                    <input type="number" name="nightly_price" placeholder="Gợi ý 400.000đ" class="price-field">
                                </div>
                            </div>
                        </div>
                    </div>
  </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="prevStep()">Quay lại</button>
                    <button type="submit" class="btn-primary">Hoàn thành</button>
                </div>
            </div>
        </form>
  </div>

        <!-- Amenity Modal -->
    <div id="amenityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-content">
                    <div class="header-title">
                        <i class="bi bi-star-fill me-3"></i>
                        <div>
                            <h3>Chọn tiện nghi cho phòng</h3>
                            <p class="header-subtitle">Thêm các tiện nghi để thu hút khách hàng</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <div class="amenity-categories">
                    <div class="amenity-sections">
                        <!-- Amenity sections will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-content">
                    <div class="header-title">
                        <i class="bi bi-shield-check me-3"></i>
                        <div>
                            <h3>Chọn nội quy cho phòng</h3>
                            <p class="header-subtitle">Thiết lập các quy định để đảm bảo trải nghiệm tốt nhất</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <div class="rules-categories">
                    <div class="rules-sections">
                        <div class="rule-section" data-category="smoking">
                            <h4 class="section-title">
                                <i class="bi bi-sign-no-smoking-fill me-2"></i>Hút thuốc
                            </h4>
                            <div class="rules-grid" id="smokingRules">
                                <!-- Smoking rules will be loaded here -->
                            </div>
                        </div>

                        <div class="rule-section" data-category="pets">
                            <h4 class="section-title">
                                <i class="bi bi-heart-fill me-2"></i>Thú cưng
                            </h4>
                            <div class="rules-grid" id="petsRules">
                                <!-- Pet rules will be loaded here -->
                            </div>
                        </div>

                        <div class="rule-section" data-category="children">
                            <h4 class="section-title">
                                <i class="bi bi-people-fill me-2"></i>Trẻ em
                            </h4>
                            <div class="rules-grid" id="childrenRules">
                                <!-- Children rules will be loaded here -->
                            </div>
                        </div>

                        <div class="rule-section" data-category="party">
                            <h4 class="section-title">
                                <i class="bi bi-music-note-beamed me-2"></i>Tiệc tùng
                            </h4>
                            <div class="rules-grid" id="partyRules">
                                <!-- Party rules will be loaded here -->
                            </div>
                        </div>

                        <div class="rule-section" data-category="time">
                            <h4 class="section-title">
                                <i class="bi bi-clock-fill me-2"></i>Thời gian
                            </h4>
                            <div class="rules-grid" id="timeRules">
                                <!-- Time rules will be loaded here -->
                            </div>
                        </div>

                        <div class="rule-section" data-category="behavior">
                            <h4 class="section-title">
                                <i class="bi bi-person-check-fill me-2"></i>Hành vi
                            </h4>
                            <div class="rules-grid" id="behaviorRules">
                                <!-- Behavior rules will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
  </div>

<style>
.add-room-wizard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px 20px;
    background: transparent;
    height: calc(100vh - 70px); /* 70px là chiều cao header */
    overflow: hidden;
}
body.add-room-no-scroll, html.add-room-no-scroll {
    overflow: hidden;
    height: 100vh;
    position: fixed;
    width: 100%;
}

.wizard-layout {
    display: flex;
    gap: 30px;
    align-items: flex-start;
    height: calc(100vh - 20px);
}

.steps-sidebar {
    flex: 0 0 250px;
    background: transparent;
    padding: 20px;
    height: 100%;
}

.steps-sidebar .step {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0.5;
    position: relative;
}

/* .steps-sidebar .step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 32px;
    top: 50px;
    width: 2px;
    height: 40px;
    background: #ddd;
    z-index: 0;
} */

.steps-sidebar .step.active {
    opacity: 3;
}

.steps-sidebar .step.active:not(:last-child)::after {
    background: #9ed649;
}

.step-number {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: #ddd;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    flex-shrink: 0;
    position: relative;
    z-index: 0;
}

.step.active .step-number {
    background: #9ed649;
}

.step-title {
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.wizard-content {
    flex: 1;
    height: 100%;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #9ed649 #f1f1f1;
    margin-top: -35px;
}

.wizard-content::-webkit-scrollbar {
    width: 8px;
}

.wizard-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.wizard-content::-webkit-scrollbar-thumb {
    background: #9ed649;
    border-radius: 4px;
}

.wizard-content::-webkit-scrollbar-thumb:hover {
    background: #8bc441;
}

.wizard-form {
    background: transparent;
    border-radius: 12px;
    padding: 25px;
    box-shadow: none;
    height: 100%;
    overflow-y: auto;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.form-section {
    margin-bottom: 12px;
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e5e5;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    margin-bottom: 0;
    color: #333;
    font-size: 14px;
    flex: 0 0 130px;
    padding-top: 5px;
    line-height: 1.3;
    white-space: nowrap;
}

.rules-row {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    flex-wrap: wrap;
}


.selected-rules {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    flex: 1;
    margin-left:25px;
}

.selected-rule-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f0f9e8;
    border: 1px solid #9ed649;
    border-radius: 6px;
    font-size: 14px;
    color: #2d5a2d;
}

.selected-rule-item .remove-rule {
    color: #dc3545;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    padding: 0 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.selected-rule-item .remove-rule:hover {
    background: #dc3545;
    color: white;
}

.more-rules-badge {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: #e9ecef;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.more-rules-badge:hover {
    background: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.add-rule-btn {
    background: transparent;
    color: #333;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.add-rule-btn:hover {
    color: #9ed649;
}

/* Amenities Row Styles - tương tự như Rules */
.amenities-row {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    flex-wrap: wrap;
}

.selected-amenities {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    flex: 1;
    margin-left: 25px;
}

.add-amenity-btn {
    background: transparent;
    color: #333;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.add-amenity-btn:hover {
    color: #9ed649;
}

.form-section .form-content {
    flex: 1;
    background: transparent;
}



.form-input, .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 13px;
}

.form-textarea {
    height: 80px;
    resize: vertical;
}

.textarea-container {
    position: relative;
}

.char-count {
    position: absolute;
    bottom: 8px;
    right: 12px;
    font-size: 11px;
    color: #000000;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 4px;
    border-radius: 3px;
}

.room-specs {
    display: flex;
    gap: 12px;
}

.spec-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}

.spec-item:hover {
    border-color: #9ed649;
}

.location-inputs {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.form-select {
    padding: 8px 12px;
    /* border: 1px solid #ddd; */
    border-radius: 6px;
    /* background: white; */
    font-size: 13px;
}

.room-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: transparent;
    margin-top: -20px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #a7a3a3;
    font-size: 13px;
}

.counter {
    display: flex;
    align-items: center;
    gap: 8px;
}

.counter-btn {
    width: 24px;
    height: 24px;
    border: 1px solid #ddd;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
}

.counter-btn:hover {
    background: #f5f5f5;
}

.rules-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.rule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 13px;
}

.toggle-switch {
    position: relative;
    width: 44px;
    height: 22px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-switch label {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    border-radius: 25px;
    transition: 0.4s;
}

.toggle-switch label:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.4s;
}

.toggle-switch input:checked + label {
    background-color: #9ed649;
}

.toggle-switch input:checked + label:before {
    transform: translateX(22px);
}

.amenities-section {
    display: flex;
    gap: 12px;
}

.amenity-category {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}





.upload-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.upload-item {
    position: relative;
    aspect-ratio: 1;
    border: 2px dashed #ddd;
    border-radius: 6px;
    overflow: hidden;
}

.upload-item.main-upload {
    grid-column: span 2;
    grid-row: span 2;
}

.upload-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
}

.upload-item input[type="file"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.upload-item.add-more {
    background: #f9f9f9;
    border-color: #9ed649;
}

.pricing-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.pricing-option {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.pricing-option h4 {
    margin-bottom: 6px;
    color: #333;
    font-size: 15px;
}

.pricing-option p {
    margin-bottom: 12px;
    color: #666;
    font-size: 13px;
}

.price-input {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 6px;
    overflow: hidden;
}

.currency {
    padding: 8px 12px;
    background: #f5f5f5;
    border-right: 1px solid #ddd;
    font-weight: 500;
    font-size: 13px;
}

.price-field {
    flex: 1;
    padding: 8px 12px;
    border: none;
    outline: none;
    font-size: 13px;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 25px;
}

.btn-secondary, .btn-primary {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.2s ease;
}

.btn-secondary {
    background: white;
    color: #030303;
    border-color: #000000;
}

.btn-secondary:hover {
    background: #d6f2c3;
    border-color: #bbb;
}

.btn-primary {
    background: #9ed649;
    color: rgb(0, 0, 0);
    border-color: #000000;
}

.btn-primary:hover {
    background: #8bc441;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    position: fixed;
    top: 70px;
    right: 0;
    transform: none;
    background: white;
    border-radius: 12px 0 0 12px;
    padding: 30px;
    max-width: 700px;
    width: 650px;
    height: calc(100vh - 70px);
    overflow-y: auto;
    box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #9ed649;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #8bc441;
}



.modal-header {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 15px 0;
    margin: -30px -30px 15px -30px;
    padding-left: 30px;
    padding-right: 30px;
    border-bottom: 1px solid #e5e5e5;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-title i {
    font-size: 24px;
    color: #9ed649;
}

.header-title h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
    font-weight: 600;
    line-height: 1.2;
}

.header-subtitle {
    margin: 2px 0 0 0;
    color: #666;
    font-size: 12px;
    font-weight: 400;
    line-height: 1.3;
}



.rules-sections {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.rule-section {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 20px;
    background: #fafafa;
}

.section-title {
    color: #333;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #9ed649;
    display: flex;
    align-items: center;
}

.section-title i {
    color: #9ed649;
}

.rules-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}

.rule-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.rule-item:hover {
    border-color: #9ed649;
    background: #f8fff0;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(158, 214, 73, 0.15);
}

.rule-item.selected {
    background: #e8f5e8;
    border-color: #9ed649;
    box-shadow: 0 2px 6px rgba(158, 214, 73, 0.25);
}

.rule-item.selected::before {
    content: "✓";
    position: absolute;
    right: 12px;
    color: #9ed649;
    font-weight: bold;
    font-size: 16px;
}

.rule-text {
    font-size: 14px;
    color: #333;
    transition: all 0.2s ease;
    flex: 1;
}

.rule-item.selected .rule-text {
    color: #2d5a2d;
    font-weight: 500;
}

.no-rules-text {
    color: #666;
    font-style: italic;
    text-align: center;
    padding: 20px;
    margin: 0;
}

/* Amenity Modal specific styles */
.amenity-sections {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.amenity-section {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 20px;
    background: #fafafa;
}

.amenity-section .section-title {
    color: #333;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #9ed649;
    display: flex;
    align-items: center;
}

.amenity-section .section-title i {
    color: #9ed649;
}

.amenities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

.amenity-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    position: relative;
}

.amenity-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #9ed649;
}

.amenity-item.selected {
    background-color: #e8f5e8;
    border-color: #9ed649;
}

.amenity-item.selected::after {
    content: '✔';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ed649;
    font-weight: bold;
    font-size: 16px;
}

.amenity-item i {
    font-size: 18px;
    color: #9ed649;
    min-width: 20px;
    margin-right: 10px;
}

.amenity-text {
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

.no-amenities-text {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 40px 20px;
}

/* Selected amenity items - tương tự như selected rule items */
.selected-amenity-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f0f9e8;
    border: 1px solid #9ed649;
    border-radius: 6px;
    font-size: 14px;
    color: #2d5a2d;
}

.selected-amenity-item .remove-amenity {
    color: #817d7d;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    padding: 0 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.selected-amenity-item .remove-amenity:hover {
    background: #9ed649;
    color: white;
}

.more-amenities-badge {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: #e9ecef;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.more-amenities-badge:hover {
    background: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.amenity-item input[type="checkbox"] {
    margin: 0;
}

/* Property Type Selection Styles */
.property-type-selection {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 8px;
    max-width: 450px;
    margin-left: 0;
}

.property-option {
    position: relative;
}

.property-radio {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.property-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    background-color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 70px;
    text-align: center;
}

.property-label:hover {
    border-color: #9ed649;
    background-color: #f8fff0;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(158, 214, 73, 0.2);
}

.property-icon {
    margin-bottom: 4px;
    font-size: 20px;
    color: #666;
    transition: color 0.3s ease;
}

.property-text {
    font-size: 12px;
    font-weight: 500;
    color: #333;
    transition: color 0.3s ease;
}

.property-radio:checked + .property-label {
    border-color: #9ed649;
    background-color: #f0f9e8;
    box-shadow: 0 2px 8px rgba(158, 214, 73, 0.3);
}

.property-radio:checked + .property-label .property-icon {
    color: #9ed649;
}

.property-radio:checked + .property-label .property-text {
    color: #9ed649;
    font-weight: 600;
}

/* Hide disabled options in dropdown */
.form-select option:disabled {
    display: none !important;
}

/* Placeholder styling for select elements */
.form-select {
    color: #6c757d; /* Màu mờ cho placeholder */
}

.form-select:focus {
    color: #333; /* Màu đậm khi focus */
}

.form-select option {
    color: #333; /* Màu đậm cho các option thật */
}

/* Styling khi có option được chọn */
.form-select:valid {
    color: #333;
}

/* Rental Type Selection Styles */
.rental-type-selection {
    display: flex;
    gap: 15px;
    margin-top: 5px;
    margin-left: 20px;
}

.rental-option {
    position: relative;
}

.rental-radio {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.rental-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 13px;
    min-width: 100px;
    justify-content: center;
}

.rental-label:hover {
    border-color: #9ed649;
    background-color: #f8fff0;
}

.rental-icon {
    font-size: 16px;
    color: #666;
}

.rental-text {
    font-weight: 500;
    color: #333;
}

.rental-radio:checked + .rental-label {
    border-color: #9ed649;
    background-color: #f0f9e8;
    box-shadow: 0 1px 4px rgba(158, 214, 73, 0.3);
}

.rental-radio:checked + .rental-label .rental-text {
    color: #9ed649;
    font-weight: 600;
}

/* Rules Section Styles */
.selected-rules {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
    min-height: 40px;
    padding: 8px 0;
}

.selected-rule-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f0f9e8;
    border: 1px solid #9ed649;
    border-radius: 6px;
    font-size: 14px;
    color: #2d5a2d;
}



.selected-rule-item .remove-rule {
    color: #817d7d;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    padding: 0 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.selected-rule-item .remove-rule:hover {
    background: #dc3545;
    color: white;
}

.add-rule-btn {
    padding: 8px 16px;
    border: 2px dashed #ddd;
    border-radius: 6px;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #666;
    transition: all 0.3s ease;
}

.add-rule-btn i {
    font-size: 16px;
}

/* Rules Modal Styles */
.rules-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 15px;
}

.rule-option {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    text-align: center;
    min-height: 45px;
}

.rule-option:hover {
    border-color: #9ed649;
    background: #f8fff0;
}

.rule-option.selected {
    border-color: #9ed649;
    background: #9ed649;
    color: white;
}

.rule-option input[type="checkbox"] {
    display: none;
}

.rule-option .rule-name {
    font-weight: 500;
    color: #333;
    font-size: 13px;
    line-height: 1.3;
}

.rule-option.selected .rule-name {
    color: white;
}

.modal-footer {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

/* Responsive Design */
@media (max-width: 768px) {
    .property-type-selection {
        grid-template-columns: 1fr;
        gap: 12px;
        max-width: 280px;
    }
    
    .property-label {
        padding: 10px 8px;
        min-height: 60px;
    }
    
    .property-icon {
        font-size: 18px;
    }
    
    .property-text {
        font-size: 11px;
    }
}
</style>

<script>
let currentStep = 1;
const totalSteps = 3;

// Ngăn cuộn trang khi tải trang và load dữ liệu địa chỉ
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('add-room-no-scroll');
    document.documentElement.classList.add('add-room-no-scroll');
    
    // Load dữ liệu từ API
    loadLocationData();
    loadRulesData();
    loadAmenitiesData();
    updateSelectedAmenitiesDisplay();
});

// Cho phép cuộn trở lại khi rời khỏi trang
window.addEventListener('beforeunload', function() {
    document.body.classList.remove('add-room-no-scroll');
    document.documentElement.classList.remove('add-room-no-scroll');
});

function nextStep() {
    if (currentStep < totalSteps) {
        // Hide current step
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
        
        currentStep++;
        
        // Show next step
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
    }
}

function prevStep() {
    if (currentStep > 1) {
        // Hide current step
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
        
        currentStep--;
        
        // Show previous step
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
    }
}

function goBack() {
    // Cho phép cuộn trở lại trước khi rời khỏi trang
    document.body.classList.remove('add-room-no-scroll');
    document.documentElement.classList.remove('add-room-no-scroll');
    window.history.back();
}

function increaseCount(type) {
    const element = document.getElementById(`${type}-count`);
    let count = parseInt(element.textContent);
    count++;
    element.textContent = count;
    // Update hidden input
    document.getElementById(`${type}_count_input`).value = count;
}

function decreaseCount(type) {
    const element = document.getElementById(`${type}-count`);
    let count = parseInt(element.textContent);
    if (count > 1) {
        count--;
        element.textContent = count;
        // Update hidden input
        document.getElementById(`${type}_count_input`).value = count;
    }
}

function prepareFormData() {
    // Make sure all counter values are updated in hidden inputs
    const bathroomCount = document.getElementById('bathroom-count').textContent;
    const bedCount = document.getElementById('bed-count').textContent;
    const guestCount = document.getElementById('guest-count').textContent;
    
    document.getElementById('bathroom_count_input').value = bathroomCount;
    document.getElementById('bed_count_input').value = bedCount;
    document.getElementById('guest_count_input').value = guestCount;
    
    return true;
}

function showAmenityModal() {
    document.getElementById('amenityModal').style.display = 'block';
    // Đảm bảo body vẫn không cuộn được khi modal mở
    document.body.classList.add('add-room-no-scroll');
    document.documentElement.classList.add('add-room-no-scroll');
    
    // Load amenities cho tất cả categories
    loadAllAmenities();
}

function closeAmenityModal() {
    document.getElementById('amenityModal').style.display = 'none';
    // Giữ nguyên trạng thái không cuộn của trang chính
    document.body.classList.add('add-room-no-scroll');
    document.documentElement.classList.add('add-room-no-scroll');
}

function loadAllAmenities() {
    const amenitySections = document.querySelector('.amenity-sections');
    amenitySections.innerHTML = '';
    
    if (!amenitiesData) {
        amenitySections.innerHTML = '<p class="no-amenities-text">Đang tải dữ liệu tiện nghi...</p>';
        return;
    }
    
    // Tạo section cho mỗi category
    Object.keys(amenitiesData).forEach(categoryCode => {
        const categoryData = amenitiesData[categoryCode];
        const categoryInfo = categoryData.category_info;
        const amenities = categoryData.amenities;
        
        const sectionElement = document.createElement('div');
        sectionElement.className = 'amenity-section';
        sectionElement.setAttribute('data-category', categoryCode);
        
        sectionElement.innerHTML = `
            <h4 class="section-title">
                <i class="${categoryInfo.icon} me-2"></i>${categoryInfo.name}
            </h4>
            <div class="amenities-grid" id="${categoryCode}Amenities">
                ${amenities.map(amenity => `
                    <div class="amenity-item ${selectedAmenities.some(a => a.id === amenity.id) ? 'selected' : ''}" data-amenity-id="${amenity.id}">
                        <i class="${amenity.icon}"></i>
                        <span class="amenity-text">${amenity.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        amenitySections.appendChild(sectionElement);
        
        // Thêm event listeners cho amenity items
        const amenityItems = sectionElement.querySelectorAll('.amenity-item');
        amenityItems.forEach(item => {
            item.addEventListener('click', function() {
                const amenityId = parseInt(this.getAttribute('data-amenity-id'));
                const amenity = amenities.find(a => a.id === amenityId);
                const isCurrentlySelected = this.classList.contains('selected');
                
                toggleAmenitySelection(amenity, !isCurrentlySelected);
                
                // Cập nhật visual state
                if (!isCurrentlySelected) {
                    this.classList.add('selected');
                } else {
                    this.classList.remove('selected');
                }
            });
        });
    });
}

function toggleAmenitySelection(amenity, isSelected) {
    const existingIndex = selectedAmenities.findIndex(a => a.id === amenity.id);
    
    if (isSelected && existingIndex === -1) {
        selectedAmenities.push(amenity);
    } else if (!isSelected && existingIndex > -1) {
        selectedAmenities.splice(existingIndex, 1);
    }
    
    updateSelectedAmenitiesDisplay();
    console.log('Selected amenities:', selectedAmenities);
}

function updateSelectedAmenitiesDisplay() {
    const container = document.getElementById('selectedAmenities');
    const inputsContainer = document.getElementById('amenityInputs');
    
    // Clear existing content
    container.innerHTML = '';
    inputsContainer.innerHTML = '';
    
    if (selectedAmenities.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Chưa chọn tiện nghi nào</p>';
        return;
    }
    
    const maxDisplayAmenities = 4;
    const displayedAmenities = selectedAmenities.slice(0, maxDisplayAmenities);
    const hiddenCount = selectedAmenities.length - maxDisplayAmenities;
    
    // Hiển thị các amenity đầu tiên
    displayedAmenities.forEach(amenity => {
        const amenityElement = document.createElement('div');
        amenityElement.className = 'selected-amenity-item';
        amenityElement.innerHTML = `
            <span>${amenity.name}</span>
            <span class="remove-amenity" onclick="removeAmenity(${amenity.id})">&times;</span>
        `;
        container.appendChild(amenityElement);
    });
    
    // Hiển thị badge "+X tiện nghi khác" nếu có nhiều hơn maxDisplayAmenities
    if (hiddenCount > 0) {
        const moreElement = document.createElement('div');
        moreElement.className = 'more-amenities-badge';
        moreElement.innerHTML = `+${hiddenCount} tiện nghi khác`;
        moreElement.onclick = () => showAmenityModal(); // Click để mở modal
        container.appendChild(moreElement);
    }
    
    // Thêm hidden inputs cho tất cả amenities
    selectedAmenities.forEach(amenity => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'amenities[]';
        hiddenInput.value = amenity.id;
        inputsContainer.appendChild(hiddenInput);
    });
}

function removeAmenity(amenityId) {
    selectedAmenities = selectedAmenities.filter(a => a.id !== amenityId);
    updateSelectedAmenitiesDisplay();
    
    // Update modal display if open
    const modalItem = document.querySelector(`[data-amenity-id="${amenityId}"]`);
    if (modalItem) {
        modalItem.classList.remove('selected');
    }
}

// Biến global để lưu dữ liệu từ API
let locationData = null;
let rulesData = null;
let amenitiesData = null;
let selectedRules = [];
let selectedAmenities = [];
let currentRuleCategory = 'smoking';

// Load dữ liệu địa chỉ từ API khi trang load
async function loadLocationData() {
    try {
        const response = await fetch('/api/locations/all');
        const result = await response.json();
        
        if (result.success) {
            locationData = result.data;
            console.log('Đã load dữ liệu địa chỉ từ API');
        } else {
            console.error('Lỗi khi load dữ liệu địa chỉ:', result.message);
        }
    } catch (error) {
        console.error('Lỗi kết nối API:', error);
    }
}

// Load dữ liệu nội quy từ API
async function loadRulesData() {
    try {
        const response = await fetch('/api/rules');
        const result = await response.json();
        
        if (result.success) {
            rulesData = result.data;
            console.log('Đã load dữ liệu nội quy từ API');
        } else {
            console.error('Lỗi khi load dữ liệu nội quy:', result.message);
        }
    } catch (error) {
        console.error('Lỗi kết nối API nội quy:', error);
    }
}

// Load dữ liệu tiện nghi từ API
async function loadAmenitiesData() {
    try {
        const response = await fetch('/api/amenities');
        const result = await response.json();
        
        if (result.success) {
            amenitiesData = result.data;
            console.log('Đã load dữ liệu tiện nghi từ API');
        } else {
            console.error('Lỗi khi load dữ liệu tiện nghi:', result.message);
        }
    } catch (error) {
        console.error('Lỗi kết nối API tiện nghi:', error);
    }
}

function updateDistricts() {
    const provinceSelect = document.getElementById('provinceSelect');
    const districtSelect = document.getElementById('districtSelect');
    const wardSelect = document.getElementById('wardSelect');
    
    // Reset districts and wards
    districtSelect.innerHTML = '<option value="" disabled selected>Quận/Huyện</option>';
    wardSelect.innerHTML = '<option value="" disabled selected>Phường/Xã</option>';
    wardSelect.disabled = true;
    
    const selectedProvince = provinceSelect.value;
    
    if (selectedProvince && locationData && locationData[selectedProvince]) {
        // Enable district dropdown
        districtSelect.disabled = false;
        
        // Populate districts với sắp xếp theo thứ tự
        const districts = locationData[selectedProvince].districts;
        const sortedDistricts = Object.entries(districts).sort((a, b) => {
            const nameA = a[1].name;
            const nameB = b[1].name;
            
            // Tách số ra khỏi tên (ví dụ: "Quận 1" -> 1)
            const getNumber = (name) => {
                const match = name.match(/(\d+)/);
                return match ? parseInt(match[1]) : 999; // 999 cho các quận không có số
            };
            
            const numA = getNumber(nameA);
            const numB = getNumber(nameB);
            
            // Nếu cả hai đều có số, sắp xếp theo số
            if (numA !== 999 && numB !== 999) {
                return numA - numB;
            }
            
            // Nếu một trong hai không có số, sắp xếp theo alphabet
            return nameA.localeCompare(nameB, 'vi');
        });
        
        sortedDistricts.forEach(([key, district]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = district.name;
            districtSelect.appendChild(option);
        });
    } else {
        districtSelect.disabled = true;
    }
}

function updateWards() {
    const provinceSelect = document.getElementById('provinceSelect');
    const districtSelect = document.getElementById('districtSelect');
    const wardSelect = document.getElementById('wardSelect');
    
    // Reset wards
    wardSelect.innerHTML = '<option value="" disabled selected>Phường/Xã</option>';
    
    const selectedProvince = provinceSelect.value;
    const selectedDistrict = districtSelect.value;
    
    if (selectedProvince && selectedDistrict && 
        locationData && locationData[selectedProvince] && 
        locationData[selectedProvince].districts[selectedDistrict]) {
        
        // Enable ward dropdown
        wardSelect.disabled = false;
        
        // Populate wards với sắp xếp theo thứ tự
        const wards = locationData[selectedProvince].districts[selectedDistrict].wards;
        const sortedWards = wards.slice().sort((a, b) => {
            // Tách số ra khỏi tên (ví dụ: "Phường 1" -> 1)
            const getNumber = (name) => {
                const match = name.match(/(\d+)/);
                return match ? parseInt(match[1]) : 999; // 999 cho các phường không có số
            };
            
            const numA = getNumber(a);
            const numB = getNumber(b);
            
            // Nếu cả hai đều có số, sắp xếp theo số
            if (numA !== 999 && numB !== 999) {
                return numA - numB;
            }
            
            // Nếu một trong hai không có số, sắp xếp theo alphabet
            return a.localeCompare(b, 'vi');
        });
        
        sortedWards.forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            wardSelect.appendChild(option);
        });
    } else {
        wardSelect.disabled = true;
    }
}

// Tab switching in amenity modal
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    });
});

// Character count for textarea
document.querySelector('.form-textarea').addEventListener('input', function() {
    const count = this.value.length;
    document.querySelector('.char-count').textContent = `${count}/500`;
});

// ================================
// Rules Modal Functions
// ================================

function showRulesModal() {
    document.getElementById('rulesModal').style.display = 'block';
    document.body.classList.add('add-room-no-scroll');
    document.documentElement.classList.add('add-room-no-scroll');
    
    // Load tất cả rules cho mọi category
    loadAllRules();
}

function closeRulesModal() {
    document.getElementById('rulesModal').style.display = 'none';
    document.body.classList.add('add-room-no-scroll');
    document.documentElement.classList.add('add-room-no-scroll');
}

function loadAllRules() {
    const categories = ['smoking', 'pets', 'children', 'party', 'time', 'behavior'];
    
    categories.forEach(category => {
        loadRulesForCategory(category);
    });
}

function loadRulesForCategory(category) {
    const rulesGrid = document.getElementById(`${category}Rules`);
    if (!rulesGrid) return;
    
    rulesGrid.innerHTML = '';
    
    if (!rulesData || !rulesData[category]) {
        rulesGrid.innerHTML = '<p class="no-rules-text">Không có nội quy nào trong danh mục này.</p>';
        return;
    }
    
    rulesData[category].forEach(rule => {
        const isSelected = selectedRules.some(r => r.id === rule.id);
        const ruleElement = document.createElement('div');
        ruleElement.className = `rule-item ${isSelected ? 'selected' : ''}`;
        ruleElement.innerHTML = `
            <span class="rule-text">${rule.name}</span>
        `;
        
        // Thêm event listener cho toàn bộ rule item
        ruleElement.addEventListener('click', function() {
            const isCurrentlySelected = ruleElement.classList.contains('selected');
            toggleRuleSelection(rule.id, !isCurrentlySelected);
            // Cập nhật visual state
            if (!isCurrentlySelected) {
                ruleElement.classList.add('selected');
            } else {
                ruleElement.classList.remove('selected');
            }
        });
        
        rulesGrid.appendChild(ruleElement);
    });
}

function toggleRuleSelection(ruleId, isChecked) {
    const existingIndex = selectedRules.findIndex(r => r.id === ruleId);
    
    if (isChecked && existingIndex === -1) {
        // Add rule - find in all categories
        let ruleToAdd = null;
        for (const category in rulesData) {
            const rule = rulesData[category].find(r => r.id === ruleId);
            if (rule) {
                ruleToAdd = rule;
                break;
            }
        }
        if (ruleToAdd) {
            selectedRules.push(ruleToAdd);
        }
    } else if (!isChecked && existingIndex > -1) {
        // Remove rule
        selectedRules.splice(existingIndex, 1);
    }
    
    // Update selected rules display
    updateSelectedRulesDisplay();
}

function saveSelectedRules() {
    updateSelectedRulesDisplay();
    closeRulesModal();
}

function updateSelectedRulesDisplay() {
    const container = document.getElementById('selectedRules');
    container.innerHTML = '';
    
    const maxDisplayRules = 4;
    const displayedRules = selectedRules.slice(0, maxDisplayRules);
    const hiddenCount = selectedRules.length - maxDisplayRules;
    
    // Hiển thị các rule đầu tiên
    displayedRules.forEach(rule => {
        const ruleElement = document.createElement('div');
        ruleElement.className = 'selected-rule-item';
        ruleElement.innerHTML = `
            <span>${rule.name}</span>
            <span class="remove-rule" onclick="removeSelectedRule(${rule.id})">&times;</span>
            <input type="hidden" name="rules[]" value="${rule.id}">
        `;
        container.appendChild(ruleElement);
    });
    
    // Hiển thị badge "+X nội quy khác" nếu có nhiều hơn maxDisplayRules
    if (hiddenCount > 0) {
        const moreElement = document.createElement('div');
        moreElement.className = 'more-rules-badge';
        moreElement.innerHTML = `+${hiddenCount} nội quy khác`;
        moreElement.onclick = () => showRulesModal(); // Click để mở modal
        container.appendChild(moreElement);
    }
    
    // Thêm hidden inputs cho tất cả rules
    selectedRules.forEach(rule => {
        if (!displayedRules.includes(rule)) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'rules[]';
            hiddenInput.value = rule.id;
            container.appendChild(hiddenInput);
        }
    });
}

function removeSelectedRule(ruleId) {
    selectedRules = selectedRules.filter(r => r.id !== ruleId);
    updateSelectedRulesDisplay();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const amenityModal = document.getElementById('amenityModal');
    const rulesModal = document.getElementById('rulesModal');
    
    if (event.target == amenityModal) {
        amenityModal.style.display = 'none';
        document.body.classList.add('add-room-no-scroll');
        document.documentElement.classList.add('add-room-no-scroll');
    }
    
    if (event.target == rulesModal) {
        rulesModal.style.display = 'none';
        document.body.classList.add('add-room-no-scroll');
        document.documentElement.classList.add('add-room-no-scroll');
    }
}
</script>

{% endblock %}
