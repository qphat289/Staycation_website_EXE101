{% extends 'owner/base_owner.html' %}

{% block title %}Lịch booking{% endblock %}

{% block page_title %}Lịch{% endblock %}
{% block page_subtitle %}Xem lịch booking của bạn{% endblock %}

{% block page_css %}
<style>
    /* Calendar specific styles */

    /* Date Navigation Header */
    .date-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin: 0 2rem 1rem 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .date-nav-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .date-nav-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .date-nav-btn:hover {
        background: #f0f0f0;
        color: #333;
    }

    .current-date {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin: 0 0.5rem;
    }

    .calendar-label {
        font-size: 0.875rem;
        color: #666;
    }

    /* Calendar Layout */
    .calendar-layout {
        display: flex;
        height: calc(100vh - 300px);
        min-height: 700px;
        max-height: calc(100vh - 300px);
        margin: 0 2rem 2rem 2rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* Timeline Container */
    .timeline-container {
        flex: 1;
        background-color: white;
        border-right: 1px solid #e0e0e0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Room Headers */
    .room-headers {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        position: sticky;
        top: 0;
        z-index: 100;
        height: 60px;
    }

    .time-column-header {
        width: 80px;
        flex-shrink: 0;
        background-color: #f8f9fa;
        border-right: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: #666;
    }

    .rooms-header-container {
        flex: 1;
        overflow-x: hidden;
        display: flex;
        position: relative;
    }

    .rooms-header {
        display: flex;
        min-width: max-content;
        width: max-content;
        position: relative;
        left: 0;
    }

    .room-header {
        width: 200px;
        flex-shrink: 0;
        padding: 10px;
        text-align: center;
        border-right: 1px solid #e0e0e0;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-sizing: border-box;
    }

    .room-title {
        font-size: 12px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .room-info {
        font-size: 10px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Timeline Body */
    .timeline-body {
        display: flex !important;
        width: 100% !important;
        min-width: 0 !important;
        overflow: hidden;
        position: relative;
        flex: 1;
        height: 100%;
    }

    /* Time Labels */
    .time-labels {
        width: 80px;
        flex-shrink: 0;
        background-color: white;
        border-right: 1px solid #e0e0e0;
        position: sticky;
        left: 0;
        z-index: 50;
        height: 100%;
        overflow: hidden;
        position: relative;
    }

    #timeLabels {
        height: 1440px; /* Fixed height for 24 hours × 60px */
        position: relative;
    }

    .time-label {
        height: 60px;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        font-size: 11px;
        color: #666;
        font-weight: 500;
        border-bottom: 1px solid #f0f0f0;
        background-color: white;
        padding-top: 4px;
    }

    /* Rooms Timeline */
    .rooms-timeline-container {
        flex: 1 1 0 !important;
        min-width: 0 !important;
        overflow-x: auto;
        overflow-y: auto;
        background-color: white;
        height: 100%;
        position: relative;
    }

    .rooms-timeline {
        display: flex;
        min-width: 100%;
        width: max-content;
        height: 1440px; /* 24 hours × 60px - content height */
        position: relative;
        left: 0;
    }

    .room-timeline {
        width: 200px;
        flex-shrink: 0;
        position: relative;
        border-right: 1px solid #e0e0e0;
        background-color: white;
        height: 100%;
        box-sizing: border-box;
    }

    .timeline-row {
        height: 60px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
    }

    .timeline-row:hover {
        background-color: #f8f9fa;
    }

    /* Booking Blocks */
    .booking-block {
        position: absolute;
        left: 4px;
        right: 4px;
        background-color: #ddf8b5eb;
        border: 2px solid #425e26;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        color: #2d5016;
    }

    .booking-block:hover {
        background-color: #ddf8b5eb;
        border-color: #425e26;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* Multi-day booking styling */
    .booking-block.multi-day-booking {
        background-color: #ddf8b5eb;
        border: 2px solid #425e26;
        border-left: 4px solid #5a8f2e;
    }

    .booking-block.multi-day-booking:hover {
        background-color: #ddf8b5eb;
        border-color: #425e26;
    }

    .booking-customer {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .booking-time {
        font-size: 10px;
        font-weight: 400;
        opacity: 0.9;
        white-space: nowrap;
    }

    /* Right Sidebar - Calendar */
    .calendar-sidebar {
        width: 320px;
        background-color: white;
        border-left: 1px solid #e0e0e0;
        padding: 1.5rem;
        flex-shrink: 0;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .calendar-widget {
        margin-bottom: 2rem;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .calendar-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }

    .calendar-nav {
        display: flex;
        gap: 8px;
    }

    .calendar-nav-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .calendar-nav-btn:hover {
        color: #333;
        background-color: #f0f0f0;
    }

    .calendar-nav-btn:focus {
        outline: none;
    }

    .calendar-nav-btn:active {
        outline: none;
    }

    .calendar-nav-btn *:focus {
        outline: none;
    }

    /* Remove all possible focus/active outlines from calendar navigation */
    .calendar-nav-btn,
    .calendar-nav-btn:focus,
    .calendar-nav-btn:active,
    .calendar-nav-btn:focus-visible,
    .calendar-nav-btn i,
    .calendar-nav-btn i:focus,
    .calendar-nav-btn i:active {
        outline: none !important;
        box-shadow: none !important;
        border: none !important;
    }

    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 8px;
    }

    .calendar-weekday {
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        padding: 8px;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .calendar-day {
        position: relative;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 400;
        color: #999;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .calendar-day.current-month {
        color: #333;
    }

    .calendar-day.selected {
        background-color: #3b82f6;
        color: white;
        font-weight: 600;
    }

    .calendar-day.today {
        border: 2px solid #3b82f6;
        font-weight: 600;
    }

    .calendar-day:hover {
        background-color: #f0f0f0;
    }

    .calendar-day.selected:hover {
        background-color: #2563eb;
    }

    /* Booking indicator dot */
    .booking-dot {
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        background-color: #22c55e;
        border-radius: 50%;
    }

    /* Booking Summary */
    .booking-summary {
        margin-top: 2rem;
    }

    .booking-summary h4 {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .booking-item {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .booking-item:hover {
        background: #e5e7eb;
    }

    /* Multi-day booking item styling */
    .booking-item.multi-day-booking {
        background: #eff6ff;
        border-left: 4px solid #1d4ed8;
    }

    .booking-item.multi-day-booking:hover {
        background: #dbeafe;
    }

    .booking-item-customer {
        font-size: 12px;
        font-weight: 600;
        color: #333;
        margin-bottom: 2px;
    }

    .booking-item-room {
        font-size: 11px;
        color: #666;
        margin-bottom: 2px;
    }

    .booking-item-time {
        font-size: 11px;
        color: #666;
    }

    /* Current time indicator */
    .current-time-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #ef4444;
        z-index: 20;
    }

    .current-time-dot {
        position: absolute;
        left: -4px;
        top: -3px;
        width: 8px;
        height: 8px;
        background-color: #ef4444;
        border-radius: 50%;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        padding: 20px 25px 15px;
        border-bottom: 1px solid #e0e0e0;
        position: relative;
    }

    .modal-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .modal-title i {
        margin-right: 10px;
        width: 16px;
        height: 16px;
    }

    .modal-body {
        padding: 20px 25px;
    }

    .modal-field {
        margin-bottom: 15px;
    }

    .modal-field:last-child {
        margin-bottom: 0;
    }

    .modal-field-label {
        font-size: 12px;
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }

    .modal-field-value {
        font-size: 12px;
        font-weight: 400;
        color: #666;
    }

    .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: #666;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .close:hover {
        color: #333;
        background-color: #f0f0f0;
    }

    /* Scrollbar styling for better visual consistency */
    .rooms-timeline-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .rooms-timeline-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .rooms-timeline-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    
    .rooms-timeline-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .rooms-header-container::-webkit-scrollbar {
        height: 0px; /* Hide horizontal scrollbar on header */
        background: transparent;
    }
    
    /* Ensure consistent sub-pixel rendering */
    .rooms-header, .rooms-timeline {
        transform: translateZ(0); /* Force GPU acceleration for consistent rendering */
        backface-visibility: hidden;
    }
    
    .rooms-header-container, .rooms-timeline-container {
        transform: translateZ(0);
        will-change: scroll-position;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .admin-sidebar {
            width: 200px;
            left: 20px;
        }
        
        .admin-main {
            margin-left: 200px;
        }
        
        .calendar-layout {
            flex-direction: column;
            height: auto;
        }
        
        .calendar-sidebar {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block page_content %}

        <!-- Date Navigation Header -->
        <div class="date-navigation">
            <div class="date-nav-left">
                <button class="date-nav-btn" onclick="goToPreviousDay()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <h2 class="current-date" id="currentDate">23 Tháng 5, 2025</h2>
                
                <button class="date-nav-btn" onclick="goToNextDay()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="calendar-label">
                Lịch booking
            </div>
        </div>

        <!-- Calendar Layout -->
        <div class="calendar-layout">
        <!-- Timeline Container -->
        <div class="timeline-container">
            <!-- Room Headers -->
            <div class="room-headers">
                <div class="time-column-header">Thời gian</div>
                <div class="rooms-header-container">
                    <div class="rooms-header" id="roomsHeader">
                        <!-- Room headers will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Timeline Body -->
            <div class="timeline-body">
                <div class="time-labels" id="timeLabels">
                    <!-- Time labels will be generated by JavaScript -->
                </div>

                <div class="rooms-timeline-container">
                    <div class="rooms-timeline" id="roomsTimeline">
                        <!-- Room timelines will be generated by JavaScript -->
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Right Sidebar - Calendar -->
        <div class="calendar-sidebar">
            <div class="calendar-widget">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarTitle">Tháng 5, 2025</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="calendar-nav-btn" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="calendar-weekdays">
                    <div class="calendar-weekday">CN</div>
                    <div class="calendar-weekday">T2</div>
                    <div class="calendar-weekday">T3</div>
                    <div class="calendar-weekday">T4</div>
                    <div class="calendar-weekday">T5</div>
                    <div class="calendar-weekday">T6</div>
                    <div class="calendar-weekday">T7</div>
                </div>
                
                <div class="calendar-days" id="calendarDays">
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
            </div>

            <!-- Booking Summary -->
            <div class="booking-summary">
                <h4>Lượt booking hôm nay</h4>
                <div id="bookingSummary">
                    <!-- Today's bookings will be shown here -->
                </div>
            </div>
        </div>
    </div>
    </div>

<!-- Booking Detail Modal -->
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-calendar-check"></i>
                Chi tiết booking
            </h3>
        </div>
        <div class="modal-body">
            <div class="modal-field">
                <div class="modal-field-label">Khách hàng</div>
                <div class="modal-field-value" id="modalCustomerName"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Số điện thoại</div>
                <div class="modal-field-value" id="modalPhone"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Email</div>
                <div class="modal-field-value" id="modalEmail"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Username</div>
                <div class="modal-field-value" id="modalUsername"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Phòng</div>
                <div class="modal-field-value" id="modalRoomTitle"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Ngày đặt</div>
                <div class="modal-field-value" id="modalBookingDate"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Hình thức</div>
                <div class="modal-field-value" id="modalBookingType"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Check-in</div>
                <div class="modal-field-value" id="modalCheckin"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Check-out</div>
                <div class="modal-field-value" id="modalCheckout"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Thời gian</div>
                <div class="modal-field-value" id="modalDuration"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Tổng tiền</div>
                <div class="modal-field-value" id="modalTotal"></div>
            </div>
            <div class="modal-field">
                <div class="modal-field-label">Trạng thái</div>
                <div class="modal-field-value" id="modalStatus"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Get real data from server
    const homes = {% if homes %}{{ homes|tojson|safe }}{% else %}[]{% endif %};
    const bookings = {% if bookings %}{{ bookings|tojson|safe }}{% else %}[]{% endif %};
    
    // Calendar functionality
    let currentDate = new Date();
    let selectedDate = new Date();
    
    // Generate hours array (24 hours)
    const hours = Array.from({ length: 24 }, (_, i) => {
        const hour = i.toString().padStart(2, '0');
        return `${hour}:00`;
    });

    const monthNames = [
        'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
        'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
    ];
    
    function initializeCalendar() {
        // Initialize cache with all bookings loaded from server, grouped by date
        const bookingsByDate = new Map();
        bookings.forEach(booking => {
            if (!booking.start_time) return;
            const startTime = new Date(booking.start_time);
            const dateStr = startTime.toISOString().split('T')[0];
            
            if (!bookingsByDate.has(dateStr)) {
                bookingsByDate.set(dateStr, []);
            }
            bookingsByDate.get(dateStr).push(booking);
        });
        
        // Populate the cache with all dates that have bookings
        bookingsByDate.forEach((bookingsForDate, dateStr) => {
            bookingCache.set(dateStr, bookingsForDate);
        });
        
        generateTimeLabels();
        generateRoomHeaders();
        generateRoomTimelines();
        renderBookings();
        updateCalendarTitle(); // Initialize calendar title with current month
        generateCalendar();
        updateCurrentTimeIndicator();
        updateDateDisplay();
        updateBookingSummary();
        
        // Sync scroll between headers and timeline
        syncScrolling();
        
        // Ensure perfect alignment after everything is rendered
        setTimeout(() => {
            ensureAlignment();
        }, 100);
        
        // Additional alignment checks to ensure pixel-perfect positioning
        setTimeout(() => {
            ensureAlignment();
        }, 200);
        
        setTimeout(() => {
            ensureAlignment();
        }, 500);
        
        // Debug: Check if all 24 hours are generated
        console.log('Hours array length:', hours.length);
        console.log('Time labels count:', document.querySelectorAll('.time-label').length);
        console.log('Timeline rows per room:', document.querySelectorAll('.timeline-row').length / homes.length);
        
        // Debug: Check container dimensions
        setTimeout(() => {
            const timelineContainer = document.querySelector('.timeline-container');
            const timelineBody = document.querySelector('.timeline-body');
            const roomsTimelineContainer = document.querySelector('.rooms-timeline-container');
            
            console.log('Timeline container width:', timelineContainer?.offsetWidth);
            console.log('Timeline body width:', timelineBody?.offsetWidth);
            console.log('Rooms timeline container width:', roomsTimelineContainer?.offsetWidth);
            console.log('Rooms timeline container flex:', window.getComputedStyle(roomsTimelineContainer)?.flex);
            console.log('Rooms timeline container min-width:', window.getComputedStyle(roomsTimelineContainer)?.minWidth);
        }, 100);
        
        // Update current time indicator every minute
        setInterval(updateCurrentTimeIndicator, 60000);
    }
    
    function ensureAlignment() {
        const roomsHeader = document.querySelector('.rooms-header');
        const roomsTimeline = document.querySelector('.rooms-timeline');
        const roomsHeaderContainer = document.querySelector('.rooms-header-container');
        const roomsTimelineContainer = document.querySelector('.rooms-timeline-container');
        
        if (roomsHeader && roomsTimeline) {
            // Get the exact computed widths including borders and padding
            const timelineRect = roomsTimeline.getBoundingClientRect();
            const timelineWidth = roomsTimeline.scrollWidth;
            const timelineOffsetWidth = roomsTimeline.offsetWidth;
            
            // Force exact width matching with pixel precision
            roomsHeader.style.width = `${timelineWidth}px`;
            roomsHeader.style.minWidth = `${timelineWidth}px`;
            roomsHeader.style.maxWidth = `${timelineWidth}px`;
            
            // Also ensure the container has proper overflow handling
            roomsHeaderContainer.style.overflowX = 'hidden';
            
            // Force a reflow to ensure changes are applied
            roomsHeader.offsetHeight;
            
            // Calculate and store safe scroll limits
            if (roomsHeaderContainer && roomsTimelineContainer) {
                const timelineMaxScroll = Math.max(0, roomsTimelineContainer.scrollWidth - roomsTimelineContainer.clientWidth);
                const headerMaxScroll = Math.max(0, roomsHeaderContainer.scrollWidth - roomsHeaderContainer.clientWidth);
                
                // Store the safe scroll limit (use the smaller of the two to prevent overshoot)
                const safeMaxScroll = Math.min(timelineMaxScroll, headerMaxScroll) - 3; // 3px buffer
                roomsTimelineContainer.setAttribute('data-max-scroll', safeMaxScroll);
                roomsHeaderContainer.setAttribute('data-max-scroll', safeMaxScroll);
                
                // Ensure scroll positions are synced with sub-pixel precision
                const targetScrollLeft = Math.min(roomsTimelineContainer.scrollLeft, safeMaxScroll);
                roomsHeaderContainer.scrollLeft = targetScrollLeft;
                
                // Double-check the sync worked
                if (Math.abs(roomsHeaderContainer.scrollLeft - targetScrollLeft) > 1) {
                    setTimeout(() => {
                        roomsHeaderContainer.scrollLeft = targetScrollLeft;
                    }, 10);
                }
            }
            
            console.log('Alignment ensured - Timeline width:', timelineWidth, 'Timeline offset:', timelineOffsetWidth, 'Header width:', roomsHeader.style.width);
        }
    }

    function syncScrolling() {
        const roomsHeaderContainer = document.querySelector('.rooms-header-container');
        const roomsTimelineContainer = document.querySelector('.rooms-timeline-container');
        const timeLabels = document.querySelector('.time-labels');
        const roomsHeader = document.querySelector('.rooms-header');
        const roomsTimeline = document.querySelector('.rooms-timeline');
        const timeLabelsContent = document.querySelector('#timeLabels');
        
        if (roomsTimelineContainer) {
            // Ensure both containers have the same width
            if (roomsHeader && roomsTimeline) {
                const updateWidths = () => {
                    const timelineWidth = roomsTimeline.scrollWidth;
                    roomsHeader.style.width = `${timelineWidth}px`;
                    roomsHeader.style.minWidth = `${timelineWidth}px`;
                };
                
                // Update widths initially and on resize
                updateWidths();
                window.addEventListener('resize', updateWidths);
                
                // Update widths when rooms are added/removed
                const observer = new MutationObserver(() => {
                    updateWidths();
                    setTimeout(ensureAlignment, 50);
                });
                observer.observe(roomsTimeline, { childList: true, subtree: true });
            }
            
            // Only the main timeline container handles scrolling
            roomsTimelineContainer.addEventListener('scroll', function() {
                // Get the safe scroll limit from stored attribute, fallback to calculated
                const safeMaxScroll = parseInt(this.getAttribute('data-max-scroll')) || 
                                     Math.max(0, this.scrollWidth - this.clientWidth - 3);
                let scrollLeft = this.scrollLeft;
                
                // Limit scroll to prevent overshoot at the end
                if (scrollLeft > safeMaxScroll) {
                    scrollLeft = safeMaxScroll;
                    this.scrollLeft = scrollLeft;
                }
                
                // Sync horizontal scrolling with header with exact positioning
                if (roomsHeaderContainer) {
                    if (Math.abs(roomsHeaderContainer.scrollLeft - scrollLeft) > 0.5) {
                        roomsHeaderContainer.scrollLeft = scrollLeft;
                    }
                }
                
                // Sync vertical scrolling with time labels by transforming them
                if (timeLabelsContent) {
                    const scrollTop = this.scrollTop;
                    timeLabelsContent.style.transform = `translateY(-${scrollTop}px)`;
                }
            });
            
            // Also handle header scrolling to sync back to timeline (for touch devices)
            if (roomsHeaderContainer) {
                roomsHeaderContainer.addEventListener('scroll', function() {
                    // Get the safe scroll limit from stored attribute, fallback to calculated
                    const safeMaxScroll = parseInt(this.getAttribute('data-max-scroll')) || 
                                         Math.max(0, roomsHeader.scrollWidth - this.clientWidth - 3);
                    let scrollLeft = this.scrollLeft;
                    
                    // Limit scroll to prevent overshoot at the end
                    if (scrollLeft > safeMaxScroll) {
                        scrollLeft = safeMaxScroll;
                        this.scrollLeft = scrollLeft;
                    }
                    
                    if (Math.abs(roomsTimelineContainer.scrollLeft - scrollLeft) > 0.5) {
                        roomsTimelineContainer.scrollLeft = scrollLeft;
                    }
                });
            }
        }
    }

    function updateDateDisplay() {
        const dateStr = `${selectedDate.getDate()} ${monthNames[selectedDate.getMonth()]}, ${selectedDate.getFullYear()}`;
        document.getElementById('currentDate').textContent = dateStr;
    }


    
    function generateTimeLabels() {
        const timeLabels = document.getElementById('timeLabels');
        timeLabels.innerHTML = '';
        
        hours.forEach(hour => {
            const timeLabel = document.createElement('div');
            timeLabel.className = 'time-label';
            timeLabel.textContent = hour;
            timeLabels.appendChild(timeLabel);
        });
    }
    
    function generateRoomHeaders() {
        const roomsHeader = document.getElementById('roomsHeader');
        roomsHeader.innerHTML = '';
        
        homes.forEach(home => {
            const roomHeader = document.createElement('div');
            roomHeader.className = 'room-header';
            roomHeader.innerHTML = `
                <div class="room-title" title="${home.title}">${home.title}</div>
                <div class="room-info">${home.home_type} • ${home.city}</div>
            `;
            roomsHeader.appendChild(roomHeader);
        });
    }
    
    function generateRoomTimelines() {
        const roomsTimeline = document.getElementById('roomsTimeline');
        roomsTimeline.innerHTML = '';
        
        homes.forEach(home => {
            const roomTimeline = document.createElement('div');
            roomTimeline.className = 'room-timeline';
            roomTimeline.setAttribute('data-room-id', home.id);
            
            // Create 24 hour rows for each room
            hours.forEach(() => {
                const timelineRow = document.createElement('div');
                timelineRow.className = 'timeline-row';
                roomTimeline.appendChild(timelineRow);
            });
            
            roomsTimeline.appendChild(roomTimeline);
        });
    }
    
    function renderBookings() {
        // Clear existing booking blocks
        const roomTimelines = document.querySelectorAll('.room-timeline');
        roomTimelines.forEach(timeline => {
            const existingBlocks = timeline.querySelectorAll('.booking-block');
            existingBlocks.forEach(block => block.remove());
        });
        
        bookings.forEach(booking => {
            if (!booking.start_time || !booking.end_time || !booking.home) return;
            
            const startTime = new Date(booking.start_time);
            const endTime = new Date(booking.end_time);
            
            // Check if booking overlaps with selected date
            const selectedDateStart = new Date(selectedDate);
            selectedDateStart.setHours(0, 0, 0, 0);
            const selectedDateEnd = new Date(selectedDate);
            selectedDateEnd.setHours(23, 59, 59, 999);
            
            // Skip if booking doesn't overlap with selected date
            if (endTime <= selectedDateStart || startTime > selectedDateEnd) return;
            
            // Calculate display times for this specific day
            const dayStart = new Date(selectedDate);
            dayStart.setHours(0, 0, 0, 0);
            const dayEnd = new Date(selectedDate);
            dayEnd.setHours(23, 59, 59, 999);
            
            // Determine actual start and end times for display on this day
            const displayStart = startTime > dayStart ? startTime : dayStart;
            const displayEnd = endTime < dayEnd ? endTime : dayEnd;
            
            const startHour = displayStart.getHours();
            const startMinute = displayStart.getMinutes();
            const endHour = displayEnd.getHours();
            const endMinute = displayEnd.getMinutes();
            
            // Calculate position (each hour = 60px, align with time labels)
            const startPosition = startHour * 60 + (startMinute / 60) * 60;
            let endPosition = endHour * 60 + (endMinute / 60) * 60;
            
            // Special handling for bookings that end at midnight or extend beyond the day
            if (displayEnd >= dayEnd) {
                endPosition = 24 * 60; // Show until end of day (24:00)
            }
            
            const duration = endPosition - startPosition;
            
            // Find the room timeline for this booking
            const roomTimeline = document.querySelector(`[data-room-id="${booking.home.id}"]`);
            if (roomTimeline) {
                const blockElement = document.createElement('div');
                blockElement.className = 'booking-block';
                blockElement.style.top = `${startPosition}px`;
                blockElement.style.height = `${Math.max(duration, 30)}px`;
                
                const customerName = booking.renter ? 
                    (booking.renter.full_name || booking.renter.username || 'Khách hàng') : 
                    'Khách hàng';
                
                // Show time range based on actual booking times, not just display times
                const originalStartStr = startTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                const originalEndStr = endTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                
                // If this is a multi-day booking, show different labels
                const isMultiDay = startTime.toDateString() !== endTime.toDateString();
                const startsToday = startTime.toDateString() === selectedDate.toDateString();
                const endsToday = endTime.toDateString() === selectedDate.toDateString();
                
                let timeLabel;
                if (isMultiDay) {
                    if (startsToday && !endsToday) {
                        // Booking starts today but continues
                        timeLabel = `${originalStartStr} - (tiếp tục)`;
                    } else if (!startsToday && endsToday) {
                        // Booking started earlier and ends today
                        timeLabel = `(tiếp tục) - ${originalEndStr}`;
                    } else if (!startsToday && !endsToday) {
                        // Booking spans across this day
                        timeLabel = `(toàn ngày)`;
                    } else {
                        // Same day (shouldn't happen with isMultiDay true)
                        timeLabel = `${originalStartStr} - ${originalEndStr}`;
                    }
                } else {
                    timeLabel = `${originalStartStr} - ${originalEndStr}`;
                }
                
                // Add visual indicator for multi-day bookings
                if (isMultiDay) {
                    blockElement.classList.add('multi-day-booking');
                }
                
                blockElement.innerHTML = `
                    <div class="booking-customer">${customerName}</div>
                    <div class="booking-time">${timeLabel}</div>
                `;
                
                blockElement.addEventListener('click', () => showBookingModal(booking));
                
                roomTimeline.appendChild(blockElement);
            }
        });
    }

    function updateBookingSummary() {
        const summaryContainer = document.getElementById('bookingSummary');
        
        // Get bookings that overlap with selected date
        const todayBookings = bookings.filter(booking => {
            if (!booking.start_time || !booking.end_time) return false;
            const startTime = new Date(booking.start_time);
            const endTime = new Date(booking.end_time);
            
            const selectedDateStart = new Date(selectedDate);
            selectedDateStart.setHours(0, 0, 0, 0);
            const selectedDateEnd = new Date(selectedDate);
            selectedDateEnd.setHours(23, 59, 59, 999);
            
            // Check if booking overlaps with selected date
            return !(endTime <= selectedDateStart || startTime > selectedDateEnd);
        });

        if (todayBookings.length === 0) {
            summaryContainer.innerHTML = '<p style="color: #666; font-size: 12px;">Không có đặt phòng nào</p>';
            return;
        }

        summaryContainer.innerHTML = '';
        todayBookings.forEach(booking => {
            const home = homes.find(h => h.id === booking.home.id);
            const startTime = new Date(booking.start_time);
            const endTime = new Date(booking.end_time);
            const customerName = booking.renter ? 
                (booking.renter.full_name || booking.renter.username || 'Khách hàng') : 
                'Khách hàng';

            // Create appropriate time label for summary
            const isMultiDay = startTime.toDateString() !== endTime.toDateString();
            const startsToday = startTime.toDateString() === selectedDate.toDateString();
            const endsToday = endTime.toDateString() === selectedDate.toDateString();
            
            let timeLabel;
            if (isMultiDay) {
                if (startsToday && !endsToday) {
                    timeLabel = `${startTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})} - (tiếp tục)`;
                } else if (!startsToday && endsToday) {
                    timeLabel = `(tiếp tục) - ${endTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}`;
                } else if (!startsToday && !endsToday) {
                    timeLabel = `(toàn ngày)`;
                } else {
                    timeLabel = `${startTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}`;
                }
            } else {
                timeLabel = `${startTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}`;
            }

            const bookingItem = document.createElement('div');
            bookingItem.className = 'booking-item';
            if (isMultiDay) {
                bookingItem.classList.add('multi-day-booking');
            }
            bookingItem.innerHTML = `
                <div class="booking-item-customer">${customerName}</div>
                <div class="booking-item-room">${home ? home.title : 'N/A'}</div>
                <div class="booking-item-time">${timeLabel}</div>
            `;
            
            bookingItem.addEventListener('click', () => showBookingModal(booking));
            summaryContainer.appendChild(bookingItem);
        });
    }
    
    function updateCurrentTimeIndicator() {
        const now = new Date();
        
        // Only show current time line if viewing today
        if (now.toDateString() !== selectedDate.toDateString()) {
            // Remove existing time lines
            const existingLines = document.querySelectorAll('.current-time-line');
            existingLines.forEach(line => line.remove());
            return;
        }
        
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        // Remove existing time lines
        const existingLines = document.querySelectorAll('.current-time-line');
        existingLines.forEach(line => line.remove());
        
        // Calculate position (each hour = 60px)
        const position = (currentHour + currentMinute / 60) * 60;
        
        // Add time line to each room timeline
        const roomTimelines = document.querySelectorAll('.room-timeline');
        roomTimelines.forEach(timeline => {
            const timeLine = document.createElement('div');
            timeLine.className = 'current-time-line';
            timeLine.style.top = `${position}px`;
            
            const timeDot = document.createElement('div');
            timeDot.className = 'current-time-dot';
            timeLine.appendChild(timeDot);
            
            timeline.appendChild(timeLine);
        });
    }

    // Get dates with bookings for calendar dots
    function getDatesWithBookings() {
        const dates = new Set();
        bookings.forEach(booking => {
            if (!booking.start_time) return;
            const date = new Date(booking.start_time);
            if (date.getMonth() === currentDate.getMonth() && 
                date.getFullYear() === currentDate.getFullYear()) {
                dates.add(date.getDate());
            }
        });
        return dates;
    }

    // Enhanced API functions for better calendar management
    const bookingCache = new Map(); // Cache bookings by date to avoid re-loading
    
    async function loadBookingsForDate(date) {
        try {
            const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Check if we already have bookings for this date
            if (bookingCache.has(dateStr)) {
                console.log(`Using cached bookings for ${dateStr}`);
                return;
            }
            
            const response = await fetch(`/owner/calendar/api/bookings/${dateStr}`);
            const data = await response.json();
            
            if (data.success) {
                // Cache the bookings for this date
                bookingCache.set(dateStr, data.bookings);
                
                // Add new bookings to the global array (don't clear existing ones)
                const existingBookingIds = new Set(bookings.map(b => b.id));
                const newBookings = data.bookings.filter(b => !existingBookingIds.has(b.id));
                bookings.push(...newBookings);
                
                // Note: renderBookings() and updateBookingSummary() will be called by the caller
                
                console.log(`Loaded ${data.bookings.length} bookings for ${dateStr} (${newBookings.length} new)`);
            } else {
                console.error('Failed to load bookings:', data.error);
            }
        } catch (error) {
            console.error('Error loading bookings:', error);
        }
    }

    async function loadDatesWithBookings(year, month) {
        try {
            const response = await fetch(`/owner/calendar/api/dates-with-bookings/${year}/${month}`);
            const data = await response.json();
            
            if (data.success) {
                return new Set(data.dates);
            } else {
                console.error('Failed to load dates with bookings:', data.error);
                return new Set();
            }
        } catch (error) {
            console.error('Error loading dates with bookings:', error);
            return new Set();
        }
    }

    async function showBookingModal(booking) {
        try {
            // Get detailed booking information from API
            const response = await fetch(`/owner/calendar/api/booking/${booking.id}`);
            const data = await response.json();
            
            if (data.success) {
                const detailedBooking = data.booking;
                
                // Populate modal with detailed information
                document.getElementById('modalCustomerName').textContent = 
                    detailedBooking.renter?.full_name || detailedBooking.renter?.username || 'Khách hàng';
                document.getElementById('modalPhone').textContent = 
                    detailedBooking.renter?.phone || 'Chưa cung cấp';
                document.getElementById('modalEmail').textContent = 
                    detailedBooking.renter?.email || 'Chưa cung cấp';
                document.getElementById('modalUsername').textContent = 
                    detailedBooking.renter?.username || 'Chưa cung cấp';
                document.getElementById('modalRoomTitle').textContent = 
                    detailedBooking.home?.title || 'N/A';
                
                // Format dates and times
                const startTime = new Date(detailedBooking.start_time);
                const endTime = new Date(detailedBooking.end_time);
                const createdAt = new Date(detailedBooking.created_at);
                
                document.getElementById('modalBookingDate').textContent = 
                    createdAt.toLocaleDateString('vi-VN');
                document.getElementById('modalBookingType').textContent = 
                    detailedBooking.booking_type === 'hourly' ? 'Theo giờ' : 'Theo ngày';
                document.getElementById('modalCheckin').textContent = 
                    startTime.toLocaleString('vi-VN');
                document.getElementById('modalCheckout').textContent = 
                    endTime.toLocaleString('vi-VN');
                document.getElementById('modalDuration').textContent = 
                    `${detailedBooking.total_hours} giờ`;
                document.getElementById('modalTotal').textContent = 
                    `${detailedBooking.total_price.toLocaleString('vi-VN')} VND`;
                
                // Status with color coding
                const statusElement = document.getElementById('modalStatus');
                const statusMap = {
                    'confirmed': { text: 'Đã xác nhận', class: 'text-success' },
                    'active': { text: 'Đang sử dụng', class: 'text-primary' },
                    'completed': { text: 'Hoàn thành', class: 'text-info' },
                    'cancelled': { text: 'Đã hủy', class: 'text-danger' }
                };
                
                const status = statusMap[detailedBooking.status] || { text: detailedBooking.status, class: '' };
                statusElement.textContent = status.text;
                statusElement.className = `modal-field-value ${status.class}`;
                
                // Show modal
                document.getElementById('bookingModal').style.display = 'block';
            } else {
                console.error('Failed to load booking details:', data.error);
                alert('Không thể tải thông tin đặt phòng');
            }
        } catch (error) {
            console.error('Error loading booking details:', error);
            alert('Có lỗi xảy ra khi tải thông tin đặt phòng');
        }
    }

    function closeModal() {
        document.getElementById('bookingModal').style.display = 'none';
    }

        // Enhanced date navigation with API integration
    async function goToPreviousDay() {
        const newDate = new Date(selectedDate);
        newDate.setDate(selectedDate.getDate() - 1);
        selectedDate = newDate;
        
        // Update currentDate if we moved to a different month
        if (currentDate.getMonth() !== selectedDate.getMonth() || 
            currentDate.getFullYear() !== selectedDate.getFullYear()) {
            currentDate = new Date(selectedDate);
            updateCalendarTitle();
        }
        
        updateDateDisplay();

        // Load bookings for the new date
        await loadBookingsForDate(selectedDate);
        
        // Re-render timeline and update indicators
        renderBookings();
        updateCurrentTimeIndicator();
        updateBookingSummary();
        generateCalendar(); // Update calendar selection

        // Ensure alignment after date change
        setTimeout(ensureAlignment, 50);
    }

    async function goToNextDay() {
        const newDate = new Date(selectedDate);
        newDate.setDate(selectedDate.getDate() + 1);
        selectedDate = newDate;
        
        // Update currentDate if we moved to a different month
        if (currentDate.getMonth() !== selectedDate.getMonth() || 
            currentDate.getFullYear() !== selectedDate.getFullYear()) {
            currentDate = new Date(selectedDate);
            updateCalendarTitle();
        }
        
        updateDateDisplay();

        // Load bookings for the new date
        await loadBookingsForDate(selectedDate);
        
        // Re-render timeline and update indicators
        renderBookings();
        updateCurrentTimeIndicator();
        updateBookingSummary();
        generateCalendar(); // Update calendar selection

        // Ensure alignment after date change
        setTimeout(ensureAlignment, 50);
    }
    
    function generateCalendar() {
        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = '';
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const datesWithBookings = getDatesWithBookings();
        
        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = new Date(year, month, -startingDayOfWeek + i + 1).getDate();
            calendarDays.appendChild(dayElement);
        }
        
        // Add days of current month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day current-month';
            dayElement.textContent = day;
            
            const dayDate = new Date(year, month, day);
            
            // Mark selected day
            if (dayDate.toDateString() === selectedDate.toDateString()) {
                dayElement.classList.add('selected');
            }
            
            // Mark today
            if (dayDate.toDateString() === new Date().toDateString()) {
                dayElement.classList.add('today');
            }

            // Add booking indicator dot
            if (datesWithBookings.has(day)) {
                const dot = document.createElement('div');
                dot.className = 'booking-dot';
                dayElement.appendChild(dot);
            }
            
            dayElement.addEventListener('click', async function() {
                document.querySelectorAll('.calendar-day.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                this.classList.add('selected');
                
                // Update selected date and refresh bookings
                selectedDate = new Date(year, month, day);
                updateDateDisplay();
                
                // Load bookings for this date if not already loaded
                await loadBookingsForDate(selectedDate);
                
                // Re-render timeline and update all indicators
                renderBookings();
                updateCurrentTimeIndicator();
                updateBookingSummary();
            });
            
            calendarDays.appendChild(dayElement);
        }
        
        // Add empty cells for days after month ends
        const totalCells = calendarDays.children.length;
        const remainingCells = 42 - totalCells; // 6 rows × 7 days
        for (let i = 1; i <= remainingCells; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = i;
            calendarDays.appendChild(dayElement);
        }
    }
    
        async function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        
        // Update selectedDate to maintain the same day of month, or last day if it doesn't exist
        const newSelectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDate.getDate());
        
        // If the day doesn't exist in the new month (e.g., Jan 31 -> Feb 31), use the last day of the month
        if (newSelectedDate.getMonth() !== currentDate.getMonth()) {
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0); // Last day of current month
        } else {
            selectedDate = newSelectedDate;
        }
        
        updateCalendarTitle();
        updateDateDisplay();
        generateCalendar();
        
        // Load bookings for the selected date
        await loadBookingsForDate(selectedDate);
        renderBookings();
        updateCurrentTimeIndicator();
        updateBookingSummary();
    }

    async function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        
        // Update selectedDate to maintain the same day of month, or last day if it doesn't exist
        const newSelectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDate.getDate());
        
        // If the day doesn't exist in the new month (e.g., Jan 31 -> Feb 31), use the last day of the month
        if (newSelectedDate.getMonth() !== currentDate.getMonth()) {
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0); // Last day of current month
        } else {
            selectedDate = newSelectedDate;
        }
        
        updateCalendarTitle();
        updateDateDisplay();
        generateCalendar();
        
        // Load bookings for the selected date
        await loadBookingsForDate(selectedDate);
        renderBookings();
        updateCurrentTimeIndicator();
        updateBookingSummary();
    }
    
    function updateCalendarTitle() {
        document.getElementById('calendarTitle').textContent = 
            `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    }
    

    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('bookingModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeCalendar);
    
    // Handle window resize to maintain alignment
    window.addEventListener('resize', function() {
        setTimeout(ensureAlignment, 100);
    });
</script>
{% endblock %}