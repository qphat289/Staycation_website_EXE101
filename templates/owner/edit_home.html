{% extends 'base.html' %}
{% block title %}Chỉnh sửa nhà{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    body {
        background: #f8fdf4;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .edit-container {
        max-width: 1400px;
        margin: -50px auto 0 auto;
        padding: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .back-link {
        display: flex;
        align-items: center;
        color: #666;
        text-decoration: none;
        font-size: 14px;
    }

    .back-link i {
        margin-right: 8px;
    }

    .save-btn {
        background: #9ed649;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(158, 214, 73, 0.3);
    }

    .save-btn:hover {
        background: #8bc441;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(158, 214, 73, 0.4);
    }

    .main-content {
        display: grid;
        grid-template-columns: 6fr 4fr;
        gap: 30px;
    }

    .form-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .form-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        color: #555;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
    }

    .form-input:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
    }

    .form-select:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        background: white;
        color: #333;
    }

    .textarea:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .counter-group {
        display: flex;
        gap: 30px;
        margin-bottom: 20px;
    }

    .counter-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .counter-label {
        font-size: 14px;
        color: #555;
        font-weight: 500;
    }

    .counter-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 4px;
    }

    .counter-btn {
        width: 30px;
        height: 30px;
        border: none;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #666;
        transition: all 0.2s ease;
    }

    .counter-btn:hover {
        background: #9ed649;
        color: white;
    }

    .counter-value {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        min-width: 30px;
        text-align: center;
    }

    .property-type-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-start;
        margin-bottom: 20px;
    }

    .property-type-selection .property-option {
        flex: 0 0 calc(25% - 9px);
        max-width: calc(25% - 9px);
    }

    .property-option {
        position: relative;
    }

    .property-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .property-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 80px;
        text-align: center;
    }

    .property-label:hover {
        border-color: #9ed649;
        background-color: #f8fff0;
    }

    .property-radio:checked + .property-label {
        border-color: #9ed649;
        background-color: #f0f9e8;
        box-shadow: 0 2px 8px rgba(158, 214, 73, 0.3);
    }

    .property-icon {
        margin-bottom: 8px;
        font-size: 24px;
        color: #666;
        transition: color 0.3s ease;
    }

    .property-radio:checked + .property-label .property-icon {
        color: #9ed649;
    }

    .property-text {
        font-size: 14px;
        font-weight: 500;
        color: #333;
    }

    /* Accommodation Type Selection Styles */
    .accommodation-type-selection {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
        max-width: 400px;
    }

    .accommodation-option {
        position: relative;
    }

    .accommodation-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .accommodation-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 12px 8px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 70px;
        text-align: center;
    }

    .accommodation-label:hover {
        border-color: #9ed649;
        background-color: #f8fff0;
    }

    .accommodation-radio:checked + .accommodation-label {
        border-color: #9ed649;
        background-color: #f0f9e8;
        box-shadow: 0 2px 8px rgba(158, 214, 73, 0.3);
    }

    .accommodation-icon {
        margin-bottom: 6px;
        font-size: 20px;
        color: #666;
        transition: color 0.3s ease;
    }

    .accommodation-radio:checked + .accommodation-label .accommodation-icon {
        color: #9ed649;
    }

    .accommodation-text {
        font-size: 12px;
        font-weight: 500;
        color: #333;
    }

    .rental-type-selection {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .rental-option {
        position: relative;
    }

    .rental-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .rental-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        min-width: 120px;
        justify-content: center;
    }

    .rental-label:hover {
        border-color: #9ed649;
        background-color: #f8fff0;
    }

    .rental-radio:checked + .rental-label {
        border-color: #9ed649;
        background-color: #f0f9e8;
        color: #9ed649;
        font-weight: 600;
    }

    .price-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .price-input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
    }

    .price-input:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .currency-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }

    .image-upload-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        height: fit-content;
    }

    .upload-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        max-width: 100%;
        width: 100%;
    }

    .upload-item {
        position: relative;
        aspect-ratio: 1;
        border: 2px dashed #ddd;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 140px;
        max-width: 160px;
    }

    .upload-label {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(158, 214, 73, 0.9);
        color: white;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 4px;
        z-index: 2;
        font-weight: 500;
    }

    .upload-item.add-more {
        background: #f9f9f9;
        border-color: #9ed649;
        border-style: dashed;
        cursor: pointer;
    }

    .upload-item.add-more .upload-placeholder {
        background: transparent;
    }

    .upload-item.add-more .upload-placeholder i {
        font-size: 24px;
        color: #9ed649;
    }

    .upload-item:hover {
        border-color: #9ed649;
        background: #f8fff0;
    }

    .main-image-upload {
        cursor: pointer !important;
        border: 2px dashed #9ed649 !important;
    }

    .main-image-upload:hover {
        background: #f0f9e8 !important;
        transform: scale(1.02);
    }

    .upload-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: #999;
        font-size: 14px;
        cursor: pointer;
        z-index: 5;
    }

    .upload-placeholder i {
        font-size: 24px;
        color: #9ed649;
    }

    .upload-item input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 10;
        top: 0;
        left: 0;
    }

    .upload-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
    }

    .existing-image {
        position: relative;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        overflow: hidden;
    }

    .existing-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .existing-image:hover .image-overlay {
        opacity: 1;
    }

    .featured-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #9ed649;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .remove-image-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
    }

    .remove-image-btn:hover {
        background: #c82333;
        top: 0;
        left: 0;
    }

    .remove-image {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
        z-index: 15;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-image:hover {
        background: rgba(220, 53, 69, 1);
    }

    .selected-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }

    .selected-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: #f0f9e8;
        border: 1px solid #9ed649;
        border-radius: 6px;
        font-size: 14px;
        color: #2d5a2d;
    }

    .remove-item {
        color: #666;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        padding: 0 4px;
        border-radius: 50%;
        transition: all 0.2s ease;
        margin-left: 8px;
    }

    .remove-item:hover {
        background: #dc3545;
        color: white;
    }

    .add-btn {
        background: transparent;
        color: #333;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }

    .add-btn:hover {
        color: #9ed649;
        border-color: #9ed649;
    }

    .location-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .location-inputs {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .actions {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-secondary {
        background: white;
        color: #666;
        border: 1px solid #ddd;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: #f8f9fa;
        border-color: #bbb;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
        border: 1px solid #dc3545;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-danger:hover {
        background: #c82333;
        border-color: #bd2130;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 70px;
        right: 0;
        transform: none;
        background: white;
        border-radius: 12px 0 0 12px;
        padding: 30px;
        max-width: 700px;
        width: 650px;
        height: calc(100vh - 70px);
        overflow-y: auto;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e5e5;
    }

    .modal-header h3 {
        margin: 0;
        color: #333;
        font-size: 18px;
        font-weight: 600;
    }

    .modal-header button {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
    }

    .amenity-sections, .rules-sections {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    .amenity-section, .rule-section {
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 20px;
        background: #fafafa;
    }

    .section-title {
        color: #333;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #9ed649;
        display: flex;
        align-items: center;
    }

    .section-title i {
        color: #9ed649;
        margin-right: 8px;
    }

    .amenities-grid, .rules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
    }

    .amenity-item, .rule-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
    }

    .amenity-item:hover, .rule-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #9ed649;
    }

    .amenity-item.selected, .rule-item.selected {
        background-color: #e8f5e8;
        border-color: #9ed649;
    }

    .amenity-item.selected::after, .rule-item.selected::after {
        content: '✔';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ed649;
        font-weight: bold;
        font-size: 16px;
    }

    .amenity-item i {
        font-size: 18px;
        color: #9ed649;
        min-width: 20px;
        margin-right: 10px;
    }

    .amenity-text, .rule-text {
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }

    /* Change main image button styling */
    .change-main-image-btn {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 24px;
        height: 24px;
        border: none;
        background: rgba(40, 167, 69, 0.8);
        color: white;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
        z-index: 15;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .change-main-image-btn:hover {
        background: rgba(40, 167, 69, 1);
        transform: scale(1.1);
    }

    .existing-image {
        position: relative;
        transition: all 0.3s ease;
    }

    .existing-image:hover .change-main-image-btn {
        opacity: 1;
    }

    /* Changed image indicator */
    .changed-indicator {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="header">
        <a href="{{ url_for('owner.dashboard') }}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay lại danh sách nhà
        </a>
        <button type="submit" form="edit-home-form" class="save-btn">
            <i class="fas fa-save"></i>
            Lưu thay đổi
        </button>
    </div>

    <form id="edit-home-form" method="post" enctype="multipart/form-data">
        <div class="main-content">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Basic Information -->
                <div class="form-section">
                    <h3 class="section-title">Thông tin cơ bản</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Tên Homestay</label>
                        <input type="text" name="home_title" class="form-input" 
                               value="{{ home.title or '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Mô tả Homestay</label>
                        <textarea name="home_description" class="textarea" required>{{ home.description or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hình thức lưu trú</label>
                        <div class="accommodation-type-selection">
                            <div class="accommodation-option">
                                <input type="radio" id="entire_home_edit" name="accommodation_type" value="entire_home" class="accommodation-radio" 
                                       {% if home.accommodation_type == 'entire_home' or not home.accommodation_type %}checked{% endif %}>
                                <label for="entire_home_edit" class="accommodation-label">
                                    <div class="accommodation-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="accommodation-text">Toàn bộ nhà</div>
                                </label>
                            </div>
                            <div class="accommodation-option">
                                <input type="radio" id="private_room_edit" name="accommodation_type" value="private_room" class="accommodation-radio"
                                       {% if home.accommodation_type == 'private_room' %}checked{% endif %}>
                                <label for="private_room_edit" class="accommodation-label">
                                    <div class="accommodation-icon">
                                        <i class="fas fa-door-open"></i>
                                    </div>
                                    <div class="accommodation-text">Phòng riêng</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Loại hình nhà</label>
                        <div class="property-type-selection">
                            <div class="property-option">
                                <input type="radio" id="townhouse_edit" name="property_type" value="townhouse" class="property-radio" 
                                       {% if home.property_type == 'townhouse' %}checked{% endif %}>
                                <label for="townhouse_edit" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="property-text">Nhà phố</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="apartment_edit" name="property_type" value="apartment" class="property-radio"
                                       {% if home.property_type == 'apartment' %}checked{% endif %}>
                                <label for="apartment_edit" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="property-text">Chung cư</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="villa_edit" name="property_type" value="villa" class="property-radio"
                                       {% if home.property_type == 'villa' %}checked{% endif %}>
                                <label for="villa_edit" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-house-user"></i>
                                    </div>
                                    <div class="property-text">Villa</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="penthouse_edit" name="property_type" value="penthouse" class="property-radio"
                                       {% if home.property_type == 'penthouse' %}checked{% endif %}>
                                <label for="penthouse_edit" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-city"></i>
                                    </div>
                                    <div class="property-text">Penthouse</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="farmstay_edit" name="property_type" value="farmstay" class="property-radio"
                                       {% if home.property_type == 'farmstay' %}checked{% endif %}>
                                <label for="farmstay_edit" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-tree"></i>
                                    </div>
                                    <div class="property-text">Farmstay</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="resort_edit" name="property_type" value="resort" class="property-radio"
                                       {% if home.property_type == 'resort' %}checked{% endif %}>
                                <label for="resort_edit" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-water"></i>
                                    </div>
                                    <div class="property-text">Resort</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Home Details -->
                <div class="form-section">
                    <h3 class="section-title">Chi tiết nhà</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Sức chứa nhà</label>
                        <div class="counter-group">
                            <div class="counter-item">
                                <span class="counter-label">Nhà tắm</span>
                                <div class="counter-controls">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('bathroom')">-</button>
                                    <span class="counter-value" id="bathroom-count">{{ home.bathroom_count or 1 }}</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('bathroom')">+</button>
                                </div>
                                <input type="hidden" name="bathroom_count" id="bathroom_count_input" value="{{ home.bathroom_count or 1 }}">
                            </div>
                            <div class="counter-item">
                                <span class="counter-label">Giường</span>
                                <div class="counter-controls">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('bed')">-</button>
                                    <span class="counter-value" id="bed-count">{{ home.bed_count or 1 }}</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('bed')">+</button>
                                </div>
                                <input type="hidden" name="bed_count" id="bed_count_input" value="{{ home.bed_count or 1 }}">
                            </div>
                            <div class="counter-item">
                                <span class="counter-label">Khách</span>
                                <div class="counter-controls">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('guest')">-</button>
                                    <span class="counter-value" id="guest-count">{{ home.guest_count or 1 }}</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('guest')">+</button>
                                </div>
                                <input type="hidden" name="guest_count" id="guest_count_input" value="{{ home.guest_count or 1 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hình thức cho thuê</label>
                        <div class="rental-type-selection">
                            <div class="rental-option">
                                <input type="radio" id="hourly" name="rental_type" value="hourly" class="rental-radio"
                                       {% if home.rental_type == 'hourly' %}checked{% endif %}>
                                <label for="hourly" class="rental-label">
                                    <i class="fas fa-clock"></i>
                                    <span>Theo giờ</span>
                                </label>
                            </div>
                            <div class="rental-option">
                                <input type="radio" id="nightly" name="rental_type" value="nightly" class="rental-radio"
                                       {% if home.rental_type == 'nightly' %}checked{% endif %}>
                                <label for="nightly" class="rental-label">
                                    <i class="fas fa-moon"></i>
                                    <span>Qua đêm</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Giá nhà</label>
                        <div id="hourly-pricing" style="display: {% if home.rental_type == 'hourly' %}block{% else %}none{% endif %};">
                            <div class="price-input-group">
                                <span class="currency-label">VND</span>
                                <input type="text" name="hourly_price" class="price-input" 
                                       placeholder="Nhập giá theo giờ" 
                                       value="{% if home.hourly_price and home.hourly_price > 0 %}{{ '{:,}'.format(home.hourly_price).replace(',', '.') }}{% endif %}"
                                       oninput="formatPriceInput(this)">
                            </div>
                        </div>
                        <div id="nightly-pricing" style="display: {% if home.rental_type == 'nightly' %}block{% else %}none{% endif %};">
                            <div class="price-input-group">
                                <span class="currency-label">VND</span>
                                <input type="text" name="nightly_price" class="price-input" 
                                       placeholder="Nhập giá qua đêm" 
                                       value="{% if home.nightly_price and home.nightly_price > 0 %}{{ '{:,}'.format(home.nightly_price).replace(',', '.') }}{% endif %}"
                                       oninput="formatPriceInput(this)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amenities -->
                <div class="form-section">
                    <h3 class="section-title">Tiện nghi</h3>
                    <div class="form-group">
                        <div class="selected-items" id="selectedAmenities">
                            <!-- Selected amenities will be populated here -->
                        </div>
                        <button type="button" class="add-btn" onclick="showAmenityModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Thêm tiện nghi</span>
                        </button>
                        <div id="amenityInputs"></div>
                    </div>
                </div>

                <!-- Rules -->
                <div class="form-section">
                    <h3 class="section-title">Nội quy</h3>
                    <div class="form-group">
                        <div class="selected-items" id="selectedRules">
                            <!-- Selected rules will be populated here -->
                        </div>
                        <button type="button" class="add-btn" onclick="showRulesModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Thêm nội quy</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Image Upload -->
                <div class="form-section">
                    <h3>Hình ảnh nhà</h3>
                    <div class="form-content">
                        <div class="upload-grid" style="display: flex; flex-wrap: wrap; gap: 10px; max-width: 500px;">
                            <!-- Main image upload box -->
                            {% set main_image = home.images|selectattr('is_featured', 'equalto', True)|list|first if home.images else None %}
                            <div class="upload-item main-image-upload" id="main-image-box" style="position: relative; width: calc(33.333% - 7px); height: 120px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden;">
                                <span class="upload-label" style="position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; z-index: 25;">Ảnh bìa</span>
                                <input type="file" name="main_image" accept="image/*" id="main-image-input" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 20;" onchange="if(this.files[0]) { simplePreview(this); }">
                                
                                {% if main_image %}
                                <img src="/static/{{ main_image.path }}" alt="Main image" class="existing-main-img" style="width: 100%; height: 100%; object-fit: cover;">
                                <div class="image-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; pointer-events: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
                                    <span style="color: white; font-size: 11px; text-align: center;">Thay ảnh bìa</span>
                                </div>
                                {% else %}
                                <div class="upload-placeholder" style="pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 12px;">
                                    <i class="bi bi-camera" style="font-size: 20px; margin-bottom: 6px;"></i>
                                    <span>Thay ảnh bìa</span>
                                </div>
                                    {% endif %}
                            </div>
                            
                            <!-- Display all existing additional images -->
                            {% set other_images = home.images|rejectattr('is_featured', 'equalto', True)|list if home.images else [] %}
                            {% for image in other_images %}
                            <div class="upload-item existing-image" style="position: relative; width: calc(33.333% - 7px); height: 120px; border-radius: 8px; overflow: hidden;">
                                <img src="/static/{{ image.path }}" alt="Home image" class="existing-img" style="width: 100%; height: 100%; object-fit: cover;">
                                <div class="image-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
                                    <button type="button" class="remove-image-btn" onclick="removeExistingImage({{ image.id }})" style="background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;">
                                            <i class="bi bi-x-circle-fill"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            
                            <!-- Add more images button -->
                            <div class="upload-item add-more" id="add-more-box" style="position: relative; width: calc(33.333% - 7px); height: 120px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                <div class="upload-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 12px;" onclick="addMoreImages()">
                                    <i class="bi bi-plus-circle" style="font-size: 20px; margin-bottom: 6px;"></i>
                                    <span>Thêm ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location -->
                <div class="location-section">
                    <h3 class="section-title">Vị trí</h3>
                    <div class="location-inputs">
                        <select name="province" id="province" class="form-select" onchange="updateDistricts()">
                            <option value="" disabled>Tỉnh/Thành phố</option>
                            <!-- Các tỉnh sẽ được load từ API -->
                        </select>
                        <select name="district" id="district" class="form-select" onchange="updateWards()">
                            <option value="" disabled {% if not home.district %}selected{% endif %}>Quận/Huyện</option>
                        </select>
                        <select name="ward" id="ward" class="form-select">
                            <option value="" disabled {% if not home.ward %}selected{% endif %}>Phường/Xã</option>
                        </select>
                        <input type="text" name="street" class="form-input" 
                               placeholder="Số nhà, tên đường" 
                               value="{{ home.street or '' }}" required>
                    </div>

                </div>
            </div>
        </div>

    </form>
</div>

<!-- Include modals from add_home.html for amenities and rules -->
<!-- Amenity Modal -->
<div id="amenityModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chọn tiện nghi</h3>
            <button type="button" onclick="closeAmenityModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="amenity-sections">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Rules Modal -->
<div id="rulesModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chọn nội quy</h3>
            <button type="button" onclick="closeRulesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="rules-sections">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
// Include JavaScript from add_home.html for functionality
let selectedAmenities = {{ (home.amenities if home else [])|tojson|safe }};
let selectedRules = {{ (home.rules if home else [])|tojson|safe }};
let locationData = null;
let amenitiesData = null;
let rulesData = null;

// Counter functions
function increaseCount(type) {
    const element = document.getElementById(`${type}-count`);
    let count = parseInt(element.textContent);
    count++;
    element.textContent = count;
    document.getElementById(`${type}_count_input`).value = count;
}

function decreaseCount(type) {
    const element = document.getElementById(`${type}-count`);
    let count = parseInt(element.textContent);
    if (count > 1) {
        count--;
        element.textContent = count;
        document.getElementById(`${type}_count_input`).value = count;
    }
}

// Price formatting with validation
function formatPriceInput(input) {
    let value = input.value.replace(/[^\d]/g, '');
    if (value) {
        const numValue = parseInt(value);
        const formatted = numValue.toLocaleString('vi-VN');
        input.value = formatted;
        input.setAttribute('data-value', value);
        
        // Real-time validation
        validateEditPriceInput(input, numValue);
    } else {
        // Clear validation styling when input is empty
        clearEditPriceValidation(input);
    }
}

// Real-time price validation for edit home
function validateEditPriceInput(input, numValue) {
    const minPrice = 10000;
    const priceContainer = input.closest('.form-group') || input.parentElement;
    
    // Remove existing error message
    const existingError = priceContainer.querySelector('.price-error-message');
    if (existingError) {
        existingError.remove();
    }
    
    // Clear previous styling
    input.style.border = '';
    input.style.boxShadow = '';
    
    if (numValue < minPrice) {
        // Add error styling
        input.style.border = '2px solid #ef4444';
        input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        
        // Add error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'price-error-message';
        errorDiv.style.cssText = `
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        `;
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            Giá tối thiểu là ${minPrice.toLocaleString('vi-VN')}đ
        `;
        
        priceContainer.appendChild(errorDiv);
    }
}

// Clear price validation styling
function clearEditPriceValidation(input) {
    const priceContainer = input.closest('.form-group') || input.parentElement;
    const existingError = priceContainer.querySelector('.price-error-message');
    
    if (existingError) {
        existingError.remove();
    }
    
    input.style.border = '';
    input.style.boxShadow = '';
}

// Rental type change
document.addEventListener('DOMContentLoaded', function() {
    const hourlyRadio = document.getElementById('hourly');
    const nightlyRadio = document.getElementById('nightly');
    
    if (hourlyRadio) {
        hourlyRadio.addEventListener('change', function() {
            if (this.checked) {
                updatePricingDisplay();
            }
        });
    }
    
    if (nightlyRadio) {
        nightlyRadio.addEventListener('change', function() {
            if (this.checked) {
                updatePricingDisplay();
            }
        });
    }

    // Load initial data and setup displays
    Promise.all([
        loadLocationData(),
        loadAmenitiesData(),
        loadRulesData()
    ]).then(() => {
        // Fill location after data is loaded
        fillCurrentLocation();
        
        // Update displays after data is loaded
        updateSelectedAmenitiesDisplay();
        updateSelectedRulesDisplay();
        
        // Load existing home rules and amenities
        loadExistingRulesAndAmenities();
    });

    // Setup main image upload
    setupMainImageUpload();
});

function updatePricingDisplay() {
    const hourlyRadio = document.getElementById('hourly');
    const nightlyRadio = document.getElementById('nightly');
    const hourlyPricing = document.getElementById('hourly-pricing');
    const nightlyPricing = document.getElementById('nightly-pricing');
    
    if (hourlyRadio.checked) {
        hourlyPricing.style.display = 'block';
        nightlyPricing.style.display = 'none';
    } else if (nightlyRadio.checked) {
        nightlyPricing.style.display = 'block';
        hourlyPricing.style.display = 'none';
    }
}

// Load APIs and populate data (include the same functions from add_home.html)
async function loadLocationData() {
    try {
        const response = await fetch('/api/locations/all');
        const result = await response.json();
        if (result.success) {
            locationData = result.data;
            
            // Populate provinces first
            populateProvinces();
            
            // Auto-fill current location after provinces are loaded
            setTimeout(() => {
                fillCurrentLocation();
            }, 100);
        }
    } catch (error) {
        console.error('Error loading location data:', error);
    }
}

// Populate provinces vào select box
function populateProvinces() {
    const provinceSelect = document.getElementById('province');
    if (!provinceSelect || !locationData) return;
    
    // Clear existing options except the first one
    const firstOption = provinceSelect.querySelector('option[value=""]');
    provinceSelect.innerHTML = '';
    if (firstOption) {
        provinceSelect.appendChild(firstOption);
    }
    
    // Add provinces from API data
    Object.keys(locationData).forEach(provinceCode => {
        const province = locationData[provinceCode];
        const option = document.createElement('option');
        option.value = provinceCode;
        option.textContent = province.name;
        
        // Check if this province matches current home's province
        {% if home.province %}
        if (provinceCode === '{{ home.province }}') {
            option.selected = true;
        }
        {% endif %}
        
        provinceSelect.appendChild(option);
    });
    
    console.log('✅ Populated provinces into select box');
}

async function loadAmenitiesData() {
    try {
        const response = await fetch('/api/amenities');
        const result = await response.json();
        if (result.success) {
            amenitiesData = result.data;
            }
    } catch (error) {
        console.error('Error loading amenities data:', error);
    }
}

async function loadRulesData() {
    try {
        const response = await fetch('/api/rules');
        const result = await response.json();
        if (result.success) {
            rulesData = result.data;
            }
    } catch (error) {
        console.error('Error loading rules data:', error);
    }
}

function fillCurrentLocation() {
    // Fill saved location data
    {% if home.province %}
    document.getElementById('province').value = '{{ home.province }}';
    updateDistricts();
    setTimeout(() => {
        {% if home.district %}
        document.getElementById('district').value = '{{ home.district }}';
        updateWards();
        setTimeout(() => {
            {% if home.ward %}
            // Try to find and select the ward
            const wardSelect = document.getElementById('ward');
            const wardOptions = wardSelect.options;
            for (let i = 0; i < wardOptions.length; i++) {
                if (wardOptions[i].textContent.trim() === '{{ home.ward }}') {
                    wardSelect.value = wardOptions[i].value;
                    break;
                }
            }
            {% endif %}
        }, 1000);
        {% endif %}
    }, 500);
    {% endif %}
}

// Function to load existing home rules and amenities
function loadExistingRulesAndAmenities() {
    // Clear current selections first
    selectedRules = [];
    selectedAmenities = [];
    
    // Load amenities from home data
    const homeAmenities = {{ (home.amenities if home else [])|tojson|safe }};
    if (homeAmenities && Array.isArray(homeAmenities)) {
        homeAmenities.forEach(amenity => {
            if (amenity.id && amenity.name) {
                selectedAmenities.push({
                    id: amenity.id,
                    name: amenity.name,
                    icon: amenity.icon || 'fas fa-check'
                });
            }
        });
    }
    
    // Load rules from home data
    const homeRules = {{ (home.rules if home else [])|tojson|safe }};
    if (homeRules && Array.isArray(homeRules)) {
        homeRules.forEach(rule => {
            if (rule.id && rule.name) {
                selectedRules.push({
                    id: rule.id,
                    name: rule.name
                });
            }
        });
    }
    
    // Update displays after loading
    updateSelectedAmenitiesDisplay();
    updateSelectedRulesDisplay();
    
    }

// Note: Duplicate functions removed - using the ones defined above

// Location update functions
function updateDistricts() {
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    
    // Reset districts and wards
    districtSelect.innerHTML = '<option value="" disabled selected>Quận/Huyện</option>';
    wardSelect.innerHTML = '<option value="" disabled selected>Phường/Xã</option>';
    wardSelect.disabled = true;
    
    const selectedProvince = provinceSelect.value;
    
    if (selectedProvince && locationData && locationData[selectedProvince]) {
        // Enable district dropdown
        districtSelect.disabled = false;
        
        // Populate districts
        const districts = locationData[selectedProvince].districts;
        const sortedDistricts = Object.entries(districts).sort((a, b) => {
            const nameA = a[1].name;
            const nameB = b[1].name;
            const getNumber = (name) => {
                const match = name.match(/(\d+)/);
                return match ? parseInt(match[1]) : 999;
            };
            const numA = getNumber(nameA);
            const numB = getNumber(nameB);
            if (numA !== 999 && numB !== 999) {
                return numA - numB;
            }
            return nameA.localeCompare(nameB, 'vi');
        });
        
        sortedDistricts.forEach(([key, district]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = district.name;
            districtSelect.appendChild(option);
        });
    } else {
        districtSelect.disabled = true;
    }
}

function updateWards() {
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    
    // Reset wards
    wardSelect.innerHTML = '<option value="" disabled selected>Phường/Xã</option>';
    
    const selectedProvince = provinceSelect.value;
    const selectedDistrict = districtSelect.value;
    
    if (selectedProvince && selectedDistrict && 
        locationData && locationData[selectedProvince] && 
        locationData[selectedProvince].districts[selectedDistrict]) {
        
        // Enable ward dropdown
        wardSelect.disabled = false;
        
        // Populate wards
        const wards = locationData[selectedProvince].districts[selectedDistrict].wards;
        const sortedWards = wards.slice().sort((a, b) => {
            const getNumber = (name) => {
                const match = name.match(/(\d+)/);
                return match ? parseInt(match[1]) : 999;
            };
            const numA = getNumber(a);
            const numB = getNumber(b);
            if (numA !== 999 && numB !== 999) {
                return numA - numB;
            }
            return a.localeCompare(b, 'vi');
        });
        
        sortedWards.forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            wardSelect.appendChild(option);
        });
    } else {
        wardSelect.disabled = true;
    }
}

// Modal functions
function showAmenityModal() {
    document.getElementById('amenityModal').style.display = 'block';
    loadAllAmenities();
}

function closeAmenityModal() {
    document.getElementById('amenityModal').style.display = 'none';
}

function showRulesModal() {
    document.getElementById('rulesModal').style.display = 'block';
    loadAllRules();
}

function closeRulesModal() {
    document.getElementById('rulesModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const amenityModal = document.getElementById('amenityModal');
    const rulesModal = document.getElementById('rulesModal');
    
    if (event.target == amenityModal) {
        closeAmenityModal();
    }
    
    if (event.target == rulesModal) {
        closeRulesModal();
    }
}

// Simple image preview function for main image upload
function simplePreview(input) {
    console.log('🔧 simplePreview called for main image');
    
    if (!input.files || !input.files[0]) {
        return;
    }
    
    const file = input.files[0];
    const mainImageBox = document.getElementById('main-image-box');
    
    if (!mainImageBox) {
        console.error('❌ Main image box not found');
        return;
    }
    
        const reader = new FileReader();
        reader.onload = function(e) {
        // Remove existing content except the label and input
        const existingImg = mainImageBox.querySelector('.existing-main-img');
        const placeholder = mainImageBox.querySelector('.upload-placeholder');
        const existingPreview = mainImageBox.querySelector('.preview-img');
        const existingRemoveBtn = mainImageBox.querySelector('.remove-btn');
        
        if (existingImg) existingImg.remove();
        if (placeholder) placeholder.remove();
        if (existingPreview) existingPreview.remove();
        if (existingRemoveBtn) existingRemoveBtn.remove();
        
        // Create new preview image
        const img = document.createElement('img');
        img.className = 'preview-img';
        img.style.cssText = `
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        `;
        img.src = e.target.result;
        
        // Create remove button
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '×';
        removeBtn.type = 'button';
        removeBtn.className = 'remove-btn';
        removeBtn.style.cssText = `
            position: absolute;
            top: 30px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: none;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        removeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Clear the input
            input.value = '';
            // Remove preview elements
            img.remove();
            removeBtn.remove();
            
            // Restore placeholder
            const newPlaceholder = document.createElement('div');
            newPlaceholder.className = 'upload-placeholder';
            newPlaceholder.style.cssText = `
                pointer-events: none;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: #999;
                font-size: 14px;
            `;
            newPlaceholder.innerHTML = `
                <i class="bi bi-camera" style="font-size: 24px; margin-bottom: 8px;"></i>
                <span>Chọn ảnh bìa</span>
            `;
            mainImageBox.appendChild(newPlaceholder);
        });
        
        // Add elements to the main image box
        mainImageBox.appendChild(img);
        mainImageBox.appendChild(removeBtn);
        
        console.log('✅ Main image preview updated');
    };
    
    reader.readAsDataURL(file);
}

// Function to add more images
function addMoreImages() {
    console.log('📸 Add more images clicked');
    
    // Create temporary file input
    const tempInput = document.createElement('input');
    tempInput.type = 'file';
    tempInput.accept = 'image/*';
    tempInput.multiple = true;
    tempInput.style.display = 'none';
    
    tempInput.addEventListener('change', function() {
        console.log('📸 Files selected:', this.files.length);
        if (this.files && this.files.length > 0) {
            Array.from(this.files).forEach((file, index) => {
                console.log(`📸 Processing file ${index + 1}:`, file.name);
                addImageToUploadGrid(file);
            });
        }
        tempInput.remove();
    });
    
    document.body.appendChild(tempInput);
    tempInput.click();
}

// Regular image preview function for additional images
function previewImage(input) {
    const uploadItem = input.closest('.upload-item');
    const placeholder = uploadItem.querySelector('.upload-placeholder');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // Remove any existing preview
            const existingImg = uploadItem.querySelector('img:not(.existing-img)');
            const existingBtn = uploadItem.querySelector('.remove-btn');
            if (existingImg) existingImg.remove();
            if (existingBtn) existingBtn.remove();
            
            // Create preview image
            const img = document.createElement('img');
            img.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 5;
                border-radius: 8px;
            `;
            img.src = e.target.result;
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '×';
            removeBtn.type = 'button';
            removeBtn.className = 'remove-btn';
            removeBtn.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 20px;
                height: 20px;
                border: none;
                background: rgba(220, 53, 69, 0.8);
                color: white;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
                z-index: 15;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Clear the input
                input.value = '';
                // Remove preview elements
                img.remove();
                removeBtn.remove();
                // Show placeholder again
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            });
            
            // Hide placeholder and add preview
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            uploadItem.appendChild(img);
            uploadItem.appendChild(removeBtn);
            
            console.log('✅ Image preview created successfully');
        };
        
        reader.onerror = function(error) {
            console.error('🔧 FileReader error:', error);
        };
        
        reader.readAsDataURL(file);
    }
}

// Simplified main image upload setup
function setupMainImageUpload() {
    const mainInput = document.getElementById('main-image-input');
    
    if (mainInput) {
        console.log('✅ Main image upload setup - using HTML onchange event');
    } else {
        console.error('❌ Main image input not found');
    }
}





// Image handling functions
function removeExistingImage(imageId) {
    // Count current images
    const currentImageCount = document.querySelectorAll('.existing-image').length;
    const minRequiredImages = 5;
    
    // Show warning if trying to delete when at minimum required images
    if (currentImageCount <= minRequiredImages) {
        showImageDeletionWarning(currentImageCount, minRequiredImages);
        return;
    }
    
    // Standard confirmation for deletion when above minimum
    if (confirm('Bạn có chắc chắn muốn xóa ảnh này?')) {
        // Create form to submit deletion
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/owner/home-image/${imageId}/delete`;
        
        // Add CSRF token if needed
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'csrf_token';
            tokenInput.value = csrfToken.getAttribute('content');
            form.appendChild(tokenInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function showImageDeletionWarning(currentCount, minRequired) {
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white;
        padding: 32px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-width: 450px;
        width: 90%;
        text-align: center;
        animation: modalSlideIn 0.3s ease-out;
    `;
    
    modal.innerHTML = `
        <div style="color: #ef4444; font-size: 48px; margin-bottom: 16px;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="color: #333; margin-bottom: 16px; font-size: 20px;">Không thể xóa ảnh</h3>
        <p style="color: #666; margin-bottom: 24px; line-height: 1.5;">
            Nhà cần có ít nhất <strong>${minRequired} ảnh</strong> để có thể hiển thị.<br>
            Hiện tại bạn có <strong>${currentCount} ảnh</strong>.
        </p>
        <p style="color: #9ed649; margin-bottom: 24px; font-size: 14px;">
            <i class="fas fa-lightbulb" style="margin-right: 8px;"></i>
            Hãy thêm ảnh mới trước khi xóa ảnh hiện tại.
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="closeImageDeletionWarning()" style="
                background: #9ed649;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='#8bc441'" onmouseout="this.style.background='#9ed649'">
                <i class="fas fa-check" style="margin-right: 8px;"></i>
                Đã hiểu
            </button>
        </div>
    `;
    
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    
    // Add animation CSS if not already added
    if (!document.getElementById('modal-animations')) {
        const style = document.createElement('style');
        style.id = 'modal-animations';
        style.textContent = `
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Store reference for closing
    window.currentImageDeletionWarning = backdrop;
}

function closeImageDeletionWarning() {
    if (window.currentImageDeletionWarning) {
        document.body.removeChild(window.currentImageDeletionWarning);
        window.currentImageDeletionWarning = null;
    }
}

// Close modal when clicking backdrop
document.addEventListener('click', function(event) {
    if (window.currentImageDeletionWarning && event.target === window.currentImageDeletionWarning) {
        closeImageDeletionWarning();
    }
});

function updateSelectedAmenitiesDisplay() {
    const container = document.getElementById('selectedAmenities');
    const inputsContainer = document.getElementById('amenityInputs');
    
    if (!container) {
        console.error('selectedAmenities container not found');
        return;
    }
    
    // Clear existing content
    container.innerHTML = '';
    inputsContainer.innerHTML = '';
    
    if (selectedAmenities.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Chưa chọn tiện nghi nào</p>';
        return;
    }
    
    const maxDisplayAmenities = 4;
    const displayedAmenities = selectedAmenities.slice(0, maxDisplayAmenities);
    const hiddenCount = selectedAmenities.length - maxDisplayAmenities;
    
    // Hiển thị các amenity đầu tiên
    displayedAmenities.forEach(amenity => {
        const amenityElement = document.createElement('div');
        amenityElement.className = 'selected-item';
        amenityElement.innerHTML = `
            <span>${amenity.name}</span>
            <span class="remove-item" onclick="removeAmenity(${amenity.id})">&times;</span>
        `;
        container.appendChild(amenityElement);
    });
    
    // Hiển thị badge "+X tiện nghi khác" nếu có nhiều hơn maxDisplayAmenities
    if (hiddenCount > 0) {
        const moreElement = document.createElement('div');
        moreElement.className = 'selected-item';
        moreElement.innerHTML = `+${hiddenCount} tiện nghi khác`;
        moreElement.onclick = () => showAmenityModal();
        container.appendChild(moreElement);
    }
    
    // Thêm hidden inputs cho tất cả amenities
    selectedAmenities.forEach(amenity => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'amenities[]';
        hiddenInput.value = amenity.id;
        inputsContainer.appendChild(hiddenInput);
    });
}

function updateSelectedRulesDisplay() {
    const container = document.getElementById('selectedRules');
    
    if (!container) {
        console.error('selectedRules container not found');
        return;
    }
    
    container.innerHTML = '';
    
    if (selectedRules.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Chưa chọn nội quy nào</p>';
        return;
    }
    
    const maxDisplayRules = 4;
    const displayedRules = selectedRules.slice(0, maxDisplayRules);
    const hiddenCount = selectedRules.length - maxDisplayRules;
    
    // Hiển thị các rule đầu tiên
    displayedRules.forEach(rule => {
        const ruleElement = document.createElement('div');
        ruleElement.className = 'selected-item';
        ruleElement.innerHTML = `
            <span>${rule.name}</span>
            <span class="remove-item" onclick="removeRule(${rule.id})">&times;</span>
            <input type="hidden" name="rules[]" value="${rule.id}">
        `;
        container.appendChild(ruleElement);
    });
    
    // Hiển thị badge "+X nội quy khác" nếu có nhiều hơn maxDisplayRules
    if (hiddenCount > 0) {
        const moreElement = document.createElement('div');
        moreElement.className = 'selected-item';
        moreElement.innerHTML = `+${hiddenCount} nội quy khác`;
        moreElement.onclick = () => showRulesModal();
        container.appendChild(moreElement);
    }
    
    // Thêm hidden inputs cho tất cả rules không hiển thị
    selectedRules.forEach(rule => {
        if (!displayedRules.includes(rule)) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'rules[]';
            hiddenInput.value = rule.id;
            container.appendChild(hiddenInput);
        }
    });
}

function removeAmenity(amenityId) {
    selectedAmenities = selectedAmenities.filter(a => a.id !== amenityId);
    updateSelectedAmenitiesDisplay();
    
    // Update modal display if open
    const modalItem = document.querySelector(`[data-amenity-id="${amenityId}"]`);
    if (modalItem) {
        modalItem.classList.remove('selected');
    }
}

function removeRule(ruleId) {
    selectedRules = selectedRules.filter(r => r.id !== ruleId);
    updateSelectedRulesDisplay();
    
    // Update modal display if open
    const modalItem = document.querySelector(`[data-rule-id="${ruleId}"]`);
    if (modalItem) {
        modalItem.classList.remove('selected');
    }
}

function loadAllAmenities() {
    const amenitySections = document.querySelector('.amenity-sections');
    amenitySections.innerHTML = '';
    
    if (!amenitiesData) {
        amenitySections.innerHTML = '<p>Đang tải dữ liệu tiện nghi...</p>';
        return;
    }
    
    // Tạo section cho mỗi category
    Object.keys(amenitiesData).forEach(categoryCode => {
        const categoryData = amenitiesData[categoryCode];
        const categoryInfo = categoryData.category_info;
        const amenities = categoryData.amenities;
        
        const sectionElement = document.createElement('div');
        sectionElement.className = 'amenity-section';
        
        sectionElement.innerHTML = `
            <h4 class="section-title">
                <i class="${categoryInfo.icon}"></i>${categoryInfo.name}
            </h4>
            <div class="amenities-grid">
                ${amenities.map(amenity => `
                    <div class="amenity-item ${selectedAmenities.some(a => a.id === amenity.id) ? 'selected' : ''}" 
                         data-amenity-id="${amenity.id}"
                         onclick="toggleAmenitySelection(${amenity.id}, '${amenity.name}', '${amenity.icon}')">
                        <i class="${amenity.icon}"></i>
                        <span class="amenity-text">${amenity.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        amenitySections.appendChild(sectionElement);
    });
}

function loadAllRules() {
    const rulesSections = document.querySelector('.rules-sections');
    rulesSections.innerHTML = '';
    
    if (!rulesData) {
        rulesSections.innerHTML = '<p>Đang tải dữ liệu nội quy...</p>';
        return;
    }
    
    Object.keys(rulesData).forEach(categoryCode => {
        const rules = rulesData[categoryCode];
        const categoryNames = {
            'smoking': 'Hút thuốc',
            'pets': 'Thú cưng', 
            'children': 'Trẻ em',
            'party': 'Tiệc tùng',
            'time': 'Thời gian',
            'behavior': 'Hành vi'
        };
        
        const sectionElement = document.createElement('div');
        sectionElement.className = 'rule-section';
        
        sectionElement.innerHTML = `
            <h4 class="section-title">
                <i class="fas fa-shield-alt"></i>${categoryNames[categoryCode] || categoryCode}
            </h4>
            <div class="rules-grid">
                ${rules.map(rule => `
                    <div class="rule-item ${selectedRules.some(r => r.id === rule.id) ? 'selected' : ''}" 
                         data-rule-id="${rule.id}"
                         onclick="toggleRuleSelection(${rule.id}, '${rule.name}')">
                        <span class="rule-text">${rule.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        rulesSections.appendChild(sectionElement);
    });
}

function toggleAmenitySelection(amenityId, amenityName, amenityIcon) {
    const item = document.querySelector(`[data-amenity-id="${amenityId}"]`);
    const isCurrentlySelected = item.classList.contains('selected');
    
    if (!isCurrentlySelected) {
        selectedAmenities.push({id: amenityId, name: amenityName, icon: amenityIcon});
        item.classList.add('selected');
    } else {
        selectedAmenities = selectedAmenities.filter(a => a.id !== amenityId);
        item.classList.remove('selected');
    }
    
    updateSelectedAmenitiesDisplay();
}

function toggleRuleSelection(ruleId, ruleName) {
    const item = document.querySelector(`[data-rule-id="${ruleId}"]`);
    const isCurrentlySelected = item.classList.contains('selected');
    
    if (!isCurrentlySelected) {
        selectedRules.push({id: ruleId, name: ruleName});
        item.classList.add('selected');
    } else {
        selectedRules = selectedRules.filter(r => r.id !== ruleId);
        item.classList.remove('selected');
    }
    
    updateSelectedRulesDisplay();
}

function deleteHome() {
    if (confirm('Bạn có chắc chắn muốn xóa nhà này? Hành động này không thể hoàn tác.')) {
        window.location.href = "{{ url_for('owner.delete_home', home_id=home.id) }}";
    }
}

// Form submission handling
document.getElementById('edit-home-form').addEventListener('submit', function(e) {
    // Validate price requirement before submission
    if (!validateEditHomePricing()) {
        e.preventDefault(); // Prevent form submission
        return false;
    }
    
    // Convert formatted prices back to numbers for backend
    const hourlyPriceInput = document.querySelector('input[name="hourly_price"]');
    const nightlyPriceInput = document.querySelector('input[name="nightly_price"]');
    
    if (hourlyPriceInput && hourlyPriceInput.value) {
        // Remove formatting and convert to number
        const rawValue = hourlyPriceInput.value.replace(/[.,]/g, '');
        hourlyPriceInput.value = rawValue;
    }
    
    if (nightlyPriceInput && nightlyPriceInput.value) {
        // Remove formatting and convert to number
        const rawValue = nightlyPriceInput.value.replace(/[.,]/g, '');
        nightlyPriceInput.value = rawValue;
    }
    
    // Add selected rental type to form
    const rentalTypeInput = document.createElement('input');
    rentalTypeInput.type = 'hidden';
    rentalTypeInput.name = 'selected_rental_type';
    rentalTypeInput.value = document.querySelector('input[name="rental_type"]:checked')?.value || 'nightly';
    this.appendChild(rentalTypeInput);
});

// Validate pricing requirement for edit home with minimum 10,000 VND
function validateEditHomePricing() {
    const minPrice = 10000; // Minimum 10,000 VND
    const hourlyPriceInput = document.querySelector('input[name="hourly_price"]');
    const nightlyPriceInput = document.querySelector('input[name="nightly_price"]');
    
    let priceToCheck = null;
    let priceType = '';
    let currentPrice = 0;
    
    // Check which rental type is selected and get corresponding price
    const hourlyRadio = document.getElementById('hourly');
    const nightlyRadio = document.getElementById('nightly');
    
    if (hourlyRadio && hourlyRadio.checked) {
        priceToCheck = hourlyPriceInput;
        priceType = 'theo giờ';
        currentPrice = parseInt(getNumericPriceValue(hourlyPriceInput)) || 0;
    } else if (nightlyRadio && nightlyRadio.checked) {
        priceToCheck = nightlyPriceInput;
        priceType = 'theo đêm';
        currentPrice = parseInt(getNumericPriceValue(nightlyPriceInput)) || 0;
    }
    
    // If no rental type selected
    if (!priceToCheck) {
        showEditPriceValidationAlert('Vui lòng chọn hình thức cho thuê và nhập giá.');
        return false;
    }
    
    // Check if price is entered and meets minimum requirement
    if (currentPrice < minPrice) {
        const formattedMinPrice = minPrice.toLocaleString('vi-VN');
        const formattedCurrentPrice = currentPrice > 0 ? currentPrice.toLocaleString('vi-VN') : '0';
        
        showEditPriceValidationAlert(
            `Giá ${priceType} phải ít nhất ${formattedMinPrice}đ.<br>` +
            `Hiện tại: ${formattedCurrentPrice}đ`
        );
        
        // Highlight the price field
        highlightEditPriceField(priceToCheck);
        
        return false;
    }
    
    return true;
}

// Get numeric price value from formatted input
function getNumericPriceValue(input) {
    if (!input) return '';
    
    // Check data-value attribute first
    const dataValue = input.getAttribute('data-value');
    if (dataValue) {
        return dataValue;
    }
    
    // Fallback: remove formatting from value
    return input.value.replace(/[^\d]/g, '');
}

// Show price validation alert for edit home
function showEditPriceValidationAlert(message) {
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white;
        padding: 32px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-width: 450px;
        width: 90%;
        text-align: center;
        animation: modalSlideIn 0.3s ease-out;
    `;
    
    modal.innerHTML = `
        <div style="color: #f59e0b; font-size: 48px; margin-bottom: 16px;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="color: #333; margin-bottom: 16px; font-size: 20px;">Giá chưa hợp lệ</h3>
        <p style="color: #666; margin-bottom: 24px; line-height: 1.5;">
            ${message}
        </p>
        <p style="color: #9ed649; margin-bottom: 24px; font-size: 14px;">
            <i class="fas fa-lightbulb" style="margin-right: 8px;"></i>
            Vui lòng nhập giá hợp lệ để cập nhật homestay.
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="closeEditPriceAlert()" style="
                background: #9ed649;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='#8bc441'" onmouseout="this.style.background='#9ed649'">
                <i class="fas fa-check" style="margin-right: 8px;"></i>
                Đã hiểu
            </button>
        </div>
    `;
    
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    
    // Add animation CSS if not already added
    if (!document.getElementById('edit-modal-animations')) {
        const style = document.createElement('style');
        style.id = 'edit-modal-animations';
        style.textContent = `
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Store reference for closing
    window.currentEditPriceAlert = backdrop;
}

// Highlight price field with error styling for edit home
function highlightEditPriceField(priceInput) {
    if (!priceInput) return;
    
    priceInput.style.border = '2px solid #ef4444';
    priceInput.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
    
    // Remove highlight when user starts typing
    const removeHighlight = function() {
        priceInput.style.border = '';
        priceInput.style.boxShadow = '';
        priceInput.removeEventListener('input', removeHighlight);
    };
    
    priceInput.addEventListener('input', removeHighlight);
}

function closeEditPriceAlert() {
    if (window.currentEditPriceAlert) {
        document.body.removeChild(window.currentEditPriceAlert);
        window.currentEditPriceAlert = null;
    }
}

// Close modal when clicking backdrop
document.addEventListener('click', function(event) {
    if (window.currentEditPriceAlert && event.target === window.currentEditPriceAlert) {
        closeEditPriceAlert();
    }
});

// Add image to upload grid
function addImageToUploadGrid(file) {
    const uploadGrid = document.querySelector('.upload-grid');
    const addMoreButton = uploadGrid.querySelector('.add-more');
    
    if (!uploadGrid || !addMoreButton) {
        console.error('❌ Upload grid or add more button not found');
        return;
    }
    
    console.log('📸 Adding image to grid:', file.name);
    
    // Create new upload item
    const newUploadItem = document.createElement('div');
    newUploadItem.className = 'upload-item';
    newUploadItem.style.cssText = `
        position: relative;
        width: calc(33.333% - 7px);
        height: 120px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
    `;
    
    // Create file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = 'images[]';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    
    // Create placeholder (initially hidden since we'll show preview)
    const placeholder = document.createElement('div');
    placeholder.className = 'upload-placeholder';
    placeholder.innerHTML = '<i class="bi bi-camera"></i>';
    placeholder.style.cssText = `
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 14px;
    `;
    
    // Add elements to upload item
    newUploadItem.appendChild(fileInput);
    newUploadItem.appendChild(placeholder);
    
    // Insert before "add-more" button
    uploadGrid.insertBefore(newUploadItem, addMoreButton);
    
    // Set the file to the input
    try {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        console.log('✅ File set to input successfully');
        } catch (error) {
        console.error('❌ Error setting file to input:', error);
    }
    
    // Show preview directly
    showFilePreview(file, newUploadItem);
    
    console.log('✅ Image added to grid successfully');
}

// Show file preview for new images
function showFilePreview(file, uploadItem) {
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('📸 Creating preview for:', file.name);
            
            // Create preview image
            const img = document.createElement('img');
            img.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 5;
                border-radius: 8px;
            `;
            img.src = e.target.result;
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '×';
            removeBtn.type = 'button';
            removeBtn.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 20px;
                height: 20px;
                border: none;
                background: rgba(220, 53, 69, 0.8);
                color: white;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
                z-index: 15;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🗑️ Removing image preview');
                // Remove the entire upload item
                uploadItem.remove();
            });
            
            // Add image and remove button to upload item
            uploadItem.appendChild(img);
            uploadItem.appendChild(removeBtn);
            
            console.log('✅ Preview created successfully');
            };
        
        reader.onerror = function(error) {
            console.error('❌ FileReader error:', error);
        };
        
        reader.readAsDataURL(file);
    } else {
        console.error('❌ Invalid file type:', file.type);
    }
}


</script>
{% endblock %}
