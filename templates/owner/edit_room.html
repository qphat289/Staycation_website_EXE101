{% extends 'base.html' %}
{% block title %}Chỉnh sửa phòng{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    body {
        background: #f8fdf4;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .edit-container {
        max-width: 1400px;
        margin: -50px auto 0 auto;
        padding: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .back-link {
        display: flex;
        align-items: center;
        color: #666;
        text-decoration: none;
        font-size: 14px;
    }

    .back-link i {
        margin-right: 8px;
    }

    .save-btn {
        background: #9ed649;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(158, 214, 73, 0.3);
    }

    .save-btn:hover {
        background: #8bc441;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(158, 214, 73, 0.4);
    }

    .main-content {
        display: grid;
        grid-template-columns: 6fr 4fr;
        gap: 30px;
    }

    .form-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .form-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        color: #555;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
    }

    .form-input:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
    }

    .form-select:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        background: white;
        color: #333;
    }

    .textarea:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .counter-group {
        display: flex;
        gap: 30px;
        margin-bottom: 20px;
    }

    .counter-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .counter-label {
        font-size: 14px;
        color: #555;
        font-weight: 500;
    }

    .counter-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 4px;
    }

    .counter-btn {
        width: 30px;
        height: 30px;
        border: none;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #666;
        transition: all 0.2s ease;
    }

    .counter-btn:hover {
        background: #9ed649;
        color: white;
    }

    .counter-value {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        min-width: 30px;
        text-align: center;
    }

    .property-type-selection {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .property-option {
        position: relative;
    }

    .property-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .property-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 80px;
        text-align: center;
    }

    .property-label:hover {
        border-color: #9ed649;
        background-color: #f8fff0;
    }

    .property-radio:checked + .property-label {
        border-color: #9ed649;
        background-color: #f0f9e8;
        box-shadow: 0 2px 8px rgba(158, 214, 73, 0.3);
    }

    .property-icon {
        margin-bottom: 8px;
        font-size: 24px;
        color: #666;
        transition: color 0.3s ease;
    }

    .property-radio:checked + .property-label .property-icon {
        color: #9ed649;
    }

    .property-text {
        font-size: 14px;
        font-weight: 500;
        color: #333;
    }

    .rental-type-selection {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .rental-option {
        position: relative;
    }

    .rental-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .rental-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        min-width: 120px;
        justify-content: center;
    }

    .rental-label:hover {
        border-color: #9ed649;
        background-color: #f8fff0;
    }

    .rental-radio:checked + .rental-label {
        border-color: #9ed649;
        background-color: #f0f9e8;
        color: #9ed649;
        font-weight: 600;
    }

    .price-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .price-input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
    }

    .price-input:focus {
        outline: none;
        border-color: #9ed649;
        box-shadow: 0 0 0 3px rgba(158, 214, 73, 0.1);
    }

    .currency-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }

    .image-upload-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        height: fit-content;
    }

    .upload-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        max-width: 100%;
        width: 100%;
    }

    .upload-item {
        position: relative;
        aspect-ratio: 1;
        border: 2px dashed #ddd;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 140px;
        max-width: 160px;
    }

    .upload-label {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(158, 214, 73, 0.9);
        color: white;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 4px;
        z-index: 2;
        font-weight: 500;
    }

    .upload-item.add-more {
        background: #f9f9f9;
        border-color: #9ed649;
        border-style: dashed;
        cursor: pointer;
    }

    .upload-item.add-more .upload-placeholder {
        background: transparent;
    }

    .upload-item.add-more .upload-placeholder i {
        font-size: 24px;
        color: #9ed649;
    }

    .upload-item:hover {
        border-color: #9ed649;
        background: #f8fff0;
    }

    .main-image-upload {
        cursor: pointer !important;
        border: 2px dashed #9ed649 !important;
    }

    .main-image-upload:hover {
        background: #f0f9e8 !important;
        transform: scale(1.02);
    }

    .upload-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: #999;
        font-size: 14px;
        cursor: pointer;
        z-index: 5;
    }

    .upload-placeholder i {
        font-size: 24px;
        color: #9ed649;
    }

    .upload-item input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 10;
        top: 0;
        left: 0;
    }

    .upload-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
    }

    .existing-image {
        position: relative;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        overflow: hidden;
    }

    .existing-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .existing-image:hover .image-overlay {
        opacity: 1;
    }

    .featured-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #9ed649;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .remove-image-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
    }

    .remove-image-btn:hover {
        background: #c82333;
        top: 0;
        left: 0;
    }

    .remove-image {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
        z-index: 15;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-image:hover {
        background: rgba(220, 53, 69, 1);
    }

    .selected-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }

    .selected-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: #f0f9e8;
        border: 1px solid #9ed649;
        border-radius: 6px;
        font-size: 14px;
        color: #2d5a2d;
    }

    .remove-item {
        color: #666;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        padding: 0 4px;
        border-radius: 50%;
        transition: all 0.2s ease;
        margin-left: 8px;
    }

    .remove-item:hover {
        background: #dc3545;
        color: white;
    }

    .add-btn {
        background: transparent;
        color: #333;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }

    .add-btn:hover {
        color: #9ed649;
        border-color: #9ed649;
    }

    .location-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .location-inputs {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .actions {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-secondary {
        background: white;
        color: #666;
        border: 1px solid #ddd;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: #f8f9fa;
        border-color: #bbb;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
        border: 1px solid #dc3545;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-danger:hover {
        background: #c82333;
        border-color: #bd2130;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 70px;
        right: 0;
        transform: none;
        background: white;
        border-radius: 12px 0 0 12px;
        padding: 30px;
        max-width: 700px;
        width: 650px;
        height: calc(100vh - 70px);
        overflow-y: auto;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e5e5;
    }

    .modal-header h3 {
        margin: 0;
        color: #333;
        font-size: 18px;
        font-weight: 600;
    }

    .modal-header button {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
    }

    .amenity-sections, .rules-sections {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    .amenity-section, .rule-section {
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 20px;
        background: #fafafa;
    }

    .section-title {
        color: #333;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #9ed649;
        display: flex;
        align-items: center;
    }

    .section-title i {
        color: #9ed649;
        margin-right: 8px;
    }

    .amenities-grid, .rules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
    }

    .amenity-item, .rule-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
    }

    .amenity-item:hover, .rule-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #9ed649;
    }

    .amenity-item.selected, .rule-item.selected {
        background-color: #e8f5e8;
        border-color: #9ed649;
    }

    .amenity-item.selected::after, .rule-item.selected::after {
        content: '✔';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ed649;
        font-weight: bold;
        font-size: 16px;
    }

    .amenity-item i {
        font-size: 18px;
        color: #9ed649;
        min-width: 20px;
        margin-right: 10px;
    }

    .amenity-text, .rule-text {
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="header">
        <a href="{{ url_for('owner.dashboard') }}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay lại danh sách phòng
        </a>
        <button type="submit" form="edit-room-form" class="save-btn">
            <i class="fas fa-save"></i>
            Lưu thay đổi
        </button>
    </div>

    <form id="edit-room-form" method="post" enctype="multipart/form-data">
        <div class="main-content">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Basic Information -->
                <div class="form-section">
                    <h3 class="section-title">Thông tin cơ bản</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Tiêu đề phòng</label>
                        <input type="text" name="room_title" class="form-input" 
                               value="{{ room.title or '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Mô tả phòng</label>
                        <textarea name="room_description" class="textarea" required>{{ room.description or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Loại hình phòng</label>
                        <div class="property-type-selection">
                            <div class="property-option">
                                <input type="radio" id="house" name="property_type" value="house" class="property-radio" 
                                       {% if room.property_type == 'house' %}checked{% endif %}>
                                <label for="house" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="property-text">Nhà</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="apartment" name="property_type" value="apartment" class="property-radio"
                                       {% if room.property_type == 'apartment' %}checked{% endif %}>
                                <label for="apartment" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="property-text">Căn hộ</div>
                                </label>
                            </div>
                            <div class="property-option">
                                <input type="radio" id="hotel" name="property_type" value="hotel" class="property-radio"
                                       {% if room.property_type == 'hotel' %}checked{% endif %}>
                                <label for="hotel" class="property-label">
                                    <div class="property-icon">
                                        <i class="fas fa-hotel"></i>
                                    </div>
                                    <div class="property-text">Khách sạn</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room Details -->
                <div class="form-section">
                    <h3 class="section-title">Chi tiết phòng</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Sức chứa phòng</label>
                        <div class="counter-group">
                            <div class="counter-item">
                                <span class="counter-label">Phòng tắm</span>
                                <div class="counter-controls">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('bathroom')">-</button>
                                    <span class="counter-value" id="bathroom-count">{{ room.bathroom_count or 1 }}</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('bathroom')">+</button>
                                </div>
                                <input type="hidden" name="bathroom_count" id="bathroom_count_input" value="{{ room.bathroom_count or 1 }}">
                            </div>
                            <div class="counter-item">
                                <span class="counter-label">Giường</span>
                                <div class="counter-controls">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('bed')">-</button>
                                    <span class="counter-value" id="bed-count">{{ room.bed_count or 1 }}</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('bed')">+</button>
                                </div>
                                <input type="hidden" name="bed_count" id="bed_count_input" value="{{ room.bed_count or 1 }}">
                            </div>
                            <div class="counter-item">
                                <span class="counter-label">Khách</span>
                                <div class="counter-controls">
                                    <button type="button" class="counter-btn" onclick="decreaseCount('guest')">-</button>
                                    <span class="counter-value" id="guest-count">{{ room.guest_count or 1 }}</span>
                                    <button type="button" class="counter-btn" onclick="increaseCount('guest')">+</button>
                                </div>
                                <input type="hidden" name="guest_count" id="guest_count_input" value="{{ room.guest_count or 1 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hình thức cho thuê</label>
                        <div class="rental-type-selection">
                            <div class="rental-option">
                                <input type="radio" id="hourly" name="rental_type" value="hourly" class="rental-radio"
                                       {% if room.rental_type == 'hourly' %}checked{% endif %}>
                                <label for="hourly" class="rental-label">
                                    <i class="fas fa-clock"></i>
                                    <span>Theo giờ</span>
                                </label>
                            </div>
                            <div class="rental-option">
                                <input type="radio" id="nightly" name="rental_type" value="nightly" class="rental-radio"
                                       {% if room.rental_type == 'nightly' %}checked{% endif %}>
                                <label for="nightly" class="rental-label">
                                    <i class="fas fa-moon"></i>
                                    <span>Qua đêm</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Giá phòng</label>
                        <div id="hourly-pricing" style="display: {% if room.rental_type == 'hourly' %}block{% else %}none{% endif %};">
                            <div class="price-input-group">
                                <span class="currency-label">VND</span>
                                <input type="text" name="hourly_price" class="price-input" 
                                       placeholder="Nhập giá theo giờ" 
                                       value="{% if room.hourly_price and room.hourly_price > 0 %}{{ '{:,}'.format(room.hourly_price).replace(',', '.') }}{% endif %}"
                                       oninput="formatPriceInput(this)">
                            </div>
                        </div>
                        <div id="nightly-pricing" style="display: {% if room.rental_type == 'nightly' %}block{% else %}none{% endif %};">
                            <div class="price-input-group">
                                <span class="currency-label">VND</span>
                                <input type="text" name="nightly_price" class="price-input" 
                                       placeholder="Nhập giá qua đêm" 
                                       value="{% if room.nightly_price and room.nightly_price > 0 %}{{ '{:,}'.format(room.nightly_price).replace(',', '.') }}{% endif %}"
                                       oninput="formatPriceInput(this)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amenities -->
                <div class="form-section">
                    <h3 class="section-title">Tiện nghi</h3>
                    <div class="form-group">
                        <div class="selected-items" id="selectedAmenities">
                            <!-- Selected amenities will be populated here -->
                        </div>
                        <button type="button" class="add-btn" onclick="showAmenityModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Thêm tiện nghi</span>
                        </button>
                        <div id="amenityInputs"></div>
                    </div>
                </div>

                <!-- Rules -->
                <div class="form-section">
                    <h3 class="section-title">Nội quy</h3>
                    <div class="form-group">
                        <div class="selected-items" id="selectedRules">
                            <!-- Selected rules will be populated here -->
                        </div>
                        <button type="button" class="add-btn" onclick="showRulesModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Thêm nội quy</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Image Upload -->
                <div class="form-section">
                    <h3>Hình ảnh phòng</h3>
                    <div class="form-content">
                        <div class="upload-grid">
                            <!-- Display existing images first -->
                            {% if room.images %}
                                {% for image in room.images %}
                                <div class="upload-item existing-image">
                                    {% if image.is_featured %}
                                    <span class="upload-label">Ảnh bìa</span>
                                    {% endif %}
                                    <img src="/static/{{ image.path }}" alt="Room image" class="existing-img">
                                    <div class="image-overlay">
                                        <button type="button" class="remove-image-btn" onclick="removeExistingImage({{ image.id }})">
                                            <i class="bi bi-x-circle-fill"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            <!-- Upload slot for new main image - always show for testing -->
                            {% set has_main_image = room.images and room.images|selectattr('is_featured', 'equalto', True)|list|length > 0 %}
                            <!-- Temporarily always show for testing -->
                            <div class="upload-item main-image-upload">
                                <span class="upload-label">{% if has_main_image %}Thay ảnh bìa{% else %}Ảnh bìa{% endif %}</span>
                                <input type="file" name="main_image" accept="image/*" id="main-image-input" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 20;" onchange="if(this.files[0]) { testPreview(this); }">
                                <div class="upload-placeholder" style="pointer-events: none;">
                                    <i class="bi bi-camera"></i>
                                    <span>{% if has_main_image %}Thay đổi{% else %}Chọn ảnh{% endif %}</span>
                                </div>
                            </div>
                            
                            <div class="upload-item add-more">
                                <div class="upload-placeholder">
                                    <i class="bi bi-plus-circle"></i>
                                    <span>Thêm ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location -->
                <div class="location-section">
                    <h3 class="section-title">Vị trí</h3>
                    <div class="location-inputs">
                        <select name="province" id="province" class="form-select" onchange="updateDistricts()">
                            <option value="" disabled>Tỉnh/Thành phố</option>
                            <option value="hcm" {% if room.province == 'hcm' %}selected{% endif %}>TP. Hồ Chí Minh</option>
                            <option value="hanoi" {% if room.province == 'hanoi' %}selected{% endif %}>Hà Nội</option>
                        </select>
                        <select name="district" id="district" class="form-select" onchange="updateWards()">
                            <option value="" disabled {% if not room.district %}selected{% endif %}>Quận/Huyện</option>
                        </select>
                        <select name="ward" id="ward" class="form-select">
                            <option value="" disabled {% if not room.ward %}selected{% endif %}>Phường/Xã</option>
                        </select>
                        <input type="text" name="street" class="form-input" 
                               placeholder="Số nhà, tên đường" 
                               value="{{ room.street or '' }}" required>
                    </div>

                </div>
            </div>
        </div>

    </form>
</div>

<!-- Include modals from add_room.html for amenities and rules -->
<!-- Amenity Modal -->
<div id="amenityModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chọn tiện nghi</h3>
            <button type="button" onclick="closeAmenityModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="amenity-sections">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Rules Modal -->
<div id="rulesModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chọn nội quy</h3>
            <button type="button" onclick="closeRulesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="rules-sections">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
// Include JavaScript from add_room.html for functionality  
let selectedAmenities = {{ (room.amenities if room else [])|tojson|safe }};
let selectedRules = {{ (room.rules if room else [])|tojson|safe }};
let locationData = null;
let amenitiesData = null;
let rulesData = null;

// Counter functions
function increaseCount(type) {
    const element = document.getElementById(`${type}-count`);
    let count = parseInt(element.textContent);
    count++;
    element.textContent = count;
    document.getElementById(`${type}_count_input`).value = count;
}

function decreaseCount(type) {
    const element = document.getElementById(`${type}-count`);
    let count = parseInt(element.textContent);
    if (count > 1) {
        count--;
        element.textContent = count;
        document.getElementById(`${type}_count_input`).value = count;
    }
}

// Price formatting
function formatPriceInput(input) {
    let value = input.value.replace(/[^\d]/g, '');
    if (value) {
        const numValue = parseInt(value);
        const formatted = numValue.toLocaleString('vi-VN');
        input.value = formatted;
        input.setAttribute('data-value', value);
    }
}

// Rental type change
document.addEventListener('DOMContentLoaded', function() {
    const hourlyRadio = document.getElementById('hourly');
    const nightlyRadio = document.getElementById('nightly');
    
    if (hourlyRadio) {
        hourlyRadio.addEventListener('change', function() {
            if (this.checked) {
                updatePricingDisplay();
            }
        });
    }
    
    if (nightlyRadio) {
        nightlyRadio.addEventListener('change', function() {
            if (this.checked) {
                updatePricingDisplay();
            }
        });
    }

    // Load initial data and setup displays
    Promise.all([
        loadLocationData(),
        loadAmenitiesData(),
        loadRulesData()
    ]).then(() => {
        // Fill location after data is loaded
        fillCurrentLocation();
        
        // Update displays after data is loaded
        updateSelectedAmenitiesDisplay();
        updateSelectedRulesDisplay();
        
        // Load existing room rules and amenities
        loadExistingRulesAndAmenities();
    });

    // Setup main image upload
    setupMainImageUpload();
    
    // Setup add more images functionality
    setupAddMoreImages();
});

function updatePricingDisplay() {
    const hourlyRadio = document.getElementById('hourly');
    const nightlyRadio = document.getElementById('nightly');
    const hourlyPricing = document.getElementById('hourly-pricing');
    const nightlyPricing = document.getElementById('nightly-pricing');
    
    if (hourlyRadio.checked) {
        hourlyPricing.style.display = 'block';
        nightlyPricing.style.display = 'none';
    } else if (nightlyRadio.checked) {
        nightlyPricing.style.display = 'block';
        hourlyPricing.style.display = 'none';
    }
}

// Load APIs and populate data (include the same functions from add_room.html)
async function loadLocationData() {
    try {
        const response = await fetch('/api/locations/all');
        const result = await response.json();
        if (result.success) {
            locationData = result.data;
            // Auto-fill current location
            fillCurrentLocation();
        }
    } catch (error) {
        console.error('Error loading location data:', error);
    }
}

async function loadAmenitiesData() {
    try {
        const response = await fetch('/api/amenities');
        const result = await response.json();
        if (result.success) {
            amenitiesData = result.data;
            }
    } catch (error) {
        console.error('Error loading amenities data:', error);
    }
}

async function loadRulesData() {
    try {
        const response = await fetch('/api/rules');
        const result = await response.json();
        if (result.success) {
            rulesData = result.data;
            }
    } catch (error) {
        console.error('Error loading rules data:', error);
    }
}

function fillCurrentLocation() {
    // Fill saved location data
    {% if room.province %}
    document.getElementById('province').value = '{{ room.province }}';
    updateDistricts();
    setTimeout(() => {
        {% if room.district %}
        document.getElementById('district').value = '{{ room.district }}';
        updateWards();
        setTimeout(() => {
            {% if room.ward %}
            // Try to find and select the ward
            const wardSelect = document.getElementById('ward');
            const wardOptions = wardSelect.options;
            for (let i = 0; i < wardOptions.length; i++) {
                if (wardOptions[i].textContent.trim() === '{{ room.ward }}') {
                    wardSelect.value = wardOptions[i].value;
                    break;
                }
            }
            {% endif %}
        }, 1000);
        {% endif %}
    }, 500);
    {% endif %}
}

// Function to load existing room rules and amenities
function loadExistingRulesAndAmenities() {
    // Clear current selections first
    selectedRules = [];
    selectedAmenities = [];
    
    // Load amenities from room data
    const roomAmenities = {{ (room.amenities if room else [])|tojson|safe }};
    if (roomAmenities && Array.isArray(roomAmenities)) {
        roomAmenities.forEach(amenity => {
            if (amenity.id && amenity.name) {
                selectedAmenities.push({
                    id: amenity.id,
                    name: amenity.name,
                    icon: amenity.icon || 'fas fa-check'
                });
            }
        });
    }
    
    // Load rules from room data
    const roomRules = {{ (room.rules if room else [])|tojson|safe }};
    if (roomRules && Array.isArray(roomRules)) {
        roomRules.forEach(rule => {
            if (rule.id && rule.name) {
                selectedRules.push({
                    id: rule.id,
                    name: rule.name
                });
            }
        });
    }
    
    // Update displays after loading
    updateSelectedAmenitiesDisplay();
    updateSelectedRulesDisplay();
    
    }

// Note: Duplicate functions removed - using the ones defined above

// Location update functions
function updateDistricts() {
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    
    // Reset districts and wards
    districtSelect.innerHTML = '<option value="" disabled selected>Quận/Huyện</option>';
    wardSelect.innerHTML = '<option value="" disabled selected>Phường/Xã</option>';
    wardSelect.disabled = true;
    
    const selectedProvince = provinceSelect.value;
    
    if (selectedProvince && locationData && locationData[selectedProvince]) {
        // Enable district dropdown
        districtSelect.disabled = false;
        
        // Populate districts
        const districts = locationData[selectedProvince].districts;
        const sortedDistricts = Object.entries(districts).sort((a, b) => {
            const nameA = a[1].name;
            const nameB = b[1].name;
            const getNumber = (name) => {
                const match = name.match(/(\d+)/);
                return match ? parseInt(match[1]) : 999;
            };
            const numA = getNumber(nameA);
            const numB = getNumber(nameB);
            if (numA !== 999 && numB !== 999) {
                return numA - numB;
            }
            return nameA.localeCompare(nameB, 'vi');
        });
        
        sortedDistricts.forEach(([key, district]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = district.name;
            districtSelect.appendChild(option);
        });
    } else {
        districtSelect.disabled = true;
    }
}

function updateWards() {
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    
    // Reset wards
    wardSelect.innerHTML = '<option value="" disabled selected>Phường/Xã</option>';
    
    const selectedProvince = provinceSelect.value;
    const selectedDistrict = districtSelect.value;
    
    if (selectedProvince && selectedDistrict && 
        locationData && locationData[selectedProvince] && 
        locationData[selectedProvince].districts[selectedDistrict]) {
        
        // Enable ward dropdown
        wardSelect.disabled = false;
        
        // Populate wards
        const wards = locationData[selectedProvince].districts[selectedDistrict].wards;
        const sortedWards = wards.slice().sort((a, b) => {
            const getNumber = (name) => {
                const match = name.match(/(\d+)/);
                return match ? parseInt(match[1]) : 999;
            };
            const numA = getNumber(a);
            const numB = getNumber(b);
            if (numA !== 999 && numB !== 999) {
                return numA - numB;
            }
            return a.localeCompare(b, 'vi');
        });
        
        sortedWards.forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            wardSelect.appendChild(option);
        });
    } else {
        wardSelect.disabled = true;
    }
}

// Modal functions
function showAmenityModal() {
    document.getElementById('amenityModal').style.display = 'block';
    loadAllAmenities();
}

function closeAmenityModal() {
    document.getElementById('amenityModal').style.display = 'none';
}

function showRulesModal() {
    document.getElementById('rulesModal').style.display = 'block';
    loadAllRules();
}

function closeRulesModal() {
    document.getElementById('rulesModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const amenityModal = document.getElementById('amenityModal');
    const rulesModal = document.getElementById('rulesModal');
    
    if (event.target == amenityModal) {
        closeAmenityModal();
    }
    
    if (event.target == rulesModal) {
        closeRulesModal();
    }
}

// Image handling functions
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const uploadItem = input.closest('.upload-item');
            const placeholder = uploadItem.querySelector('.upload-placeholder');
            
            if (!uploadItem) {
                console.error('🔧 Upload item not found');
                return;
            }
            
            // Remove existing preview if any
            const existingPreview = uploadItem.querySelector('.preview-img');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Remove existing remove button if any
            const existingRemoveBtn = uploadItem.querySelector('.remove-preview-btn');
            if (existingRemoveBtn) {
                existingRemoveBtn.remove();
            }
            
            // Create preview image
            const preview = document.createElement('img');
            preview.className = 'preview-img';
            preview.style.cssText = 'width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; border-radius: 8px; z-index: 5;';
            // Create remove button for preview
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-preview-btn';
            removeBtn.type = 'button';
            removeBtn.innerHTML = '×';
            removeBtn.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 20px;
                height: 20px;
                border: none;
                background: rgba(220, 53, 69, 0.8);
                color: white;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
                z-index: 25;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Reset the file input
                input.value = '';
                // Remove preview and show placeholder
                preview.remove();
                removeBtn.remove();
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            });
            
            // Set the image source
            try {
                preview.src = e.target.result;
                } catch (error) {
                console.error('🔧 Error setting preview src:', error);
                console.error('🔧 Preview element:', preview);
                console.error('🔧 e.target.result:', e.target.result);
                return;
            }
            
            // Hide placeholder and add preview elements
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            uploadItem.appendChild(preview);
            uploadItem.appendChild(removeBtn);
            
            };
        reader.readAsDataURL(input.files[0]);
    }
}

function removeExistingImage(imageId) {
    if (confirm('Bạn có chắc chắn muốn xóa ảnh này?')) {
        // Create form to submit deletion
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/owner/room-image/${imageId}/delete`;
        
        // Add CSRF token if needed
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'csrf_token';
            tokenInput.value = csrfToken.getAttribute('content');
            form.appendChild(tokenInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function updateSelectedAmenitiesDisplay() {
    const container = document.getElementById('selectedAmenities');
    const inputsContainer = document.getElementById('amenityInputs');
    
    if (!container) {
        console.error('selectedAmenities container not found');
        return;
    }
    
    // Clear existing content
    container.innerHTML = '';
    inputsContainer.innerHTML = '';
    
    if (selectedAmenities.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Chưa chọn tiện nghi nào</p>';
        return;
    }
    
    const maxDisplayAmenities = 4;
    const displayedAmenities = selectedAmenities.slice(0, maxDisplayAmenities);
    const hiddenCount = selectedAmenities.length - maxDisplayAmenities;
    
    // Hiển thị các amenity đầu tiên
    displayedAmenities.forEach(amenity => {
        const amenityElement = document.createElement('div');
        amenityElement.className = 'selected-item';
        amenityElement.innerHTML = `
            <span>${amenity.name}</span>
            <span class="remove-item" onclick="removeAmenity(${amenity.id})">&times;</span>
        `;
        container.appendChild(amenityElement);
    });
    
    // Hiển thị badge "+X tiện nghi khác" nếu có nhiều hơn maxDisplayAmenities
    if (hiddenCount > 0) {
        const moreElement = document.createElement('div');
        moreElement.className = 'selected-item';
        moreElement.innerHTML = `+${hiddenCount} tiện nghi khác`;
        moreElement.onclick = () => showAmenityModal();
        container.appendChild(moreElement);
    }
    
    // Thêm hidden inputs cho tất cả amenities
    selectedAmenities.forEach(amenity => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'amenities[]';
        hiddenInput.value = amenity.id;
        inputsContainer.appendChild(hiddenInput);
    });
}

function updateSelectedRulesDisplay() {
    const container = document.getElementById('selectedRules');
    
    if (!container) {
        console.error('selectedRules container not found');
        return;
    }
    
    container.innerHTML = '';
    
    if (selectedRules.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Chưa chọn nội quy nào</p>';
        return;
    }
    
    const maxDisplayRules = 4;
    const displayedRules = selectedRules.slice(0, maxDisplayRules);
    const hiddenCount = selectedRules.length - maxDisplayRules;
    
    // Hiển thị các rule đầu tiên
    displayedRules.forEach(rule => {
        const ruleElement = document.createElement('div');
        ruleElement.className = 'selected-item';
        ruleElement.innerHTML = `
            <span>${rule.name}</span>
            <span class="remove-item" onclick="removeRule(${rule.id})">&times;</span>
            <input type="hidden" name="rules[]" value="${rule.id}">
        `;
        container.appendChild(ruleElement);
    });
    
    // Hiển thị badge "+X nội quy khác" nếu có nhiều hơn maxDisplayRules
    if (hiddenCount > 0) {
        const moreElement = document.createElement('div');
        moreElement.className = 'selected-item';
        moreElement.innerHTML = `+${hiddenCount} nội quy khác`;
        moreElement.onclick = () => showRulesModal();
        container.appendChild(moreElement);
    }
    
    // Thêm hidden inputs cho tất cả rules không hiển thị
    selectedRules.forEach(rule => {
        if (!displayedRules.includes(rule)) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'rules[]';
            hiddenInput.value = rule.id;
            container.appendChild(hiddenInput);
        }
    });
}

function removeAmenity(amenityId) {
    selectedAmenities = selectedAmenities.filter(a => a.id !== amenityId);
    updateSelectedAmenitiesDisplay();
    
    // Update modal display if open
    const modalItem = document.querySelector(`[data-amenity-id="${amenityId}"]`);
    if (modalItem) {
        modalItem.classList.remove('selected');
    }
}

function removeRule(ruleId) {
    selectedRules = selectedRules.filter(r => r.id !== ruleId);
    updateSelectedRulesDisplay();
    
    // Update modal display if open
    const modalItem = document.querySelector(`[data-rule-id="${ruleId}"]`);
    if (modalItem) {
        modalItem.classList.remove('selected');
    }
}

function loadAllAmenities() {
    const amenitySections = document.querySelector('.amenity-sections');
    amenitySections.innerHTML = '';
    
    if (!amenitiesData) {
        amenitySections.innerHTML = '<p>Đang tải dữ liệu tiện nghi...</p>';
        return;
    }
    
    // Tạo section cho mỗi category
    Object.keys(amenitiesData).forEach(categoryCode => {
        const categoryData = amenitiesData[categoryCode];
        const categoryInfo = categoryData.category_info;
        const amenities = categoryData.amenities;
        
        const sectionElement = document.createElement('div');
        sectionElement.className = 'amenity-section';
        
        sectionElement.innerHTML = `
            <h4 class="section-title">
                <i class="${categoryInfo.icon}"></i>${categoryInfo.name}
            </h4>
            <div class="amenities-grid">
                ${amenities.map(amenity => `
                    <div class="amenity-item ${selectedAmenities.some(a => a.id === amenity.id) ? 'selected' : ''}" 
                         data-amenity-id="${amenity.id}"
                         onclick="toggleAmenitySelection(${amenity.id}, '${amenity.name}', '${amenity.icon}')">
                        <i class="${amenity.icon}"></i>
                        <span class="amenity-text">${amenity.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        amenitySections.appendChild(sectionElement);
    });
}

function loadAllRules() {
    const rulesSections = document.querySelector('.rules-sections');
    rulesSections.innerHTML = '';
    
    if (!rulesData) {
        rulesSections.innerHTML = '<p>Đang tải dữ liệu nội quy...</p>';
        return;
    }
    
    Object.keys(rulesData).forEach(categoryCode => {
        const rules = rulesData[categoryCode];
        const categoryNames = {
            'smoking': 'Hút thuốc',
            'pets': 'Thú cưng', 
            'children': 'Trẻ em',
            'party': 'Tiệc tùng',
            'time': 'Thời gian',
            'behavior': 'Hành vi'
        };
        
        const sectionElement = document.createElement('div');
        sectionElement.className = 'rule-section';
        
        sectionElement.innerHTML = `
            <h4 class="section-title">
                <i class="fas fa-shield-alt"></i>${categoryNames[categoryCode] || categoryCode}
            </h4>
            <div class="rules-grid">
                ${rules.map(rule => `
                    <div class="rule-item ${selectedRules.some(r => r.id === rule.id) ? 'selected' : ''}" 
                         data-rule-id="${rule.id}"
                         onclick="toggleRuleSelection(${rule.id}, '${rule.name}')">
                        <span class="rule-text">${rule.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        rulesSections.appendChild(sectionElement);
    });
}

function toggleAmenitySelection(amenityId, amenityName, amenityIcon) {
    const item = document.querySelector(`[data-amenity-id="${amenityId}"]`);
    const isCurrentlySelected = item.classList.contains('selected');
    
    if (!isCurrentlySelected) {
        selectedAmenities.push({id: amenityId, name: amenityName, icon: amenityIcon});
        item.classList.add('selected');
    } else {
        selectedAmenities = selectedAmenities.filter(a => a.id !== amenityId);
        item.classList.remove('selected');
    }
    
    updateSelectedAmenitiesDisplay();
}

function toggleRuleSelection(ruleId, ruleName) {
    const item = document.querySelector(`[data-rule-id="${ruleId}"]`);
    const isCurrentlySelected = item.classList.contains('selected');
    
    if (!isCurrentlySelected) {
        selectedRules.push({id: ruleId, name: ruleName});
        item.classList.add('selected');
    } else {
        selectedRules = selectedRules.filter(r => r.id !== ruleId);
        item.classList.remove('selected');
    }
    
    updateSelectedRulesDisplay();
}

function deleteRoom() {
    if (confirm('Bạn có chắc chắn muốn xóa phòng này? Hành động này không thể hoàn tác.')) {
        window.location.href = "{{ url_for('owner.delete_room', room_id=room.id) }}";
    }
}

// Form submission handling
document.getElementById('edit-room-form').addEventListener('submit', function(e) {
    // Convert formatted prices back to numbers for backend
    const hourlyPriceInput = document.querySelector('input[name="hourly_price"]');
    const nightlyPriceInput = document.querySelector('input[name="nightly_price"]');
    
    if (hourlyPriceInput && hourlyPriceInput.value) {
        // Remove formatting and convert to number
        const rawValue = hourlyPriceInput.value.replace(/[.,]/g, '');
        hourlyPriceInput.value = rawValue;
    }
    
    if (nightlyPriceInput && nightlyPriceInput.value) {
        // Remove formatting and convert to number
        const rawValue = nightlyPriceInput.value.replace(/[.,]/g, '');
        nightlyPriceInput.value = rawValue;
    }
    
    // Add selected rental type to form
    const rentalTypeInput = document.createElement('input');
    rentalTypeInput.type = 'hidden';
    rentalTypeInput.name = 'selected_rental_type';
    rentalTypeInput.value = document.querySelector('input[name="rental_type"]:checked')?.value || 'nightly';
    this.appendChild(rentalTypeInput);
});

// Simple main image upload handler
function setupMainImageUpload() {
    const mainInput = document.getElementById('main-image-input');
    if (mainInput) {
        // Remove any existing event listeners first
        mainInput.removeEventListener('change', handleMainImageChange);
        
        // Add the change event listener
        mainInput.addEventListener('change', handleMainImageChange);
        
        } else {
        console.error('🔧 Main image input not found!');
    }
}

function handleMainImageChange(event) {
    if (event.target.files && event.target.files[0]) {
        previewImage(event.target);
    }
}

// Simple test preview function
function testPreview(input) {
    const uploadItem = input.closest('.upload-item');
    const placeholder = uploadItem.querySelector('.upload-placeholder');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Simple approach - just create and insert image
            const img = document.createElement('img');
            img.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 5;
                border-radius: 8px;
            `;
            
            img.src = e.target.result;
            // Hide placeholder
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // Add image to upload item
            uploadItem.appendChild(img);
            
            };
        reader.readAsDataURL(input.files[0]);
    }
}

// Setup add more images functionality
function setupAddMoreImages() {
    const addMoreItem = document.querySelector('.upload-item.add-more');
    if (addMoreItem) {
        const placeholder = addMoreItem.querySelector('.upload-placeholder');
        if (placeholder) {
            placeholder.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Create temporary file input
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.multiple = true;
                tempInput.style.display = 'none';
                
                tempInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        Array.from(this.files).forEach((file) => {
                            addImageToUploadGrid(file);
                        });
                    }
                    tempInput.remove();
                });
                
                document.body.appendChild(tempInput);
                tempInput.click();
            });
            }
    } else {
        console.error('🔧 Add more images button not found!');
    }
}

// Setup upload functionality for images
function setupUploadFunctionality() {
    const uploadItems = document.querySelectorAll('.upload-item');
    uploadItems.forEach((item, index) => {
        const placeholder = item.querySelector('.upload-placeholder');
        const fileInput = item.querySelector('input[type="file"]');
        const isAddMore = item.classList.contains('add-more');
        
        if (isAddMore) {
            // Handle "Thêm ảnh" button - create new file input
            placeholder.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Create temporary file input
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.multiple = true;
                tempInput.style.display = 'none';
                
                tempInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        // Add files to upload grid
                        Array.from(this.files).forEach((file, index) => {
                            addImageToUploadGrid(file);
                        });
                    }
                    // Remove temporary input
                    tempInput.remove();
                });
                
                document.body.appendChild(tempInput);
                tempInput.click();
            });
        } else if (fileInput && placeholder) {
            // Handle regular upload items (like main image)
            // Add click event to placeholder
            placeholder.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            // Add click event to the whole upload item as backup
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            // Handle file selection for regular upload items
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    previewImage(this);
                }
            });
        } else {
            }
    });
}

// Add image to upload grid
function addImageToUploadGrid(file) {
    const uploadGrid = document.querySelector('.upload-grid');
    const addMoreButton = uploadGrid.querySelector('.add-more');
    
    if (!uploadGrid || !addMoreButton) {
        console.error('🔧 Upload grid or add more button not found');
        return;
    }
    
    // Create new upload item
    const newUploadItem = document.createElement('div');
    newUploadItem.className = 'upload-item';
    
    // Create file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = 'images[]';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    
    // Create placeholder (initially hidden since we'll show preview)
    const placeholder = document.createElement('div');
    placeholder.className = 'upload-placeholder';
    placeholder.innerHTML = '<i class="bi bi-camera"></i>';
    placeholder.style.display = 'none';
    
    // Add elements to upload item
    newUploadItem.appendChild(fileInput);
    newUploadItem.appendChild(placeholder);
    
    // Insert before "add-more" button
    uploadGrid.insertBefore(newUploadItem, addMoreButton);
    
    // Set the file to the input
    try {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        } catch (error) {
        console.error('🔧 Error setting file to input:', error);
    }
    
    // Show preview directly
    showFilePreview(file, newUploadItem);
}

// Show file preview for new images
function showFilePreview(file, uploadItem) {
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Create preview image
            const img = document.createElement('img');
            img.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 5;
                border-radius: 8px;
            `;
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '×';
            removeBtn.type = 'button';
            removeBtn.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 20px;
                height: 20px;
                border: none;
                background: rgba(220, 53, 69, 0.8);
                color: white;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
                z-index: 15;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Remove the entire upload item
                uploadItem.remove();
            });
            
            // Set image source and add to DOM
            img.src = e.target.result;
            uploadItem.appendChild(img);
            uploadItem.appendChild(removeBtn);
            
            };
        
        reader.onerror = function(error) {
            console.error('🔧 FileReader error:', error);
        };
        
        reader.readAsDataURL(file);
    }
}

// Function to remove existing image - removed duplicate
</script>
{% endblock %}
